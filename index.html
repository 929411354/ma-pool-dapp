<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8"/>
<title>Mining Pro (No History 修复版)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
:root{
  --bg:#0f172a;
  --card:#1e293b80;
  --glass:backdrop-filter:blur(8px);
  --primary:#3b82f6;
  --success:#22c55e;
  --error:#f87171;
  --text:#e2e8f0;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:var(--text);display:flex;justify-content:center;padding:20px}
.container{max-width:480px;width:100%}
h2{text-align:center;background:linear-gradient(90deg,#60a5fa,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:20px 0;font-size:26px}
.card{background:var(--card);border-radius:var(--radius);padding:20px;margin-bottom:20px;border:1px solid #334155;backdrop-filter:blur(8px)}
h3{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:18px}
.btn{display:flex;align-items:center;gap:8px;width:100%;padding:14px;border:none;border-radius:var(--radius);font-size:16px;font-weight:600;cursor:pointer;transition:.3s}
.btn.primary{background:linear-gradient(90deg,#3b82f6,#2563eb);color:#fff}
.btn.success{background:linear-gradient(90deg,#22c55e,#16a34a);color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
input[type=number],input[type=text]{width:100%;padding:12px;border-radius:var(--radius);border:1px solid #334155;background:#111;color:#fff;margin:6px 0}
.tab{display:flex;border-bottom:1px solid #334155;margin-bottom:12px}
.tab button{flex:1;padding:12px;border:none;background:transparent;color:#93c5fd;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
.tab button.active{background:#334155;color:#fff;border-radius:var(--radius) var(--radius) 0 0}
.tab-content{display:none}
.tab-content.active{display:block}
.loading{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">
  <h2 id="title">Mining Pro</h2>

  <!-- 标签栏 -->
  <div class="tab">
    <button class="tab-btn active" data-tab="dashboard">仪表盘</button>
    <button class="tab-btn" data-tab="buy">购买</button>
    <button class="tab-btn" data-tab="claim">领取</button>
    <button class="tab-btn" data-tab="refer">推荐</button>
    <button class="tab-btn" data-tab="admin" id="adminTabBtn" style="display:none">管理</button>
  </div>

  <!-- 仪表盘 -->
  <div id="dashboard" class="tab-content active">
    <div class="card">
      <h3>仪表盘</h3>
      <p>基础矿机：<strong id="basicCount">-</strong></p>
      <p>高级矿机：<strong id="testCount">-</strong></p>
      <p>待领奖励：<strong id="pendingReward">- α</strong></p>
      <p>推荐奖励：<strong id="referralReward">- α</strong></p>
      <button class="btn primary" onclick="refresh()">刷新</button>
    </div>
  </div>

  <!-- 购买矿机 -->
  <div id="buy" class="tab-content">
    <div class="card">
      <h3>购买矿机</h3>
      <button class="btn primary" onclick="buyBasic()">基础矿机 (0.01 BNB)</button>
      <input type="number" id="advancedCount" placeholder="数量" min="1" max="100" value="1">
      <button class="btn primary" onclick="buyAdvanced()">高级矿机 (100 α/台)</button>
    </div>
  </div>

  <!-- 领取奖励 -->
  <div id="claim" class="tab-content">
    <div class="card">
      <h3>领取奖励</h3>
      <button class="btn success" onclick="claimRewards()">领取所有奖励</button>
    </div>
  </div>

  <!-- 推荐人 -->
  <div id="refer" class="tab-content">
    <div class="card">
      <h3>推荐人</h3>
      <input type="text" id="referralAddress" placeholder="推荐人地址">
      <button class="btn primary" onclick="setReferrer()">设置推荐人</button>
    </div>
  </div>

  <!-- 管理员 -->
  <div id="admin" class="tab-content">
    <div class="card">
      <h3>管理员</h3>
      <button class="btn success" onclick="withdrawBNB()">提取 BNB</button>
      <input type="number" id="withdrawAmount" placeholder="数量 α">
      <button class="btn success" onclick="withdrawTokens()">提取代币</button>
    </div>
  </div>

  <!-- 日志 -->
  <div class="card">
    <h3>操作日志</h3>
    <div class="log" id="log"></div>
  </div>

  <button id="connectBtn" class="btn primary">连接钱包</button>
</div>

<!-- ===== 修复 1：内联 ethers.js ===== -->
<script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>

<script>
/* ===== 修复 2：合约信息 ===== */
const ABI = [{"inputs":[],"name":"INITIAL_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"additionalMachinePriceToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"buyAdditionalMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"userAddress","type":"address"}],"name":"calculateRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"setReferrer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userInfo","outputs":[{"internalType":"uint256","name":"normalMachineCount","type":"uint256"},{"internalType":"uint256","name":"testMachineCount","type":"uint256"}],"stateMutability":"view","type":"function"}];

const ADDRESS = "0xf2F65d4f0F5A83a3d12e6b63635426D7aF89b8d0";
const CHAIN_ID = "0x38"; // BSC

let provider, signer, contract, userAddress;

/* ===== 修复 3：日志 ===== */
function log(msg, type = "info") {
  const div = document.createElement("div");
  div.className = type;
  div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  document.getElementById("log").appendChild(div);
  document.getElementById("log").scrollTop = 1e9;
}

/* ===== 修复 4：标签切换 ===== */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.onclick = () => {
      const target = btn.dataset.tab;
      document.querySelectorAll(".tab-content").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.getElementById(target).classList.add("active");
      btn.classList.add("active");
    };
  });
});

/* ===== 修复 5：钱包连接 ===== */
document.getElementById("connectBtn").addEventListener("click", async () => {
  if (!window.ethereum) return log("请先安装 MetaMask", "error");
  try {
    await window.ethereum.request({ method: "eth_requestAccounts" });
    if (await window.ethereum.request({ method: "eth_chainId" }) !== CHAIN_ID)
      return log("请切换到 BSC 主网", "error");
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    contract = new ethers.Contract(ADDRESS, ABI, signer);
    userAddress = await signer.getAddress();
    document.getElementById("connectBtn").innerText =
      `✅ ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
    log("钱包已连接", "success");
    await refresh();
    const owner = await contract.owner();
    if (owner.toLowerCase() === userAddress.toLowerCase())
      document.getElementById("adminBtn").style.display = "flex";
  } catch (e) {
    log("连接失败：" + e.message, "error");
  }
});

/* ===== 修复 6：功能函数 ===== */
async function refresh() {
  if (!contract) return log("请先连接钱包", "error");
  try {
    const user = await contract.userInfo(userAddress);
    const reward = await contract.calculateRewards(userAddress);
    const ref = await contract.getUserReferralRewards(userAddress);
    document.getElementById("basicCount").textContent = user.normalMachineCount.toString();
    document.getElementById("testCount").textContent = user.testMachineCount.toString();
    document.getElementById("pendingReward").textContent = ethers.utils.formatEther(reward) + " α";
    document.getElementById("referralReward").textContent = ethers.utils.formatEther(ref) + " α";
  } catch (e) {
    log("刷新失败：" + e.message, "error");
  }
}
async function buyBasic() {
  if (!contract) return log("请先连接钱包", "error");
  try {
    const tx = await contract.buyInitialMachine({ value: ethers.utils.parseEther("0.01") });
    await tx.wait();
    log("基础矿机购买成功", "success");
    refresh();
  } catch (e) {
    log("购买失败：" + e.message, "error");
  }
}
async function buyAdvanced() {
  if (!contract) return log("请先连接钱包", "error");
  const cnt = parseInt(document.getElementById("advancedCount").value);
  if (!cnt || cnt < 1 || cnt > 100) return log("数量 1-100", "error");
  try {
    const tx = await contract.buyAdditionalMachine(cnt);
    await tx.wait();
    log(`高级矿机×${cnt} 购买成功`, "success");
    refresh();
  } catch (e) {
    log("购买失败：" + e.message, "error");
  }
}
async function claimRewards() {
  if (!contract) return log("请先连接钱包", "error");
  try {
    const tx = await contract.claimRewards();
    await tx.wait();
    log("奖励领取成功", "success");
    refresh();
  } catch (e) {
    log("领取失败：" + e.message, "error");
  }
}
async function setReferrer() {
  const ref = document.getElementById("referralAddress").value;
  if (!ethers.utils.isAddress(ref)) return log("地址格式错误", "error");
  if (!contract) return log("请先连接钱包", "error");
  try {
    const tx = await contract.setReferrer(ref);
    await tx.wait();
    log("推荐人设置成功", "success");
  } catch (e) {
    log("设置失败：" + e.message, "error");
  }
}
async function withdrawBNB() {
  if (!contract) return log("请先连接钱包", "error");
  try {
    const tx = await contract.withdrawBNB();
    await tx.wait();
    log("BNB 提取成功", "success");
  } catch (e) {
    log("提取失败：" + e.message, "error");
  }
}
async function withdrawTokens() {
  const amt = document.getElementById("withdrawAmount").value;
  if (!amt || isNaN(amt)) return log("请输入有效数量", "error");
  if (!contract) return log("请先连接钱包", "error");
  try {
    const tx = await contract.withdrawTokens(ethers.utils.parseEther(amt));
    await tx.wait();
    log("代币提取成功", "success");
  } catch (e) {
    log("提取失败：" + e.message, "error");
  }
}

log("等待连接钱包...");
</script>
</body>
</html>