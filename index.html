<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>â­ æ˜Ÿé“¾å·¥åŠ DApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš€</text></svg>"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500&display=swap');
    :root{--bg:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);--card-bg:rgba(30,41,59,.7);--accent:#3b82f6;--text:#e2e8f0;--radius:16px;--shadow:0 8px 32px rgba(0,0,0,.5)}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Noto Sans SC',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;font-size:14px}
    .container{max-width:900px;width:100%;display:grid;gap:20px}
    .header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
    .header h1{font-size:1.3rem;background:linear-gradient(90deg,#60a5fa,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .nav{display:flex;gap:6px}
    .nav button{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:6px 10px;border-radius:var(--radius);cursor:pointer;font-size:0.8rem;font-weight:500}
    .nav button.active{background:var(--accent);color:#fff}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:20px;border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(8px);box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
    .stat{display:flex;align-items:center;gap:10px;font-size:1rem;font-weight:500}
    .stat i{color:var(--accent)}
    .btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 16px;border:none;border-radius:var(--radius);font-weight:600;cursor:pointer;transition:.3s;background:var(--accent);color:#fff;font-size:0.8rem}
    .btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(59,130,246,.5)}
    .input-group{display:flex;flex-direction:column;gap:6px}
    .input-group input{padding:8px;border-radius:var(--radius);border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:#fff;font-weight:400}
    .hidden{display:none}
    #langBtn{margin-left:10px;font-size:0.8rem;padding:4px 8px}
    #connectBtn{font-size:0.8rem;padding:6px 10px}
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <div style="display:flex;align-items:center">
        <h1><i class="fas fa-rocket"></i> <span id="titleTxt">æ˜Ÿé“¾å·¥åŠ</span></h1>
        <button id="langBtn" class="btn" onclick="toggleLang()">EN</button>
      </div>
      <div class="nav">
        <button class="btn active" onclick="showView('dashboard')"><i class="fas fa-chart-line fa-sm"></i> <span id="dashboardTxt">ä»ªè¡¨ç›˜</span></button>
        <button class="btn" onclick="showView('forge')"><i class="fas fa-hammer fa-sm"></i> <span id="forgeTxt">æ˜Ÿæ ¸å·¥åŠ</span></button>
      </div>
      <button id="connectBtn" class="btn" onclick="connectWallet()"><i class="fas fa-wallet fa-sm"></i> <span id="connectTxt">è¿æ¥é’±åŒ…</span></button>
    </div>

    <!-- ä»ªè¡¨ç›˜ -->
    <div id="dashboardView" class="card grid">
      <div class="stat"><i class="fas fa-user"></i> <span id="walletAddr">--</span></div>
      <div class="stat"><i class="fas fa-cog"></i> <span id="normalTxt">æ™®é€šæ˜Ÿæ ¸</span>: <span id="statNormal">0</span></div>
      <div class="stat"><i class="fas fa-rocket"></i> <span id="powerTxt">å¢å¼ºæ˜Ÿæ ¸</span>: <span id="statPower">0</span></div>
      <div class="stat"><i class="fas fa-calendar"></i> <span id="dailyTxt">æ—¥äº§é‡</span>: <span id="statDaily">0.00</span> Î±</div>
      <div class="stat"><i class="fas fa-gift"></i> <span id="unclaimedTxt">æœªé¢†å–</span>: <span id="statUnclaimed">0.00</span> Î±</div>
      <div class="input-group">
        <label><span id="referLabelTxt">æ¨èäººåœ°å€</span></label>
        <input id="referrerInput" placeholder="0x..."/>
        <button class="btn" onclick="setReferrer()"><i class="fas fa-check"></i> <span id="setReferTxt">è®¾ç½®æ¨èäºº</span></button>
      </div>
      <button class="btn" onclick="claimRewards()"><i class="fas fa-gift"></i> <span id="claimTxt">é¢†å–æ”¶ç›Š</span></button>
    </div>

    <!-- æ˜Ÿæ ¸å·¥åŠ -->
    <div id="forgeView" class="card hidden">
      <h2><i class="fas fa-hammer"></i> <span id="forgeTitleTxt">æ˜Ÿæ ¸å·¥åŠ</span></h2>
      <div class="grid">
        <button class="btn" onclick="buyInitialMachine()"><i class="fas fa-plus"></i> <span id="buyInitialTxt">è´­ä¹°æ™®é€šæ˜Ÿæ ¸ (0.01 BNB)</span></button>
        <button class="btn" onclick="buyLevel(0)"><i class="fas fa-star"></i> <span id="tier0Txt">å¢å¼ºç­‰çº§ 0</span></button>
        <button class="btn" onclick="buyLevel(1)"><i class="fas fa-star"></i> <span id="tier1Txt">å¢å¼ºç­‰çº§ 1</span></button>
        <button class="btn" onclick="buyLevel(2)"><i class="fas fa-star"></i> <span id="tier2Txt">å¢å¼ºç­‰çº§ 2</span></button>
        <button class="btn" onclick="buyLevel(3)"><i class="fas fa-star"></i> <span id="tier3Txt">å¢å¼ºç­‰çº§ 3</span></button>
      </div>
    </div>

    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div id="adminPanel" class="card hidden" style="display:none">
      <h2><i class="fas fa-cogs"></i> <span id="adminTitleTxt">æ˜Ÿæ ¸å·¥åŠï¼ˆç®¡ç†å‘˜ï¼‰</span></h2>
      <button class="btn" onclick="buyAdminTestMachine()"><i class="fas fa-flask"></i> <span id="adminTestTxt">è´­ä¹°è¿·ä½ æ˜Ÿæ ¸ (0.0001 BNB)</span></button>
      <div class="input-group">
        <label><span id="addAdminTxt">ç®¡ç†å‘˜åœ°å€</span></label>
        <input id="addAdminInput" placeholder="0x..."/>
        <button class="btn" onclick="addAdmin()"><i class="fas fa-user-plus"></i> <span id="addBtnTxt">æ·»åŠ ç®¡ç†å‘˜</span></button>
        <button class="btn" onclick="removeAdmin()"><i class="fas fa-user-minus"></i> <span id="removeBtnTxt">ç§»é™¤ç®¡ç†å‘˜</span></button>
      </div>
      <div class="input-group">
        <label><span id="withdrawTxt">æå–ä»£å¸æ•°é‡</span></label>
        <input id="withdrawAmount" placeholder="100"/>
        <button class="btn" onclick="withdrawBNB()"><i class="fas fa-coins"></i> <span id="withdrawBNBTxt">æå–BNB</span></button>
        <button class="btn" onclick="withdrawTokens()"><i class="fas fa-coins"></i> <span id="withdrawTokensTxt">æå–ä»£å¸</span></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0x9dCcEd4Ef738856D2c289D4116cD219c698B22ba";
    const TOKEN_ADDRESS = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";

    const CONTRACT_ABI = [
      "function buyInitialMachine() payable",
      "function buyTestMachine() payable",
      "function buyPowerMachine(uint256,uint256)",
      "function setReferrer(address)",
      "function claimRewards()",
      "function addAdmin(address)",
      "function removeAdmin(address)",
      "function withdrawBNB()",
      "function withdrawTokens(uint256)",
      "function admin(address) view returns(bool)",
      "function getUserDashboard(address) view returns(uint256,uint256,uint256[4],uint256,uint256,uint256,uint256)"
    ];

    let provider, signer, contract, userAddress;
    const lang = {
      zh: {
        title: "æ˜Ÿé“¾å·¥åŠ", connect: "è¿æ¥é’±åŒ…", dashboard: "ä»ªè¡¨ç›˜", forge: "æ˜Ÿæ ¸å·¥åŠ",
        balance: "ä½™é¢ä¸è¶³", success: "æˆåŠŸ", fail: "å¤±è´¥",
        normal: "æ™®é€šæ˜Ÿæ ¸", power: "å¢å¼ºæ˜Ÿæ ¸", daily: "æ—¥äº§é‡", unclaimed: "æœªé¢†å–",
        buyInitial: "è´­ä¹°æ™®é€šæ˜Ÿæ ¸ (0.01 BNB)", tier0: "å¢å¼ºç­‰çº§ 0", tier1: "å¢å¼ºç­‰çº§ 1", tier2: "å¢å¼ºç­‰çº§ 2", tier3: "å¢å¼ºç­‰çº§ 3",
        refer: "æ¨èäººåœ°å€", setRefer: "è®¾ç½®æ¨èäºº", claim: "é¢†å–æ”¶ç›Š",
        adminTitle: "æ˜Ÿæ ¸å·¥åŠï¼ˆç®¡ç†å‘˜ï¼‰", adminTest: "è´­ä¹°è¿·ä½ æ˜Ÿæ ¸ (0.0001 BNB)",
        addAdmin: "ç®¡ç†å‘˜åœ°å€", addBtn: "æ·»åŠ ç®¡ç†å‘˜", removeBtn: "ç§»é™¤ç®¡ç†å‘˜",
        withdraw: "æå–ä»£å¸æ•°é‡", withdrawBNB: "æå–BNB", withdrawTokens: "æå–ä»£å¸",
        referLabelTxt: "æ¨èäººåœ°å€", forgeTitleTxt: "æ˜Ÿæ ¸å·¥åŠ"
      },
      en: {
        title: "StarForge", connect: "Connect Wallet", dashboard: "Dashboard", forge: "Forge",
        balance: "Insufficient balance", success: "Success", fail: "Failed",
        normal: "Normal Core", power: "Power Core", daily: "Daily Yield", unclaimed: "Unclaimed",
        buyInitial: "Buy Normal Core (0.01 BNB)", tier0: "Tier 0", tier1: "Tier 1", tier2: "Tier 2", tier3: "Tier 3",
        refer: "Referrer Address", setRefer: "Set Referrer", claim: "Claim Rewards",
        adminTitle: "StarForge (Admin)", adminTest: "Buy Mini Core (0.0001 BNB)",
        addAdmin: "Admin Address", addBtn: "Add Admin", removeBtn: "Remove Admin",
        withdraw: "Withdraw Amount", withdrawBNB: "Withdraw BNB", withdrawTokens: "Withdraw Tokens",
        referLabelTxt: "Referrer Address", forgeTitleTxt: "StarForge"
      }
    };
    let currentLang = "zh";
    
    function t(k) { 
      return lang[currentLang][k] || k; 
    }
    
    function toggleLang() { 
      currentLang = currentLang === "zh" ? "en" : "zh"; 
      applyLang(); 
    }
    
    function applyLang() {
      document.getElementById("langBtn").textContent = currentLang === "zh" ? "EN" : "ä¸­";
      
      // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å…ƒç´ 
      const elements = [
        "titleTxt", "connectTxt", "dashboardTxt", "forgeTxt", "normalTxt", "powerTxt",
        "dailyTxt", "unclaimedTxt", "buyInitialTxt", "referLabelTxt", "setReferTxt",
        "claimTxt", "adminTitleTxt", "adminTestTxt", "addAdminTxt", "addBtnTxt",
        "removeBtnTxt", "withdrawTxt", "withdrawBNBTxt", "withdrawTokensTxt",
        "tier0Txt", "tier1Txt", "tier2Txt", "tier3Txt", "forgeTitleTxt"
      ];
      
      elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = t(id.replace("Txt", ""));
      });
    }

    function showView(view) {
      document.getElementById("dashboardView").classList.toggle("hidden", view !== "dashboard");
      document.getElementById("forgeView").classList.toggle("hidden", view !== "forge");
      document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
      document.querySelector(`[onclick="showView('${view}')"]`).classList.add("active");
    }

    async function connectWallet() {
      try {
        const prov = window.ethereum;
        if (!prov) {
          alert("è¯·å®‰è£…MetaMaskæˆ–å…¶ä»–Web3é’±åŒ…");
          return;
        }

        await prov.request({ method: "eth_requestAccounts" });
        const chainId = await prov.request({ method: "eth_chainId" });
        
        if (chainId !== "0x38") {
          try {
            await prov.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: "0x38" }]
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              await prov.request({
                method: "wallet_addEthereumChain",
                params: [{
                  chainId: "0x38",
                  chainName: "Binance Smart Chain",
                  nativeCurrency: {
                    name: "BNB",
                    symbol: "BNB",
                    decimals: 18
                  },
                  rpcUrls: ["https://bsc-dataseed.binance.org/"],
                  blockExplorerUrls: ["https://bscscan.com/"]
                }]
              });
            }
          }
        }

        provider = new ethers.providers.Web3Provider(prov);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        document.getElementById("walletAddr").textContent = 
          userAddress.substring(0, 6) + "..." + userAddress.substring(38);
        document.getElementById("connectBtn").innerHTML = 
          `<i class="fas fa-wallet fa-sm"></i> ${userAddress.substring(0, 6)}...`;

        // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
        const isAdmin = await contract.admin(userAddress);
        if (isAdmin) {
          document.getElementById("adminPanel").style.display = "block";
        }

        await loadData();
      } catch (error) {
        console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
        alert("è¿æ¥é’±åŒ…å¤±è´¥: " + (error.message || "æœªçŸ¥é”™è¯¯"));
      }
    }

    async function loadData() {
      if (!contract) return;
      try {
        const data = await contract.getUserDashboard(userAddress);
        document.getElementById("statNormal").textContent = data[0].toString();
        document.getElementById("statPower").textContent = 
          data[1] ? data[1].reduce((a, b) => a + Number(b), 0) : 0;
        document.getElementById("statDaily").textContent = 
          parseFloat(ethers.utils.formatEther(data[4])).toFixed(2);
        document.getElementById("statUnclaimed").textContent = 
          parseFloat(ethers.utils.formatEther(data[5])).toFixed(2);
      } catch (error) {
        console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
      }
    }

    async function buyInitialMachine() {
      try {
        if (!contract) return alert(t("connect"));
        const balance = await provider.getBalance(userAddress);
        if (balance.lt(ethers.utils.parseEther("0.01"))) return alert(t("balance"));
        
        const tx = await contract.buyInitialMachine({ 
          value: ethers.utils.parseEther("0.01") 
        });
        await tx.wait();
        alert(t("success") + ": " + t("buyInitial"));
        await loadData();
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function buyAdminTestMachine() {
      try {
        if (!contract) return alert(t("connect"));
        const balance = await provider.getBalance(userAddress);
        if (balance.lt(ethers.utils.parseEther("0.0001"))) return alert(t("balance"));
        
        const tx = await contract.buyTestMachine({ 
          value: ethers.utils.parseEther("0.0001") 
        });
        await tx.wait();
        alert(t("success") + ": " + t("adminTest"));
        await loadData();
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function buyLevel(level) {
      try {
        if (!contract) return alert(t("connect"));
        const tx = await contract.buyPowerMachine(level, 1);
        await tx.wait();
        alert(`${t("success")}: ${t("tier" + level)}`);
        await loadData();
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function setReferrer() {
      try {
        const ref = document.getElementById("referrerInput").value;
        if (!contract) return alert(t("connect"));
        if (!ethers.utils.isAddress(ref)) return alert("åœ°å€æ ¼å¼é”™è¯¯");
        
        const tx = await contract.setReferrer(ref);
        await tx.wait();
        alert(t("success") + ": " + t("setRefer"));
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function claimRewards() {
      try {
        if (!contract) return alert(t("connect"));
        const tx = await contract.claimRewards();
        await tx.wait();
        alert(t("success") + ": " + t("claim"));
        await loadData();
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function addAdmin() {
      try {
        const addr = document.getElementById("addAdminInput").value;
        if (!contract) return alert(t("connect"));
        if (!ethers.utils.isAddress(addr)) return alert("åœ°å€æ ¼å¼é”™è¯¯");
        
        const tx = await contract.addAdmin(addr);
        await tx.wait();
        alert(t("success") + ": " + t("addBtn"));
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function removeAdmin() {
      try {
        const addr = document.getElementById("addAdminInput").value;
        if (!contract) return alert(t("connect"));
        if (!ethers.utils.isAddress(addr)) return alert("åœ°å€æ ¼å¼é”™è¯¯");
        
        const tx = await contract.removeAdmin(addr);
        await tx.wait();
        alert(t("success") + ": " + t("removeBtn"));
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function withdrawBNB() {
      try {
        if (!contract) return alert(t("connect"));
        const tx = await contract.withdrawBNB();
        await tx.wait();
        alert(t("success") + ": " + t("withdrawBNB"));
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    async function withdrawTokens() {
      try {
        const amt = document.getElementById("withdrawAmount").value;
        if (!contract) return alert(t("connect"));
        if (!amt) return alert("è¯·è¾“å…¥æ•°é‡");
        
        const tx = await contract.withdrawTokens(ethers.utils.parseUnits(amt));
        await tx.wait();
        alert(t("success") + ": " + t("withdrawTokens"));
      } catch (error) {
        alert(t("fail") + ": " + error.message);
      }
    }

    // åˆå§‹åŒ–
    showView("dashboard");
    applyLang();
  </script>
</body>
</html>