<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Mining Contract Interface</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 0 20px #00ff9922;
        }
        button {
            background: #00ff99;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #00cc88;
        }
        input, select {
            background: #2a2a2a;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
        }
        .wallet-address {
            font-weight: bold;
            color: #00ff99;
        }
        .section-title {
            color: #00ff99;
            border-bottom: 2px solid #00ff99;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .stat-card {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        .loading {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color:#00ff99;">üöÄ Advanced Mining Contract</h1>
        
        <div id="walletSection" class="card">
            <h2 class="section-title">Wallet Connection</h2>
            <p>Connected as: <span class="wallet-address" id="walletAddress">Not connected</span></p>
            <button onclick="connectWallet()">Connect MetaMask</button>
        </div>

        <div id="dashboard" class="card">
            <h2 class="section-title">üìä Global Dashboard</h2>
            <div id="globalStats" class="loading">Loading global stats...</div>
        </div>

        <div id="userDashboard" class="card">
            <h2 class="section-title">üë§ Your Dashboard</h2>
            <div id="userStats" class="loading">Loading your stats...</div>
        </div>

        <div class="card">
            <h2 class="section-title">‚õèÔ∏è Mining Operations</h2>
            
            <h3>Initial Machine</h3>
            <div>
                <button onclick="buyInitialMachine()">Buy Initial Machine (BNB)</button>
                <p class="loading" id="initialPrice">Loading price...</p>
            </div>

            <h3>Test Machine</h3>
            <div>
                <button onclick="buyTestMachine()">Buy Test Machine (BNB)</button>
                <p class="loading" id="testPrice">Loading price...</p>
            </div>

            <h3>Power Machines</h3>
            <div>
                <label>Machine Tier: 
                    <select id="tierId">
                        <option value="0">Tier 1</option>
                        <option value="1">Tier 2</option>
                        <option value="2">Tier 3</option>
                        <option value="3">Tier 4</option>
                    </select>
                </label>
                <label>Quantity: <input type="number" id="count" min="1" max="10" value="1"></label>
                <button onclick="buyPowerMachine()">Buy Power Machine</button>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">üí∞ Rewards</h2>
            <button onclick="claimRewards()">Claim Rewards</button>
            <p class="loading" id="unclaimedRewards">Loading unclaimed rewards...</p>
        </div>

        <div class="card">
            <h2 class="section-title">üîó Referrals</h2>
            <label>Set Referrer: <input type="text" id="referrerAddress" placeholder="Enter referrer address"></label>
            <button onclick="setReferrer()">Set Referrer</button>
            <p class="loading" id="referralStats">Loading referral stats...</p>
        </div>

        <div class="card" id="adminPanel" style="display:none;">
            <h2 class="section-title">üîê Admin Functions</h2>
            <button onclick="addAdmin()">Add Admin</button>
            <button onclick="removeAdmin()">Remove Admin</button>
            <button onclick="addToBlocklist()">Add to Blocklist</button>
            <button onclick="removeFromBlocklist()">Remove from Blocklist</button>
            <button onclick="withdrawTokens()">Withdraw Tokens</button>
            <button onclick="withdrawBNB()">Withdraw BNB</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const contractAddress = "0x9dCcEd4Ef738856D2c289D4116cD219c698B22ba";
        const tokenAddress = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";

        const abi = [/* ÂÖ®ÈÉ®ABIÂÜÖÂÆπ */];

        let provider, signer, contract, tokenContract;
        let userAddress;

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert("Please install MetaMask!");
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                contract = new ethers.Contract(contractAddress, abi, signer);
                tokenContract = new ethers.Contract(tokenAddress, [
                    "function approve(address spender, uint256 amount) public returns (bool)",
                    "function balanceOf(address account) public view returns (uint256)",
                    "function allowance(address owner, address spender) public view returns (uint256)"
                ], signer);

                document.getElementById("walletAddress").textContent = userAddress;
                document.getElementById("walletAddress").title = userAddress;
                loadUserDashboard();
                loadGlobalDashboard();
                loadPrices();
                checkAdminStatus();
            } catch (e) {
                console.error(e);
                alert("Failed to connect wallet");
            }
        }

        async function loadGlobalDashboard() {
            try {
                const data = await contract.getGlobalDashboard();
                const stats = document.getElementById("globalStats");
                stats.innerHTML = `
                    <div class="stat-card"><strong>Base Reward:</strong> <LaTex>${ethers.utils.formatEther(data.baseReward)} BNB</div>[ty-n]                    <div class="stat-card"><strong>Total Machines:</strong> $</LaTex>{data.totalMines}</div>
                    <div class="stat-card"><strong>Current Block:</strong> <LaTex>${data.currentBlock}</div>[ty-n]                    <div class="stat-card"><strong>Pool Balance:</strong> $</LaTex>{ethers.utils.formatEther(data.poolBalance)} BNB</div>
                    <div class="stat-card"><strong>Network Power:</strong> <LaTex>${data.networkPower}</div>[ty-n]                    <div class="stat-card"><strong>Daily Production:</strong> $</LaTex>{ethers.utils.formatEther(data.dailyProduction)} BNB</div>
                    <div class="stat-card"><strong>Total Referral Rewards:</strong> <LaTex>${ethers.utils.formatEther(data.totalRefRewards)} BNB</div>[ty-n]                `;[ty-n]            } catch (e) {[ty-n]                console.error(e);[ty-n]                document.getElementById("globalStats").innerHTML = "Error loading global stats";[ty-n]            }[ty-n]        }[ty-n][ty-n]        async function loadUserDashboard() {[ty-n]            try {[ty-n]                const data = await contract.getUserDashboard(userAddress);[ty-n]                const stats = document.getElementById("userStats");[ty-n]                stats.innerHTML = `[ty-n]                    <div class="stat-card"><strong>Normal Machines:</strong> $</LaTex>{data.normal}</div>
                    <div class="stat-card"><strong>Test Machines:</strong> <LaTex>${data.test}</div>[ty-n]                    <div class="stat-card"><strong>Power Machines:</strong> $</LaTex>{data.power.join(', ')}</div>
                    <div class="stat-card"><strong>Daily Reward:</strong> <LaTex>${ethers.utils.formatEther(data.dailyReward)} BNB</div>[ty-n]                    <div class="stat-card"><strong>Unclaimed Rewards:</strong> $</LaTex>{ethers.utils.formatEther(data.unclaimed)} BNB</div>
                    <div class="stat-card"><strong>Total Referral Rewards:</strong> <LaTex>${ethers.utils.formatEther(data.totalRefReward)} BNB</div>[ty-n]                    <div class="stat-card"><strong>Total Power:</strong> $</LaTex>{data.totalPower}</div>
                `;
                document.getElementById("unclaimedRewards").textContent = `Unclaimed: <LaTex>${ethers.utils.formatEther(data.unclaimed)} BNB`;[ty-n]            } catch (e) {[ty-n]                console.error(e);[ty-n]                document.getElementById("userStats").innerHTML = "Error loading user stats";[ty-n]            }[ty-n]        }[ty-n][ty-n]        async function loadPrices() {[ty-n]            try {[ty-n]                const initialPrice = await contract.INITIAL\_MACHINE\_PRICE\_BNB();[ty-n]                document.getElementById("initialPrice").textContent = `Price: $</LaTex>{ethers.utils.formatEther(initialPrice)} BNB`;
                
                const testPrice = await contract.TEST_MACHINE_PRICE_BNB();
                document.getElementById("testPrice").textContent = `Price: <LaTex>${ethers.utils.formatEther(testPrice)} BNB`;[ty-n]            } catch (e) {[ty-n]                console.error("Error loading prices:", e);[ty-n]            }[ty-n]        }[ty-n][ty-n]        async function buyInitialMachine() {[ty-n]            try {[ty-n]                const price = await contract.INITIAL\_MACHINE\_PRICE\_BNB();[ty-n]                const tx = await contract.buyInitialMachine({[ty-n]                    value: price[ty-n]                });[ty-n]                await tx.wait();[ty-n]                alert("Initial machine purchased!");[ty-n]                loadUserDashboard();[ty-n]            } catch (e) {[ty-n]                console.error(e);[ty-n]                alert("Failed to purchase initial machine");[ty-n]            }[ty-n]        }[ty-n][ty-n]        async function buyTestMachine() {[ty-n]            try {[ty-n]                const price = await contract.TEST\_MACHINE\_PRICE\_BNB();[ty-n]                const tx = await contract.buyTestMachine({[ty-n]                    value: price[ty-n]                });[ty-n]                await tx.wait();[ty-n]                alert("Test machine purchased!");[ty-n]                loadUserDashboard();[ty-n]            } catch (e) {[ty-n]                console.error(e);[ty-n]                alert("Failed to purchase test machine");[ty-n]            }[ty-n]        }[ty-n][ty-n]        async function buyPowerMachine() {[ty-n]            const tierId = document.getElementById("tierId").value;[ty-n]            const count = parseInt(document.getElementById("count").value);[ty-n]            [ty-n]            try {[ty-n]                const tierInfo = await contract.machineTiers(tierId);[ty-n]                const totalPrice = tierInfo.priceToken.mul(count);[ty-n]                [ty-n]                // Check allowance[ty-n]                const allowance = await tokenContract.allowance(userAddress, contractAddress);[ty-n]                if (allowance.lt(totalPrice)) {[ty-n]                    // Approve if needed[ty-n]                    const approveTx = await tokenContract.approve(contractAddress, ethers.constants.MaxUint256);[ty-n]                    await approveTx.wait();[ty-n]                }[ty-n]                [ty-n]                const tx = await contract.buyPowerMachine(tierId, count);[ty-n]                await tx.wait();[ty-n]                alert(`Purchased $</LaTex>{count} Tier ${tierId + 1} machines!`);
                loadUserDashboard();
            } catch (e) {
                console.error(e);
                alert("Failed to purchase power machines");
            }
        }

        async function claimRewards() {
            try {
                const tx = await contract.claimRewards();
                await tx.wait();
                alert("Rewards claimed!");
                loadUserDashboard();
            } catch (e) {
                console.error(e);
                alert("Failed to claim rewards");
            }
        }

        async function setReferrer() {
            const referrer = document.getElementById("referrerAddress").value;
            try {
                const tx = await contract.setReferrer(referrer);
                await tx.wait();
                alert("Referrer set successfully!");
            } catch (e) {
                console.error(e);
                alert("Failed to set referrer");
            }
        }

        async function checkAdminStatus() {
            if (!contract || !userAddress) return;
            try {
                const isAdmin = await contract.admin(userAddress);
                const adminPanel = document.getElementById("adminPanel");
                adminPanel.style.display = isAdmin ? "block" : "none";
            } catch (e) {
                console.error(e);
            }
        }

        async function addAdmin() {
            const address = prompt("Enter admin address:");
            if (!address) return;
            try {
                const tx = await contract.addAdmin(address);
                await tx.wait();
                alert("Admin added!");
                checkAdminStatus();
            } catch (e) {
                console.error(e);
                alert("Failed to add admin");
            }
        }

        async function removeAdmin() {
            const address = prompt("Enter admin address to remove:");
            if (!address) return;
            try {
                const tx = await contract.removeAdmin(address);
                await tx.wait();
                alert("Admin removed!");
                checkAdminStatus();
            } catch (e) {
                console.error(e);
                alert("Failed to remove admin");
            }
        }

        async function addToBlocklist() {
            const address = prompt("Enter address to block:");
            if (!address) return;
            try {
                const tx = await contract.addToBlocklist(address);
                await tx.wait();
                alert("Address added to blocklist!");
            } catch (e) {
                console.error(e);
                alert("Failed to add to blocklist");
            }
        }

        async function removeFromBlocklist() {
            const address = prompt("Enter address to unblock:");
            if (!address) return;
            try {
                const tx = await contract.removeFromBlocklist(address);
                await tx.wait();
                alert("Address removed from blocklist!");
            } catch (e) {
                console.error(e);
                alert("Failed to remove from blocklist");
            }
        }

        async function withdrawTokens() {
            const amount = prompt("Enter amount to withdraw:");
            if (!amount) return;
            try {
                const tx = await contract.withdrawTokens(ethers.utils.parseEther(amount));
                await tx.wait();
                alert("Tokens withdrawn!");
            } catch (e) {
                console.error(e);
                alert("Failed to withdraw tokens");
            }
        }

        async function withdrawBNB() {
            const amount = prompt("Enter BNB amount to withdraw:");
            if (!amount) return;
            try {
                const tx = await contract.withdrawBNB({ value: ethers.utils.parseEther(amount) });
                await tx.wait();
                alert("BNB withdrawn!");
            } catch (e) {
                console.error(e);
                alert("Failed to withdraw BNB");
            }
        }

        // Auto-connect if MetaMask is available
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', async (accounts) => {
                if (accounts.length > 0) {
                    await connectWallet();
                } else {
                    location.reload();
                }
            });
        }
    </script>
</body>
</html>