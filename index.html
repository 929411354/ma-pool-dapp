<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>⭐ 星链工坊 DApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600&display=swap');
    :root {
      --bg: linear-gradient(135deg,#0f172a 0%,#1e293b 100%);
      --card-bg: rgba(30,41,59,.7);
      --accent: #3b82f6;
      --text: #e2e8f0;
      --radius: 12px;
      --shadow: 0 8px 32px rgba(0,0,0,.5);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans SC', sans-serif; }
    body { background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; display: flex; justify-content: center; }
    .container { max-width: 900px; width: 100%; display: grid; gap: 24px; }
    .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .header h1 { font-size: 2.5rem; background: linear-gradient(90deg,#60a5fa,#3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      padding: 8px 14px; border: none; border-radius: var(--radius); background: var(--accent); color: #fff; cursor: pointer; font-weight: 600; transition: .3s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(59,130,246,.5); }
    .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 14px; }
    .stat { display: flex; align-items: center; gap: 10px; font-weight: 500; }
    .stat i { color: var(--accent); }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-group input { padding: 8px; border-radius: var(--radius); border: 1px solid rgba(255,255,255,.2); background: rgba(0,0,0,.3); color: #fff; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 顶部 -->
    <div class="header">
      <h1><i class="fas fa-rocket"></i> <span id="titleTxt">星链工坊</span></h1>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="btn" id="langBtn" onclick="toggleLang()">EN</button>
      </div>
    </div>

    <!-- 导航按钮 -->
    <div class="nav-row">
      <button class="btn active" onclick="showView('dashboard')"><i class="fas fa-chart-line"></i> <span id="dashboardTxt">仪表盘</span></button>
      <button class="btn" onclick="showView('forge')"><i class="fas fa-hammer"></i> <span id="forgeTxt">星核工坊</span></button>
      <button class="btn" onclick="connectWallet()"><i class="fas fa-wallet"></i> <span id="connectTxt">连接钱包</span></button>
      <button class="btn hidden" id="adminBtn" onclick="showView('admin')"><i class="fas fa-cogs"></i> <span id="adminBtnTxt">管理员</span></button>
    </div>

    <!-- 仪表盘 -->
    <div id="dashboardView" class="card grid">
      <div class="stat"><i class="fas fa-user"></i> <span id="walletAddr">--</span></div>
      <div class="stat"><i class="fas fa-cog"></i> <span id="normalTxt">普通星核</span>: <span id="statNormal">0</span></div>
      <div class="stat"><i class="fas fa-rocket"></i> <span id="powerTxt">增强星核</span>: <span id="statPower">0</span></div>
      <div class="stat"><i class="fas fa-calendar"></i> <span id="dailyTxt">日产量</span>: <span id="statDaily">0.00</span> α</div>
      <div class="stat"><i class="fas fa-gift"></i> <span id="unclaimedTxt">未领取</span>: <span id="statUnclaimed">0.00</span> α</div>
      <div class="input-group">
        <label><span id="referLabelTxt">推荐人地址</span></label>
        <input id="referrerInput" placeholder="0x..." />
        <button class="btn" onclick="setReferrer()"><i class="fas fa-check"></i> <span id="setReferTxt">设置推荐人</span></button>
      </div>
      <button class="btn" onclick="claimRewards()"><i class="fas fa-gift"></i> <span id="claimTxt">领取收益</span></button>
    </div>

    <!-- 星核工坊 -->
    <div id="forgeView" class="card hidden">
      <h2><i class="fas fa-hammer"></i> <span id="forgeTitleTxt">星核工坊</span></h2>
      <div class="grid">
        <button class="btn" onclick="buyInitialMachine()"><i class="fas fa-plus"></i> <span id="buyInitialTxt">购买普通星核 (0.01 BNB)</span></button>
        <button class="btn" onclick="buyLevel(0)"><i class="fas fa-star"></i> <span id="tier0Txt">增强等级 0</span></button>
        <button class="btn" onclick="buyLevel(1)"><i class="fas fa-star"></i> <span id="tier1Txt">增强等级 1</span></button>
        <button class="btn" onclick="buyLevel(2)"><i class="fas fa-star"></i> <span id="tier2Txt">增强等级 2</span></button>
        <button class="btn" onclick="buyLevel(3)"><i class="fas fa-star"></i> <span id="tier3Txt">增强等级 3</span></button>
      </div>
    </div>

    <!-- 管理员面板 -->
    <div id="adminView" class="card hidden">
      <h2><i class="fas fa-cogs"></i> <span id="adminTitleTxt">星核工坊（管理员）</span></h2>
      <button class="btn" onclick="buyAdminTestMachine()"><i class="fas fa-flask"></i> <span id="adminTestTxt">购买迷你星核 (0.0001 BNB)</span></button>
      <div class="input-group">
        <label><span id="addAdminTxt">管理员地址</span></label>
        <input id="addAdminInput" placeholder="0x..." />
        <button class="btn" onclick="addAdmin()"><i class="fas fa-user-plus"></i> <span id="addBtnTxt">添加管理员</span></button>
        <button class="btn" onclick="removeAdmin()"><i class="fas fa-user-minus"></i> <span id="removeBtnTxt">移除管理员</span></button>
      </div>
      <div class="input-group">
        <label><span id="withdrawTxt">提取代币数量</span></label>
        <input id="withdrawAmount" placeholder="100" />
        <button class="btn" onclick="withdrawBNB()"><i class="fas fa-coins"></i> <span id="withdrawBNBTxt">提取BNB</span></button>
        <button class="btn" onclick="withdrawTokens()"><i class="fas fa-coins"></i> <span id="withdrawTokensTxt">提取代币</span></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0x9dCcEd4Ef738856D2c289D4116cD219c698B22ba";
    const CONTRACT_ABI = [
      "function buyInitialMachine() payable",
      "function buyTestMachine() payable",
      "function buyPowerMachine(uint256,uint256)",
      "function setReferrer(address)",
      "function claimRewards()",
      "function addAdmin(address)",
      "function removeAdmin(address)",
      "function withdrawBNB()",
      "function withdrawTokens(uint256)",
      "function admin(address) view returns(bool)",
      "function getUserDashboard(address) view returns(uint256,uint256,uint256[4],uint256,uint256,uint256,uint256)"
    ];

    let provider, signer, contract, userAddress;

    const lang = {
      zh: {
        title: "星链工坊", connect: "连接钱包", dashboard: "仪表盘", forge: "星核工坊", adminBtn: "管理员",
        normal: "普通星核", power: "增强星核", daily: "日产量", unclaimed: "未领取",
        buyInitial: "购买普通星核 (0.01 BNB)", tier0: "增强等级 0", tier1: "增强等级 1", tier2: "增强等级 2", tier3: "增强等级 3",
        refer: "推荐人地址", setRefer: "设置推荐人", claim: "领取收益",
        adminTitle: "星核工坊（管理员）", adminTest: "购买迷你星核 (0.0001 BNB)",
        addAdmin: "管理员地址", addBtn: "添加管理员", removeBtn: "移除管理员",
        withdraw: "提取代币数量", withdrawBNB: "提取BNB", withdrawTokens: "提取代币"
      },
      en: {
        title: "StarForge", connect: "Connect Wallet", dashboard: "Dashboard", forge: "Forge", adminBtn: "Admin",
        normal: "Normal Core", power: "Power Core", daily: "Daily Yield", unclaimed: "Unclaimed",
        buyInitial: "Buy Normal Core (0.01 BNB)", tier0: "Tier 0", tier1: "Tier 1", tier2: "Tier 2", tier3: "Tier 3",
        refer: "Referrer Address", setRefer: "Set Referrer", claim: "Claim Rewards",
        adminTitle: "StarForge (Admin)", adminTest: "Buy Mini Core (0.0001 BNB)",
        addAdmin: "Admin Address", addBtn: "Add Admin", removeBtn: "Remove Admin",
        withdraw: "Withdraw Amount", withdrawBNB: "Withdraw BNB", withdrawTokens: "Withdraw Tokens"
      }
    };

    let currentLang = "zh";
    function t(k) { return lang[currentLang][k] || k; }
    function toggleLang() {
      currentLang = currentLang === "zh" ? "en" : "zh";
      document.getElementById("langBtn").textContent = currentLang === "zh" ? "EN" : "中";
      applyLang();
    }
    function applyLang() {
      Object.keys(lang.zh).forEach(k => {
        const el = document.getElementById(k + "Txt") || document.getElementById(k);
        if (el) el.textContent = t(k);
      });
    }

    function showView(view) {
      ["dashboardView", "forgeView", "adminView"].forEach(v => {
        document.getElementById(v).classList.toggle("hidden", v !== view + "View");
      });
      document.querySelectorAll(".nav-row .btn").forEach(b => b.classList.remove("active"));
      document.querySelector(`[onclick="showView('${view}')"]`)?.classList.add("active");
    }

    async function connectWallet() {
      try {
        const prov = window.ethereum;
        if (!prov) return alert("请安装MetaMask或其他Web3钱包");
        await prov.request({ method: "eth_requestAccounts" });
        const chainId = await prov.request({ method: "eth_chainId" });
        if (chainId !== "0x38") await prov.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x38" }] });
        provider = new ethers.providers.Web3Provider(prov);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        document.getElementById("walletAddr").textContent = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
        document.getElementById("connectBtn").innerHTML = `<i class="fas fa-wallet"></i> ${userAddress.slice(0, 6)}...`;
        const isAdmin = await contract.admin(userAddress);
        document.getElementById("adminBtn").classList.toggle("hidden", !isAdmin);
        await loadData();
      } catch (err) { alert("连接失败: " + err.message); }
    }

    async function loadData() {
      if (!contract) return;
      try {
        const data = await contract.getUserDashboard(userAddress);
        document.getElementById("statNormal").textContent = data[0].toString();
        document.getElementById("statPower").textContent = data[1].reduce((a, b) => a + Number(b), 0);
        document.getElementById("statDaily").textContent = parseFloat(ethers.utils.formatEther(data[4])).toFixed(2);
        document.getElementById("statUnclaimed").textContent = parseFloat(ethers.utils.formatEther(data[5])).toFixed(2);
      } catch (err) { console.error("加载失败:", err); }
    }

    async function buyInitialMachine() {
      try {
        const tx = await contract.buyInitialMachine({ value: ethers.utils.parseEther("0.01") });
        await tx.wait(); alert("购买成功"); await loadData();
      } catch (err) { alert("购买失败: " + err.message); }
    }

    async function buyAdminTestMachine() {
      try {
        const tx = await contract.buyTestMachine({ value: ethers.utils.parseEther("0.0001") });
        await tx.wait(); alert("购买成功"); await loadData();
      } catch (err) { alert("购买失败: " + err.message); }
    }

    async function buyLevel(level) {
      try {
        const tx = await contract.buyPowerMachine(level, 1);
        await tx.wait(); alert(`等级${level} 购买成功`); await loadData();
      } catch (err) { alert("购买失败: " + err.message); }
    }

    async function setReferrer() {
      const ref = document.getElementById("referrerInput").value;
      if (!ethers.utils.isAddress(ref)) return alert("地址格式错误");
      try {
        const tx = await contract.setReferrer(ref);
        await tx.wait(); alert("设置成功");
      } catch (err) { alert("设置失败: " + err.message); }
    }

    async function claimRewards() {
      try {
        const tx = await contract.claimRewards();
        await tx.wait(); alert("领取成功"); await loadData();
      } catch (err) { alert("领取失败: " + err.message); }
    }

    async function addAdmin() {
      const addr = document.getElementById("addAdminInput").value;
      if (!ethers.utils.isAddress(addr)) return alert("地址格式错误");
      try {
        const tx = await contract.addAdmin(addr);
        await tx.wait(); alert("添加成功");
      } catch (err) { alert("添加失败: " + err.message); }
    }

    async function removeAdmin() {
      const addr = document.getElementById("addAdminInput").value;
      if (!ethers.utils.isAddress(addr)) return alert("地址格式错误");
      try {
        const tx = await contract.removeAdmin(addr);
        await tx.wait(); alert("移除成功");
      } catch (err) { alert("移除失败: " + err.message); }
    }

    async function withdrawBNB() {
      try {
        const tx = await contract.withdrawBNB();
        await tx.wait(); alert("提取BNB成功");
      } catch (err) { alert("提取失败: " + err.message); }
    }

    async function withdrawTokens() {
      const amt = document.getElementById("withdrawAmount").value;
      if (!amt) return alert("请输入数量");
      try {
        const tx = await contract.withdrawTokens(ethers.utils.parseUnits(amt));
        await tx.wait(); alert("提取代币成功");
      } catch (err) { alert("提取失败: " + err.message); }
    }

    showView("dashboard");
    applyLang();
  </script>
</body>
</html>