<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>矿机商店</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#f5f5f5}
    .container{max-width:800px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1)}
    .panel{display:none;margin-top:20px}
    .panel.active{display:block}
    .card{background:#fafafa;padding:15px;border-radius:6px;margin-bottom:15px}
    button{background:#007bff;color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer}
    button:disabled{background:#bbb}
    .lang-switch{cursor:pointer;color:#007bff;margin-left:10px}
  </style>
</head>
<body>
<div class="container">
  <h1 id="title">矿机商店 / Mining Machine Shop</h1>
  <div>
    <span id="wallet"></span>
    <span class="lang-switch" onclick="toggleLang()">中文 / English</span>
  </div>

  <!-- 连接钱包 -->
  <div id="connectPanel">
    <button id="btnConnect" onclick="connectWallet()">连接钱包 / Connect Wallet</button>
  </div>

  <!-- 用户面板 -->
  <div id="userPanel" class="panel">
    <h2 id="userTitle">用户面板</h2>
    <div id="userDash" class="card"></div>
    <button onclick="approveMax()">授权无限 / Approve Max</button>
    <button onclick="buyInitial()">购买初始矿机 / Buy Initial</button>
    <button onclick="buyTest()">购买测试矿机 / Buy Test</button>
    <button onclick="buyPower()">购买增强 / Buy Power</button>
    <button onclick="claim()">领取收益 / Claim</button>
  </div>

  <!-- 管理员面板（仅管理员可见） -->
  <div id="adminPanel" class="panel">
    <h2 id="adminTitle">管理员面板 / Admin Panel</h2>
    <div id="adminDash" class="card"></div>
    <input id="adminAddr" placeholder="地址 / Address" />
    <button onclick="addAdmin()">添加管理员 / Add Admin</button>
    <button onclick="removeAdmin()">移除管理员 / Remove Admin</button>
    <button onclick="withdrawToken()">提回代币 / Withdraw Tokens</button>
    <button onclick="withdrawBNB()">提回 BNB / Withdraw BNB</button>
  </div>
</div>

<script>
/* ---------- 配置 ---------- */
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"newAdmin","type":"address"}],"name":"AdminAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldAdmin","type":"address"}],"name":"AdminRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BNBWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"InitialMachinePurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"tierId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"count","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalPrice","type":"uint256"}],"name":"PowerMachinePurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewardPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"claimer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardsClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"TestMachinePurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"adder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensWithdrawn","type":"event"},{"inputs":[],"name":"BLOCKS_PER_DAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"INITIAL_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BUY_COUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REFERRAL_PERCENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TEST_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TREASURY","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"addAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"addRewardTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"addToBlocklist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"admin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseRewardPerBlockPerPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"blocklist","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tierId","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"name":"buyPowerMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyTestMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"usr","type":"address"}],"name":"dailyRewardOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGlobalDashboard","outputs":[{"internalType":"uint256","name":"baseReward","type":"uint256"},{"internalType":"uint256","name":"totalMines","type":"uint256"},{"internalType":"uint256","name":"currentBlock","type":"uint256"},{"internalType":"uint256","name":"poolBalance","type":"uint256"},{"internalType":"uint256","name":"networkPower","type":"uint256"},{"internalType":"uint256","name":"dailyProduction","type":"uint256"},{"internalType":"uint256","name":"totalRefRewards","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserDashboard","outputs":[{"internalType":"uint256","name":"normal","type":"uint256"},{"internalType":"uint256","name":"test","type":"uint256"},{"internalType":"uint256[4]","name":"power","type":"uint256[4]"},{"internalType":"uint256","name":"dailyReward","type":"uint256"},{"internalType":"uint256","name":"unclaimed","type":"uint256"},{"internalType":"uint256","name":"totalRefReward","type":"uint256"},{"internalType":"uint256","name":"totalPower","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"uint256"}],"name":"referralRecords","outputs":[{"internalType":"address","name":"referrer","type":"address"},{"internalType":"address","name":"referee","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"setReferrer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalMachines","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalNetworkPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTokensMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userInfo","outputs":[{"internalType":"uint256","name":"normalMachineCount","type":"uint256"},{"internalType":"uint256","name":"testMachineCount","type":"uint256"},{"internalType":"uint256","name":"rewardStartBlock","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"referralRewards","type":"uint256"},{"internalType":"bool","name":"hasBoughtInitial","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawTokens","outputs":[],"stateMutability":"nonpayable","type":"function"}];

const CONTRACT_ADDR = "0x9dCcEd4Ef738856D2c289D4116cD219c698B22ba";
const TOKEN_ADDR    = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";

let signer, contract, token, userAddress;

/* ---------- 语言 ---------- */
const i18n = {
  zh: {
    title: "矿机商店",
    user: "用户面板",
    admin: "管理员面板",
    connect: "连接钱包",
    approve: "授权无限",
    buyInit: "购买初始矿机",
    buyTest: "购买测试矿机",
    buyPower: "购买增强",
    claim: "领取收益",
    addAdmin: "添加管理员",
    removeAdmin: "移除管理员",
    withdrawToken: "提回代币",
    withdrawBNB: "提回 BNB",
    normal: "普通矿机",
    test: "测试矿机",
    power: "增强矿机",
    daily: "日产量",
    unclaimed: "未领取",
    refReward: "推荐奖励",
    totalPower: "总算力",
    global: "全网仪表盘",
    referral: "推荐记录",
    lang: "中文/English"
  },
  en: {
    title: "Mining Shop",
    user: "User Panel",
    admin: "Admin Panel",
    connect: "Connect Wallet",
    approve: "Approve Max",
    buyInit: "Buy Initial",
    buyTest: "Buy Test",
    buyPower: "Buy Power",
    claim: "Claim",
    addAdmin: "Add Admin",
    removeAdmin: "Remove Admin",
    withdrawToken: "Withdraw Tokens",
    withdrawBNB: "Withdraw BNB",
    normal: "Normal",
    test: "Test",
    power: "Power",
    daily: "Daily",
    unclaimed: "Unclaimed",
    refReward: "Ref Reward",
    totalPower: "Total Power",
    global: "Global Dashboard",
    referral: "Referral Records",
    lang: "中文/English"
  }
};
let lang = "zh";

function T(key) { return i18n[lang][key] || key; }

/* ---------- 初始化 ---------- */
async function connectWallet() {
  if (!window.ethereum) return alert("请安装 MetaMask");
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);
  token = new ethers.Contract(TOKEN_ADDR, ["function approve(address spender,uint256 amount) external returns(bool)"], signer);
  document.getElementById("wallet").textContent = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
  document.getElementById("connectPanel").style.display = "none";
  document.getElementById("userPanel").classList.add("active");
  refresh();
  const isAdmin = await contract.admin(userAddress);
  if (isAdmin || userAddress.toLowerCase() === (await contract.owner()).toLowerCase()) {
    document.getElementById("adminPanel").classList.add("active");
  }
}

/* ---------- 授权 ---------- */
async function approveMax() {
  await (await token.approve(CONTRACT_ADDR, ethers.constants.MaxUint256)).wait();
  alert("已授权无限额度");
}

/* ---------- 购买 ---------- */
async function buyInitial() {
  await (await contract.buyInitialMachine({value: ethers.utils.parseEther("0.01")})).wait();
  refresh();
}
async function buyTest() {
  await (await contract.buyTestMachine({value: ethers.utils.parseEther("0.0001")})).wait();
  refresh();
}
async function buyPower() {
  const tier = prompt("档位 0-3 ?");
  const count = prompt("数量 ?");
  if (!tier || !count) return;
  await (await contract.buyPowerMachine(tier, count)).wait();
  refresh();
}

/* ---------- 领取 ---------- */
async function claim() {
  await (await contract.claimRewards()).wait();
  refresh();
}

/* ---------- 管理员 ---------- */
async function addAdmin() {
  const addr = document.getElementById("adminAddr").value;
  await (await contract.addAdmin(addr)).wait();
  alert("已添加");
}
async function removeAdmin() {
  const addr = document.getElementById("adminAddr").value;
  await (await contract.removeAdmin(addr)).wait();
  alert("已移除");
}
async function withdrawToken() {
  const amt = prompt("金额 (wei)");
  await (await contract.withdrawTokens(amt)).wait();
  alert("已提回");
}
async function withdrawBNB() {
  const amt = prompt("金额 (wei)");
  await (await contract.withdrawBNB({value: 0})).wait();
  alert("已提回");
}

/* ---------- 刷新 ---------- */
async function refresh() {
  const user = await contract.getUserDashboard(userAddress);
  const global = await contract.getGlobalDashboard();
  document.getElementById("userDash").innerHTML = `
    <b>${T("normal")}</b>: ${user.normal}<br>
    <b>${T("test")}</b>: ${user.test}<br>
    <b>${T("power")}</b>: [${user.power.join(", ")}]<br>
    <b>${T("daily")}</b>: ${ethers.utils.formatEther(user.dailyReward)}<br>
    <b>${T("unclaimed")}</b>: ${ethers.utils.formatEther(user.unclaimed)}<br>
    <b>${T("refReward")}</b>: ${ethers.utils.formatEther(user.totalRefReward)}<br>
    <b>${T("totalPower")}</b>: ${ethers.utils.formatEther(user.totalPower)}
  `;
  document.getElementById("adminDash").innerHTML = `
    <b>${T("global")}</b>:<br>
    Base Reward: ${ethers.utils.formatEther(global.baseReward)}<br>
    Total Mines: ${global.totalMines}<br>
    Pool Balance: ${ethers.utils.formatEther(global.poolBalance)}<br>
    Network Power: ${ethers.utils.formatEther(global.networkPower)}<br>
    Daily Production: ${ethers.utils.formatEther(global.dailyProduction)}<br>
    Total Ref Rewards: ${ethers.utils.formatEther(global.totalRefRewards)}
  `;
}

/* ---------- 语言 ---------- */
function toggleLang() {
  lang = lang === "zh" ? "en" : "zh";
  document.getElementById("title").textContent = T("title");
  document.getElementById("userTitle").textContent = T("user");
  document.getElementById("adminTitle").textContent = T("admin");
  document.querySelector("#btnConnect").textContent = T("connect");
  refresh();
}

/* ---------- 绑定按钮文字 ---------- */
document.querySelector("#btnConnect").textContent = T("connect");
</script>
</body>
</html>