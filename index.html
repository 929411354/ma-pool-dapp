<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Mining DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 独立组件样式 */
        .stellar-energy-poster-generator {
            --primary-gradient: linear-gradient(to right, #8a6bff, #5d9bff);
            --secondary-gradient: linear-gradient(to right, #ff6b6b, #ff9b5d);
            --background-gradient: linear-gradient(135deg, #091947 0%, #0a0529 100%);
            --text-color: #fff;
            --accent-color: #ffcf5c;
            --card-bg: linear-gradient(to bottom, #2a1957, #0d0b2b);
            --border-color: rgba(103, 72, 186, 0.3);
            --shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            font-family: 'Arial Rounded MT Bold', 'Segoe UI', sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: var(--text-color);
            position: relative;
            overflow: auto;
            touch-action: manipulation;
        }

        .stellar-container {
            width: 100%;
            max-width: 375px;
            margin: 0 auto;
            transform-origin: top center;
            transform: scale(1);
            transition: transform 0.2s;
            padding-bottom: 20px;
        }

        .stellar-poster-container {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            padding: 25px 15px;
        }

        .stellar-space-decoration {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .stellar-star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .stellar-planet {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, #aaa);
            transform: rotate(45deg);
        }

        .stellar-header-section {
            text-align: center;
            padding: 15px 0;
            position: relative;
            z-index: 1;
        }

        .stellar-logo-text {
            font-size: 28px;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .stellar-subtitle {
            font-size: 14px;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        .stellar-character-section {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
            z-index: 1;
        }

        .stellar-spaceship {
            width: 80px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        .stellar-spaceship::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .stellar-info-section {
            text-align: center;
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .stellar-info-title {
            font-size: 18px;
            margin-bottom: 10px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stellar-info-desc {
            font-size: 14px;
            line-height: 1.5;
            opacity: 0.9;
        }

        .stellar-qr-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            position: relative;
            z-index: 1;
        }

        .stellar-qr-title {
            font-size: 16px;
            margin-bottom: 15px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stellar-qr-code {
            width: 90px;
            height: 90px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stellar-qr-code canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .stellar-qr-tip {
            font-size: 12px;
            margin-top: 10px;
            opacity: 0.7;
        }

        .stellar-action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .stellar-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .stellar-action-btn.primary {
            background: var(--primary-gradient);
            color: white;
        }

        .stellar-action-btn.secondary {
            background: var(--secondary-gradient);
            color: white;
        }

        .stellar-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stellar-share-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            border: 1px solid var(--border-color);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
        }

        .stellar-share-panel.active {
            transform: translateY(0);
        }

        .stellar-share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stellar-share-title {
            font-size: 18px;
            font-weight: bold;
        }

        .stellar-share-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
        }

        .stellar-share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stellar-share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stellar-share-option:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stellar-share-option i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .stellar-share-option span {
            font-size: 14px;
        }

        .stellar-digital-asset-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .stellar-digital-asset-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .stellar-digital-asset-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            max-width: 300px;
            width: 100%;
        }

        .stellar-digital-asset-content h3 {
            margin-bottom: 15px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stellar-digital-asset-content p {
            margin-bottom: 20px;
            opacity: 0.8;
            font-size: 14px;
        }

        .stellar-digital-asset-qrcode {
            margin: 20px 0;
            display: inline-block;
        }

        .stellar-digital-asset-qrcode canvas {
            width: 200px !important;
            height: 200px !important;
        }

        .stellar-digital-asset-close {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .stellar-ios-save-instructions {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px;
        }

        .stellar-ios-save-instructions.active {
            opacity: 1;
            pointer-events: all;
        }

        .stellar-ios-save-instructions h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 20px;
        }

        .stellar-ios-save-instructions p {
            color: var(--text-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 16px;
        }

        .stellar-ios-save-close {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }

        .stellar-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .stellar-loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .stellar-loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--accent-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stellar-download-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .stellar-download-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .no-animation {
            animation: none !important;
            transition: none !important;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            z-index: 1003;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.active {
            opacity: 1;
        }

        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            transition: background 0.3s ease;
            padding-bottom: 80px;
        }

        body.light-mode {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .container {
            max-width: 428px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .logo-icon .hexagon {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon .inner-shape {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: relative;
        }

        .logo-icon .inner-shape::before {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--accent-blue);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .logo-icon .pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 0.3; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }

        .logo-text {
            font-size: 24px;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .wallet-info-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-dark);
            border-top: 1px solid var(--border-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .wallet-info {
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .wallet-info.red {
            color: #ff6b6b;
        }

        .wallet-info.green {
            color: #2ecc71;
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        .nav-item i {
            font-size: 18px;
            display: block;
            margin-bottom: 5px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary-gradient);
            color: white;
        }

        .btn-accent {
            background: var(--accent-pink);
            color: white;
        }

        .referral-section {
            margin-bottom: 20px;
        }

        .referral-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .referral-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .referral-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .referral-auto, .referral-success {
            display: none;
            font-size: 14px;
            margin-bottom: 15px;
            color: #2ecc71;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qrcode-container {
            text-align: center;
        }

        .qrcode-header {
            font-size: 16px;
            margin-bottom: 15px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .share-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .share-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .copy-btn {
            background: var(--secondary-gradient);
            color: white;
        }
    </style>
</head>
<body>
    <!-- 海报生成器组件 -->
    <div class="stellar-energy-poster-generator">
        <div class="stellar-container" id="stellarMainContainer">
            <div class="stellar-poster-container" id="stellarPoster">
                <div class="stellar-space-decoration" id="stellarSpaceDecoration"></div>
                <div class="stellar-header-section">
                    <div class="stellar-logo-text">星际能源站</div>
                    <div class="stellar-subtitle">玩赚宇宙能源时代</div>
                </div>
                <div class="stellar-character-section">
                    <div class="stellar-spaceship"></div>
                </div>
                <div class="stellar-info-section">
                    <div class="stellar-info-title">探索宇宙能源，积累数字资产</div>
                    <div class="stellar-info-desc">立即加入星际能源站<br>探索宇宙能源，积累数字资产</div>
                </div>
                <div class="stellar-qr-section">
                    <div class="stellar-qr-title">扫码加入星际能源站</div>
                    <div class="stellar-qr-code" id="stellarPosterQrcode"></div>
                    <div class="stellar-qr-tip">长按保存海报，扫码加入</div>
                </div>
                <div class="stellar-action-buttons">
                    <button class="stellar-action-btn primary" id="stellarDownloadBtn">
                        <i class="fas fa-download"></i> 保存海报
                    </button>
                    <button class="stellar-action-btn secondary" id="stellarShareBtn">
                        <i class="fas fa-share-alt"></i> 分享邀请
                    </button>
                </div>
            </div>
        </div>

        <!-- 下载加载覆盖层 -->
        <div class="stellar-download-overlay" id="stellarDownloadOverlay">
            <div class="stellar-loading-spinner"></div>
        </div>

        <!-- 分享面板 -->
        <div class="stellar-share-panel" id="stellarSharePanel">
            <div class="stellar-share-header">
                <div class="stellar-share-title">分享邀请链接</div>
                <button class="stellar-share-close" id="stellarShareCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="stellar-share-options">
                <div class="stellar-share-option" id="stellarShareTwitter">
                    <i class="fab fa-twitter"></i>
                    <span>Twitter</span>
                </div>
                <div class="stellar-share-option" id="stellarShareFacebook">
                    <i class="fab fa-facebook"></i>
                    <span>Facebook</span>
                </div>
                <div class="stellar-share-option" id="stellarShareWechat">
                    <i class="fab fa-weixin"></i>
                    <span>微信</span>
                </div>
                <div class="stellar-share-option" id="stellarShareQQ">
                    <i class="fab fa-qq"></i>
                    <span>QQ</span>
                </div>
                <div class="stellar-share-option" id="stellarShareTelegram">
                    <i class="fab fa-telegram"></i>
                    <span>Telegram</span>
                </div>
                <div class="stellar-share-option" id="stellarShareWhatsApp">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp</span>
                </div>
                <div class="stellar-share-option" id="stellarShareLink">
                    <i class="fas fa-link"></i>
                    <span>复制链接</span>
                </div>
                <div class="stellar-share-option" id="stellarShareDigitalAsset">
                    <i class="fas fa-wallet"></i>
                    <span>数字资产</span>
                </div>
                <div class="stellar-share-option" id="stellarShareSystem">
                    <i class="fas fa-share"></i>
                    <span>系统分享</span>
                </div>
            </div>
        </div>

        <!-- 数字资产分享模态框 -->
        <div class="stellar-digital-asset-modal" id="stellarDigitalAssetModal">
            <div class="stellar-digital-asset-content">
                <h3>数字资产分享</h3>
                <p>扫描二维码分享到数字资产应用</p>
                <div class="stellar-digital-asset-qrcode" id="stellarDigitalAssetQrcode"></div>
                <button class="stellar-digital-asset-close" id="stellarDigitalAssetCloseBtn">关闭</button>
            </div>
        </div>

        <!-- 移动设备保存说明 -->
        <div class="stellar-ios-save-instructions" id="stellarIosSaveInstructions">
            <h3>保存海报到相册</h3>
            <p>在移动设备上，请按照以下步骤保存海报：</p>
            <p>1. 长按下面的图片</p>
            <p>2. 选择"保存图片"选项</p>
            <div id="stellarIosSaveImageContainer"></div>
            <button class="stellar-ios-save-close" id="stellarIosSaveCloseBtn">关闭</button>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-container">
                <div class="logo-icon">
                    <div class="hexagon"></div>
                    <div class="inner-shape"></div>
                    <div class="pulse"></div>
                </div>
                <div class="logo-text">Star Mining</div>
            </div>
            <div class="wallet-info" id="walletInfo">连接钱包</div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-item active" onclick="switchPage('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span id="homeNav">Home</span>
            </div>
            <div class="nav-item" onclick="switchPage('shop')">
                <i class="fas fa-store"></i>
                <span id="shopNav">Shop</span>
            </div>
            <div class="nav-item" onclick="switchPage('rewards')">
                <i class="fas fa-user-friends"></i>
                <span id="rewardsNav">Rewards</span>
            </div>
            <div class="nav-item" onclick="switchPage('global')">
                <i class="fas fa-globe-americas"></i>
                <span id="globalNav">Global</span>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div class="page active" id="dashboardPage">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-tachometer-alt"></i>
                    <span id="dashboardTitle">Personal Dashboard</span>
                </div>
                <div class="balance-info">
                    <div class="balance-item">
                        <span id="balanceLabel">α Balance</span>
                        <div id="tokenBalance">0.0000</div>
                    </div>
                    <div class="balance-item">
                        <span id="earningsLabel">Total Earnings</span>
                        <div id="totalEarnings">0.0000</div>
                    </div>
                    <div class="balance-item">
                        <span id="dailyLabel">Daily Reward</span>
                        <div id="dailyReward">0.0000</div>
                    </div>
                    <div class="balance-item">
                        <span id="unclaimedLabel">Unclaimed</span>
                        <div id="unclaimedReward">0.0000</div>
                    </div>
                </div>
                <button class="btn btn-primary" id="claimBtn" onclick="claimRewards()">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span id="claimText">Claim Rewards</span>
                </button>
            </div>
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-microchip"></i>
                    <span id="devicesTitle">Device Status</span>
                </div>
                <div id="deviceStatus">No devices</div>
            </div>
        </div>

        <!-- Shop Page -->
        <div class="page" id="shopPage">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-store"></i>
                    <span id="shopTitle">Device Shop</span>
                </div>
                <div class="tab-container">
                    <div class="tab active" onclick="switchTab('initial')">
                        <span id="initialTab">Initial Device</span>
                    </div>
                    <div class="tab" onclick="switchTab('power')">
                        <span id="powerTab">Power Device</span>
                    </div>
                    <div class="tab" onclick="switchTab('test')">
                        <span id="testTab">Test Device</span>
                    </div>
                </div>
                <div class="tab-content active" id="initialContent">
                    <div class="device-item">
                        <h4>Initial Machine</h4>
                        <p>Power: 1.0</p>
                        <p>Price: 0.01 BNB</p>
                        <button class="btn btn-primary" onclick="buyInitialMachine()">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="buyInitialText">Buy Device</span>
                        </button>
                    </div>
                </div>
                <div class="tab-content" id="powerContent">
                    <div class="device-item">
                        <h4>Moonlight Converter</h4>
                        <p id="multiplier1">Multiplier: × 1.76</p>
                        <p>Price: 0.02 BNB</p>
                        <button class="btn btn-primary" onclick="buyPowerMachine(1)">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="buyPowerText">Buy Device</span>
                        </button>
                    </div>
                    <div class="device-item">
                        <h4>Stardust Collector L1</h4>
                        <p id="multiplier2">Multiplier: × 3.30</p>
                        <p>Price: 0.05 BNB</p>
                        <button class="btn btn-primary" onclick="buyPowerMachine(2)">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="buyPowerText">Buy Device</span>
                        </button>
                    </div>
                    <div class="device-item">
                        <h4>Quantum Dandelion L2</h4>
                        <p id="multiplier3">Multiplier: × 4.84</p>
                        <p>Price: 0.1 BNB</p>
                        <button class="btn btn-primary" onclick="buyPowerMachine(3)">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="buyPowerText">Buy Device</span>
                        </button>
                    </div>
                    <div class="device-item">
                        <h4>Aurora Weaver L3</h4>
                        <p id="multiplier4">Multiplier: × 7.15</p>
                        <p>Price: 0.2 BNB</p>
                        <button class="btn btn-primary" onclick="buyPowerMachine(4)">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="buyPowerText">Buy Device</span>
                        </button>
                    </div>
                </div>
                <div class="tab-content" id="testContent">
                    <div class="device-item">
                        <h4>Galaxy Filter L4</h4>
                        <p>Power: 10.0</p>
                        <p>Price: 0.5 BNB</p>
                        <button class="btn btn-primary" onclick="buyTestMachine()">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="buyTestText">Buy Device</span>
                        </button>
                    </div>
                    <div id="noPermissionMessage" style="display: none; text-align: center; margin-top: 15px;">
                        <p>您没有权限购买测试设备。</p>
                        <p>此功能仅对管理员或合约所有者开放。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rewards Page -->
        <div class="page" id="rewardsPage">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-user-friends"></i>
                    <span id="referralTitle">Referral System</span>
                </div>
                <div class="referral-section">
                    <h3><i class="fas fa-user-plus"></i> 邀请人地址</h3>
                    <p>如果您是通过邀请链接加入，系统已自动填写邀请人地址</p>
                    <div class="referral-input">
                        <input type="text" id="referrerInput" placeholder="输入推荐人钱包地址">
                        <button class="btn-secondary" id="setReferrerBtn" onclick="setReferrer()">设置</button>
                    </div>
                    <div class="referral-auto" id="referralAuto">
                        <i class="fas fa-check-circle"></i> 已自动填写邀请人地址
                    </div>
                    <div class="referral-success" id="referralSuccess">
                        <i class="fas fa-check-circle"></i> 邀请人地址已保存
                    </div>
                </div>
                <div class="qrcode-container">
                    <div class="qrcode-header">我的邀请二维码</div>
                    <div id="qrcode"></div>
                </div>
            </div>
        </div>

        <!-- Global Stats Page -->
        <div class="page" id="globalPage">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-globe-americas"></i>
                    <span id="globalTitle">Global Stats</span>
                </div>
                <div class="stat-item">
                    <span id="machinesLabel">Total Devices</span>
                    <div id="totalMachines">0</div>
                </div>
                <div class="stat-item">
                    <span id="powerLabel">Network Power</span>
                    <div id="totalNetworkPower">0</div>
                </div>
                <div class="stat-item">
                    <span id="poolLabel">Reward Pool</span>
                    <div id="rewardPool">0.0000</div>
                </div>
                <div class="stat-item">
                    <span>Total Tokens Minted</span>
                    <div id="totalTokensMinted">0.0000</div>
                </div>
                <div class="stat-item">
                    <span>Daily Production</span>
                    <div id="dailyProduction">0.0000</div>
                </div>
                <div class="stat-item">
                    <span>Current Block</span>
                    <div id="currentBlock">0</div>
                </div>
                <div class="stat-item">
                    <span>Base Reward</span>
                    <div id="baseReward">0.0000</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Info Container -->
    <div class="wallet-info-container">
        <div class="wallet-info" id="walletInfoBottom">连接钱包</div>
        <div>
            <button class="btn btn-secondary" id="langBtn" onclick="switchLanguage()">
                <span id="langText">中文</span>
            </button>
        </div>
    </div>

    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = '0x9dcced4ef738856d2c289d4116cd219c698b22ba';
        const TOKEN_ADDRESS = '0x877f23dcFBa91cadd7d35565Da452c9673C27A33';
        
        const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ClaimRewards","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"DepositBNB","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewards","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WithdrawBNB","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WithdrawTokens","type":"event"},{"inputs":[],"name":"BNB","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"INITIAL_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_REFERRAL_REWARD_RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_REFERRAL_REWARD_RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"POWER_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REFERRAL_REWARD_RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TIER1_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TIER2_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TIER3_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TIER4_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TEST_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TREASURY","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"addAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"addRewardTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"addToBlocklist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"admin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseRewardPerBlockPerPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"blocklist","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tierId","type":"uint256"}],"name":"buyPowerMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyTestMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"usr","type":"address"}],"name":"dailyRewardOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"usr","type":"address"}],"name":"getReferralInfo","outputs":[{"internalType":"uint256","name":"normalMachineCount","type":"uint256"},{"internalType":"uint256","name":"testMachineCount","type":"uint256"},{"internalType":"uint256","name":"rewardStartBlock","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"referralRewards","type":"uint256"},{"internalType":"bool","name":"hasBoughtInitial","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalMachines","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalNetworkPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalTokensMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"tokenBalance","type":"uint256"},{"internalType":"uint256","name":"totalEarnings","type":"uint256"},{"internalType":"uint256","name":"dailyReward","type":"uint256"},{"internalType":"uint256","name":"unclaimedReward","type":"uint256"},{"internalType":"uint256","name":"totalMachines","type":"uint256"},{"internalType":"uint256","name":"totalNetworkPower","type":"uint256"},{"internalType":"uint256","name":"rewardPool","type":"uint256"},{"internalType":"uint256","name":"dailyProduction","type":"uint256"},{"internalType":"uint256","name":"currentBlock","type":"uint256"},{"internalType":"uint256","name":"baseReward","type":"uint256"},{"internalType":"uint256","name":"totalTokensMinted","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"INITIAL_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isOwner","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"referralRecords","outputs":[{"internalType":"address","name":"referrer","type":"address"},{"internalType":"address","name":"referee","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"removeAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"removeFromBlocklist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"rewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"setReferrer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalMachines","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalNetworkPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTokensMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"uniswapV2Pair","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"uniswapV2Router","outputs":[{"internalType":"contract IUniswapV2Router02","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updateBaseRewardPerBlockPerPower","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updateInitialMachinePriceBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updatePowerMachinePriceBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"rate","type":"uint256"}],"name":"updateReferralRewardRate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updateTier1MachinePriceBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updateTier2MachinePriceBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updateTier3MachinePriceBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updateTier4MachinePriceBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"updateTestMachinePriceBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawTokens","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        
        const TOKEN_ABI = [{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

        // Global variables
        let web3;
        let contract;
        let tokenContract;
        let userAccount;
        let isAdmin = false;
        let isOwner = false;
        let currentLanguage = 'zh'; // 'zh' or 'en'
        let qrCodeInstance;

        // Language dictionaries
        const translations = {
            zh: {
                connectWalletText: "连接钱包",
                dashboardTitle: "个人仪表盘",
                balanceLabel: "α余额",
                earningsLabel: "累计收益",
                dailyLabel: "今日收益",
                unclaimedLabel: "未领取",
                claimText: "领取收益",
                devicesTitle: "设备状态",
                limitText: "每人限购1台",
                buyInitialText: "购买设备",
                buyPowerText: "购买设备",
                buyTestText: "购买设备",
                homeNav: "首页",
                shopNav: "商店",
                rewardsNav: "奖励",
                globalNav: "全局",
                moonlightName: "月光转换器",
                stardustName: "星尘收集器L1",
                quantumName: "量子蒲公英L2",
                auroraName: "极光编织者L3",
                galaxyName: "银河过滤器L4",
                phantomName: "幻影调试器",
                initialTab: "初始设备",
                powerTab: "强力设备",
                testTab: "测试设备",
                referralTitle: "推荐体系",
                referrerPlaceholder: "输入推荐人钱包地址",
                setReferrerBtn: "设置",
                myReferralText: "我的邀请码:",
                globalTitle: "全局统计",
                machinesLabel: "总设备数",
                powerLabel: "网络算力",
                poolLabel: "奖励池",
                multiplier1: "算力 × 1.76",
                multiplier2: "算力 × 3.30",
                multiplier3: "算力 × 4.84",
                multiplier4: "算力 × 7.15",
                langText: "英文",
                unitMachine: "台",
                powerMultiplier: "算力 ×",
                powerRatioText: "总算力占比:",
                shareText: "分享",
                copyText: "复制",
                qrcodeHeader: "我的邀请二维码"
            },
            en: {
                connectWalletText: "Connect Wallet",
                dashboardTitle: "Personal Dashboard",
                balanceLabel: "α Balance",
                earningsLabel: "Total Earnings",
                dailyLabel: "Daily Reward",
                unclaimedLabel: "Unclaimed",
                claimText: "Claim Rewards",
                devicesTitle: "Device Status",
                limitText: "Limit 1 per person",
                buyInitialText: "Buy Device",
                buyPowerText: "Buy Device",
                buyTestText: "Buy Device",
                homeNav: "Home",
                shopNav: "Shop",
                rewardsNav: "Rewards",
                globalNav: "Global",
                moonlightName: "Moonlight Converter",
                stardustName: "Stardust Collector L1",
                quantumName: "Quantum Dandelion L2",
                auroraName: "Aurora Weaver L3",
                galaxyName: "Galaxy Filter L4",
                phantomName: "Phantom Debugger",
                initialTab: "Initial Device",
                powerTab: "Power Device",
                testTab: "Test Device",
                referralTitle: "Referral System",
                referrerPlaceholder: "Enter referrer address",
                setReferrerBtn: "Set",
                myReferralText: "My Referral Code:",
                globalTitle: "Global Stats",
                machinesLabel: "Total Devices",
                powerLabel: "Network Power",
                poolLabel: "Reward Pool",
                multiplier1: "Power × 1.76",
                multiplier2: "Power × 3.30",
                multiplier3: "Power × 4.84",
                multiplier4: "Power × 7.15",
                langText: "中文",
                unitMachine: "units",
                powerMultiplier: "Power ×",
                powerRatioText: "Power Ratio:",
                shareText: "Share",
                copyText: "Copy",
                qrcodeHeader: "My Referral QR Code"
            }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function() {
            initWeb3();
            updateLanguage();
            
            // Check for referral address in URL
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const referralAddress = urlParams.get('ref') || 
                                       urlParams.get('referral') || 
                                       urlParams.get('refAddress') || 
                                       urlParams.get('address') || 
                                       urlParams.get('invite') || 
                                       urlParams.get('inviter') || 
                                       urlParams.get('ref_id') || 
                                       urlParams.get('referrer');
                
                if (referralAddress) {
                    const referralInput = document.getElementById('referrerInput');
                    referralInput.value = referralAddress;
                    console.log('自动填写邀请地址:', referralAddress);
                    
                    // 显示自动填写提示
                    const referralAuto = document.getElementById('referralAuto');
                    referralAuto.style.display = 'block';
                    
                    // 添加视觉反馈
                    referralInput.style.border = '2px solid #2ecc71';
                    referralInput.style.backgroundColor = '#e8f5e9';
                    
                    setTimeout(() => {
                        referralInput.style.border = '';
                        referralInput.style.backgroundColor = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('自动填写失败:', error);
            }
        });

        // Initialize Web3
        async function initWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                try {
                    // Request account access
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                        tokenContract = new web3.eth.Contract(TOKEN_ABI, TOKEN_ADDRESS);
                        updateWalletInfo();
                        loadDashboardData();
                    }
                } catch (error) {
                    console.error('User denied account access', error);
                }
            } else {
                showToast('No Ethereum browser extension detected, install MetaMask!');
            }
        }

        // Update wallet info display
        function updateWalletInfo() {
            const walletElement = document.getElementById('walletInfo');
            const walletElementBottom = document.getElementById('walletInfoBottom');
            
            if (userAccount) {
                const shortAddress = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                walletElement.textContent = shortAddress;
                walletElement.classList.remove('red');
                walletElement.classList.add('green');
                walletElement.onclick = copyAddress;
                
                walletElementBottom.textContent = shortAddress;
                walletElementBottom.classList.remove('red');
                walletElementBottom.classList.add('green');
                walletElementBottom.onclick = copyAddress;
            } else {
                walletElement.textContent = currentLanguage === 'zh' ? '连接钱包' : 'Connect Wallet';
                walletElement.classList.add('red');
                walletElement.classList.remove('green');
                walletElement.onclick = connectWallet;
                
                walletElementBottom.textContent = currentLanguage === 'zh' ? '连接钱包' : 'Connect Wallet';
                walletElementBottom.classList.add('red');
                walletElementBottom.classList.remove('green');
                walletElementBottom.onclick = connectWallet;
            }
        }

        // Copy address to clipboard
        function copyAddress() {
            if (userAccount) {
                navigator.clipboard.writeText(userAccount).then(() => {
                    showToast(currentLanguage === 'zh' ? '地址已复制到剪贴板!' : 'Address copied to clipboard!', 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showToast(currentLanguage === 'zh' ? '复制失败' : 'Copy failed', 'error');
                });
            } else {
                connectWallet();
            }
        }

        // Connect wallet
        async function connectWallet() {
            showLoading(true);
            try {
                const connected = await initWeb3();
                if (connected) {
                    // Check token allowance
                    const allowance = await tokenContract.methods.allowance(userAccount, CONTRACT_ADDRESS).call();
                    const maxUint256 = '115792089237316195423570985008687907853269984665640564039457584007913129639935';
                    
                    if (allowance === '0') {
                        // Request approval
                        await tokenContract.methods.approve(CONTRACT_ADDRESS, maxUint256).send({ from: userAccount });
                        showToast(currentLanguage === 'zh' ? '代币授权成功!' : 'Token approval successful!', 'success');
                    }
                    
                    // Check if user is admin or owner
                    isAdmin = await contract.methods.admin(userAccount).call();
                    isOwner = await contract.methods.isOwner().call();
                    
                    // Update UI
                    updateWalletInfo();
                    loadDashboardData();
                    
                    // Show appropriate messages
                    if (isAdmin) {
                        showToast(currentLanguage === 'zh' ? '管理员模式已激活' : 'Admin mode activated', 'success');
                    }
                    if (isOwner) {
                        showToast(currentLanguage === 'zh' ? '所有者模式已激活' : 'Owner mode activated', 'success');
                    }
                }
            } catch (error) {
                console.error('连接钱包失败:', error);
                showToast(currentLanguage === 'zh' ? `连接失败: ${error.message}` : `Connection failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            if (!contract || !userAccount) return;
            
            showLoading(true);
            try {
                const userInfo = await contract.methods.getUserInfo().call({ from: userAccount });
                const tokenBalance = await contract.methods.getTokenBalance().call({ from: userAccount });
                const referralInfo = await contract.methods.getReferralInfo(userAccount).call({ from: userAccount });
                
                // Update dashboard values
                document.getElementById('tokenBalance').textContent = formatNumber(web3.utils.fromWei(tokenBalance, 'ether'));
                document.getElementById('totalEarnings').textContent = formatNumber(web3.utils.fromWei(userInfo.totalEarnings, 'ether'));
                document.getElementById('dailyReward').textContent = formatNumber(web3.utils.fromWei(userInfo.dailyReward, 'ether'));
                document.getElementById('unclaimedReward').textContent = formatNumber(web3.utils.fromWei(userInfo.unclaimedReward, 'ether'));
                
                // Update device status
                const deviceStatus = document.getElementById('deviceStatus');
                if (referralInfo.hasBoughtInitial) {
                    const totalMachines = parseInt(referralInfo.normalMachineCount) + parseInt(referralInfo.testMachineCount);
                    deviceStatus.textContent = `${totalMachines} ${currentLanguage === 'zh' ? '台设备' : 'units'}`;
                } else {
                    deviceStatus.textContent = currentLanguage === 'zh' ? '未购买设备' : 'No devices';
                }
                
                // Update global stats
                document.getElementById('totalMachines').textContent = userInfo.totalMachines;
                document.getElementById('totalNetworkPower').textContent = formatNumber(userInfo.totalNetworkPower);
                document.getElementById('rewardPool').textContent = formatNumber(web3.utils.fromWei(userInfo.rewardPool, 'ether'));
                document.getElementById('totalTokensMinted').textContent = formatNumber(web3.utils.fromWei(userInfo.totalTokensMinted, 'ether'));
                document.getElementById('dailyProduction').textContent = formatNumber(web3.utils.fromWei(userInfo.dailyProduction, 'ether'));
                document.getElementById('currentBlock').textContent = userInfo.currentBlock;
                document.getElementById('baseReward').textContent = formatNumber(web3.utils.fromWei(userInfo.baseReward, 'ether'));
                
                // Update shop permissions
                const noPermissionMessage = document.getElementById('noPermissionMessage');
                if (isOwner || isAdmin) {
                    noPermissionMessage.style.display = 'none';
                } else {
                    noPermissionMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                showToast(currentLanguage === 'zh' ? `加载失败: ${error.message}` : `Load failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Claim rewards
        async function claimRewards() {
            if (!contract || !userAccount) {
                connectWallet();
                return;
            }
            
            showLoading(true);
            try {
                await contract.methods.claimRewards().send({ from: userAccount });
                showToast(currentLanguage === 'zh' ? '收益领取成功!' : 'Rewards claimed successfully!', 'success');
                loadDashboardData();
            } catch (error) {
                console.error('领取收益失败:', error);
                showToast(currentLanguage === 'zh' ? `领取失败: ${error.message}` : `Claim failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Buy initial machine
        async function buyInitialMachine() {
            if (!contract || !userAccount) {
                connectWallet();
                return;
            }
            
            showLoading(true);
            try {
                const price = await contract.methods.INITIAL_MACHINE_PRICE_BNB().call();
                await contract.methods.buyInitialMachine().send({ 
                    from: userAccount, 
                    value: price 
                });
                showToast(currentLanguage === 'zh' ? '设备购买成功!' : 'Device purchased successfully!', 'success');
                loadDashboardData();
            } catch (error) {
                console.error('购买设备失败:', error);
                showToast(currentLanguage === 'zh' ? `购买失败: ${error.message}` : `Purchase failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Buy power machine
        async function buyPowerMachine(tierId) {
            if (!contract || !userAccount) {
                connectWallet();
                return;
            }
            
            showLoading(true);
            try {
                await contract.methods.buyPowerMachine(tierId).send({ from: userAccount });
                showToast(currentLanguage === 'zh' ? '设备购买成功!' : 'Device purchased successfully!', 'success');
                loadDashboardData();
            } catch (error) {
                console.error('购买设备失败:', error);
                showToast(currentLanguage === 'zh' ? `购买失败: ${error.message}` : `Purchase failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Buy test machine
        async function buyTestMachine() {
            if (!contract || !userAccount) {
                connectWallet();
                return;
            }
            
            showLoading(true);
            try {
                const price = await contract.methods.TEST_MACHINE_PRICE_BNB().call();
                await contract.methods.buyTestMachine().send({ 
                    from: userAccount, 
                    value: price 
                });
                showToast(currentLanguage === 'zh' ? '设备购买成功!' : 'Device purchased successfully!', 'success');
                loadDashboardData();
            } catch (error) {
                console.error('购买设备失败:', error);
                showToast(currentLanguage === 'zh' ? `购买失败: ${error.message}` : `Purchase failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Set referrer
        async function setReferrer() {
            if (!contract || !userAccount) {
                connectWallet();
                return;
            }
            
            const referrerInput = document.getElementById('referrerInput');
            const referrerAddress = referrerInput.value.trim();
            
            if (!web3.utils.isAddress(referrerAddress)) {
                showToast(currentLanguage === 'zh' ? '请输入有效的钱包地址' : 'Please enter a valid wallet address', 'error');
                return;
            }
            
            if (referrerAddress.toLowerCase() === userAccount.toLowerCase()) {
                showToast(currentLanguage === 'zh' ? '不能设置自己为推荐人' : 'Cannot set yourself as referrer', 'error');
                return;
            }
            
            showLoading(true);
            try {
                await contract.methods.setReferrer(referrerAddress).send({ from: userAccount });
                showToast(currentLanguage === 'zh' ? '推荐人设置成功!' : 'Referrer set successfully!', 'success');
                
                // Show success message
                const referralSuccess = document.getElementById('referralSuccess');
                referralSuccess.style.display = 'block';
                setTimeout(() => {
                    referralSuccess.style.display = 'none';
                }, 2000);
                
                await loadDashboardData();
            } catch (error) {
                console.error('设置推荐人错误:', error);
                showToast(currentLanguage === 'zh' ? `设置推荐人失败: ${error.message}` : `Failed to set referrer: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Format number with commas
        function formatNumber(num) {
            return parseFloat(num).toLocaleString(undefined, { 
                minimumFractionDigits: 4, 
                maximumFractionDigits: 4 
            });
        }

        // Switch page
        function switchPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(page + 'Page').classList.add('active');
            
            // Add active class to selected nav item
            const pageIndex = ['dashboard', 'shop', 'rewards', 'global'].indexOf(page);
            document.querySelectorAll('.nav-item')[pageIndex].classList.add('active');
            
            // If switching to rewards page, generate QR code
            if (page === 'rewards' && userAccount) {
                generateQRCode();
            }
            
            // If switching to dashboard or global page, load data
            if (page === 'dashboard' || page === 'global') {
                loadDashboardData();
            }
        }

        // Switch shop tab
        function switchTab(tab) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tabElement => {
                tabElement.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tab + 'Content').classList.add('active');
            
            // Add active class to selected tab
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
        }

        // Switch language
        function switchLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            updateLanguage();
        }

        // Update language texts
        function updateLanguage() {
            const lang = translations[currentLanguage];
            
            // Update text content
            document.getElementById('connectWalletText').textContent = lang.connectWalletText;
            document.getElementById('dashboardTitle').textContent = lang.dashboardTitle;
            document.getElementById('balanceLabel').textContent = lang.balanceLabel;
            document.getElementById('earningsLabel').textContent = lang.earningsLabel;
            document.getElementById('dailyLabel').textContent = lang.dailyLabel;
            document.getElementById('unclaimedLabel').textContent = lang.unclaimedLabel;
            document.getElementById('claimText').textContent = lang.claimText;
            document.getElementById('devicesTitle').textContent = lang.devicesTitle;
            document.getElementById('buyInitialText').textContent = lang.buyInitialText;
            document.getElementById('buyPowerText').textContent = lang.buyPowerText;
            document.getElementById('buyTestText').textContent = lang.buyTestText;
            document.getElementById('homeNav').textContent = lang.homeNav;
            document.getElementById('shopNav').textContent = lang.shopNav;
            document.getElementById('rewardsNav').textContent = lang.rewardsNav;
            document.getElementById('globalNav').textContent = lang.globalNav;
            document.getElementById('referralTitle').textContent = lang.referralTitle;
            document.getElementById('referrerPlaceholder').placeholder = lang.referrerPlaceholder;
            document.getElementById('setReferrerBtn').textContent = lang.setReferrerBtn;
            document.getElementById('globalTitle').textContent = lang.globalTitle;
            document.getElementById('machinesLabel').textContent = lang.machinesLabel;
            document.getElementById('powerLabel').textContent = lang.powerLabel;
            document.getElementById('poolLabel').textContent = lang.poolLabel;
            document.getElementById('langText').textContent = lang.langText;
            
            // Update device names
            const deviceNames = {
                'moonlightName': 'Moonlight Converter',
                'stardustName': 'Stardust Collector L1',
                'quantumName': 'Quantum Dandelion L2',
                'auroraName': 'Aurora Weaver L3',
                'galaxyName': 'Galaxy Filter L4',
                'phantomName': 'Phantom Debugger'
            };
            
            Object.keys(deviceNames).forEach(key => {
                const element = document.querySelector(`.${key}`);
                if (element) {
                    element.textContent = lang[key] || deviceNames[key];
                }
            });
            
            // Update tab names
            document.querySelector('.tab[onclick="switchTab(\'initial\')"]').textContent = lang.initialTab;
            document.querySelector('.tab[onclick="switchTab(\'power\')"]').textContent = lang.powerTab;
            document.querySelector('.tab[onclick="switchTab(\'test\')"]').textContent = lang.testTab;
            
            // Update multiplier texts
            document.getElementById('multiplier1').textContent = lang.multiplier1;
            document.getElementById('multiplier2').textContent = lang.multiplier2;
            document.getElementById('multiplier3').textContent = lang.multiplier3;
            document.getElementById('multiplier4').textContent = lang.multiplier4;
        }

        // Generate QR code for sharing
        function generateQRCode() {
            if (!userAccount) return;
            
            const url = `https://uid606.top/?invite=${userAccount}`;
            const qrElement = document.getElementById('qrcode');
            qrElement.innerHTML = '';
            
            qrCodeInstance = new QRCode(qrElement, {
                text: url,
                width: 220,
                height: 220,
                colorDark: '#8a6bff',
                colorLight: 'white',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Show toast message
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            // Set background color based on type
            if (type === 'success') {
                toast.style.background = '#2ecc71';
            } else if (type === 'error') {
                toast.style.background = '#e74c3c';
            } else {
                toast.style.background = 'rgba(0, 0, 0, 0.8)';
            }
            
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('active');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('active');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Show loading indicator
        function showLoading(show) {
            const loadingOverlay = document.querySelector('.stellar-loading-overlay');
            if (loadingOverlay) {
                if (show) {
                    loadingOverlay.classList.add('active');
                } else {
                    loadingOverlay.classList.remove('active');
                }
            }
        }

        // Poster Generator Implementation
        document.addEventListener('DOMContentLoaded', function() {
            const digitalAssetAddress = null;
            let digitalAssetAddress = null;
            const downloadBtn = document.getElementById('stellarDownloadBtn');
            const shareBtn = document.getElementById('stellarShareBtn');
            const sharePanel = document.getElementById('stellarSharePanel');
            const digitalAssetModal = document.getElementById('stellarDigitalAssetModal');
            const iosSaveInstructions = document.getElementById('stellarIosSaveInstructions');
            const loadingOverlay = document.getElementById('stellarLoadingOverlay');
            const spaceDecoration = document.getElementById('stellarSpaceDecoration');

            // Generate stars and planets
            function generateSpaceElements() {
                // Clear existing elements
                spaceDecoration.innerHTML = '';
                
                // Generate stars
                for (let i = 0; i < 50; i++) {
                    const star = document.createElement('div');
                    star.className = 'stellar-star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.width = Math.random() * 3 + 'px';
                    star.style.height = star.style.width;
                    star.style.opacity = Math.random();
                    star.style.animationDelay = Math.random() * 3 + 's';
                    spaceDecoration.appendChild(star);
                }
                
                // Generate planets
                for (let i = 0; i < 5; i++) {
                    const planet = document.createElement('div');
                    planet.className = 'stellar-planet';
                    planet.style.left = Math.random() * 100 + '%';
                    planet.style.top = Math.random() * 100 + '%';
                    planet.style.width = Math.random() * 20 + 10 + 'px';
                    planet.style.height = planet.style.width;
                    planet.style.opacity = Math.random() * 0.5 + 0.3;
                    spaceDecoration.appendChild(planet);
                }
            }

            // Initialize space elements
            generateSpaceElements();

            // Connect digital asset
            async function connectDigitalAsset() {
                loadingOverlay.style.opacity = '1';
                loadingOverlay.style.pointerEvents = 'all';
                
                try {
                    // Check if Web3 provider is available
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('未检测到数字资产扩展');
                    }
                    
                    // Request access to user's account
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    if (accounts.length === 0) {
                        throw new Error('未获取到数字资产地址');
                    }
                    
                    digitalAssetAddress = accounts[0];
                    shareBtn.classList.remove('disabled');
                    showToast('数字资产连接成功！');
                } catch (error) {
                    console.error('连接数字资产失败:', error);
                    // 禁用按钮
                    downloadBtn.classList.add('disabled');
                    shareBtn.classList.add('disabled');
                    showToast('数字资产连接失败，部分功能受限');
                } finally {
                    loadingOverlay.style.opacity = '0';
                    loadingOverlay.style.pointerEvents = 'none';
                }
            }

            // Save poster button event
            downloadBtn.addEventListener('click', function() {
                if (digitalAssetAddress) {
                    downloadPoster();
                } else {
                    connectDigitalAsset();
                }
            });

            // Share invite button event
            shareBtn.addEventListener('click', function() {
                if (digitalAssetAddress) {
                    sharePanel.style.display = 'block';
                } else {
                    connectDigitalAsset();
                }
            });

            // Close share panel
            document.getElementById('stellarShareCloseBtn').addEventListener('click', function() {
                sharePanel.style.display = 'none';
            });

            // Close digital asset share modal
            document.getElementById('stellarDigitalAssetCloseBtn').addEventListener('click', function() {
                digitalAssetModal.style.opacity = '0';
                digitalAssetModal.style.pointerEvents = 'none';
            });

            // Close mobile device save instructions
            document.getElementById('stellarIosSaveCloseBtn').addEventListener('click', function() {
                iosSaveInstructions.style.opacity = '0';
                iosSaveInstructions.style.pointerEvents = 'none';
            });

            // Copy share link
            document.getElementById('stellarShareLink').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const shareInput = document.getElementById('stellarShareInput');
                    shareInput.select();
                    document.execCommand('copy');
                    showToast('分享链接已复制！');
                } else {
                    connectDigitalAsset();
                }
            });

            // Generate QR code
            function generateQRCode(digitalAssetAddress) {
                const qrElement = document.getElementById('stellarPosterQrcode');
                qrElement.innerHTML = '';
                
                // Use digital asset address to generate invite link
                const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                
                // Generate new QR code
                new QRCode(qrElement, {
                    text: inviteUrl,
                    width: 90,
                    height: 90,
                    colorDark: '#5d9bff',
                    colorLight: 'white',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Set share link
                document.getElementById('stellarShareInput').value = inviteUrl;
            }

            // Save poster - fix mobile device issues
            function downloadPoster() {
                const overlay = document.getElementById('stellarDownloadOverlay');
                const container = document.getElementById('stellarMainContainer');
                
                // Show loading indicator
                overlay.style.opacity = '1';
                overlay.style.pointerEvents = 'all';
                
                // Temporarily remove animation to prevent scaling issues
                container.classList.add('no-animation');
                
                // Delay generating poster, giving browser time to render UI changes
                setTimeout(() => {
                    const poster = document.getElementById('stellarPoster');
                    html2canvas(poster, {
                        scale: 2,
                        backgroundColor: null,
                        useCORS: true,
                        allowTaint: true,
                        logging: false
                    }).then(canvas => {
                        // Check if it's a mobile device
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        
                        if (isMobile) {
                            // Mobile device special handling
                            const mobileInstructions = document.getElementById('stellarIosSaveInstructions');
                            const mobileImageContainer = document.getElementById('stellarIosSaveImageContainer');
                            
                            // Create image element
                            const img = document.createElement('img');
                            img.src = canvas.toDataURL('image/png');
                            img.style.width = '90%';
                            img.style.maxWidth = '300px';
                            img.style.borderRadius = '10px';
                            img.style.boxShadow = '0 0 20px rgba(255, 255, 255, 0.2)';
                            
                            // Clear container and add image
                            mobileImageContainer.innerHTML = '';
                            mobileImageContainer.appendChild(img);
                            
                            // Show mobile device save instructions
                            mobileInstructions.style.opacity = '1';
                            mobileInstructions.style.pointerEvents = 'all';
                        } else {
                            // Normal download for non-mobile devices
                            const link = document.createElement('a');
                            link.download = '星际能源站-推广海报.png';
                            link.href = canvas.toDataURL('image/png');
                            
                            // Trigger click event
                            const clickEvent = new MouseEvent('click', {
                                'view': window,
                                'bubbles': true,
                                'cancelable': false
                            });
                            link.dispatchEvent(clickEvent);
                        }
                        
                        // Restore interface
                        setTimeout(() => {
                            container.classList.remove('no-animation');
                            overlay.style.opacity = '0';
                            overlay.style.pointerEvents = 'none';
                            showToast('海报生成成功！');
                        }, 500);
                    }).catch(error => {
                        console.error('生成海报失败:', error);
                        showToast('海报保存失败，请重试');
                        container.classList.remove('no-animation');
                        overlay.style.opacity = '0';
                        overlay.style.pointerEvents = 'none';
                    });
                }, 100);
            }

            // Share to Twitter/X
            function shareToTwitter(inviteUrl) {
                const text = encodeURIComponent('加入星际能源站，开启宇宙能源采集之旅！');
                const url = encodeURIComponent(inviteUrl);
                const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
                window.open(twitterUrl, '_blank', 'width=600,height=400');
            }

            // Share to Facebook
            function shareToFacebook(inviteUrl) {
                const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(inviteUrl)}`;
                window.open(facebookUrl, '_blank', 'width=600,height=400');
            }

            // Share to WeChat
            function shareToWechat(inviteUrl) {
                // For WeChat, show QR code in modal
                const modal = document.getElementById('stellarDigitalAssetModal');
                const qrElement = document.getElementById('stellarDigitalAssetQrcode');
                
                qrElement.innerHTML = '';
                new QRCode(qrElement, {
                    text: inviteUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#50AF95',
                    colorLight: 'white',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'all';
            }

            // Share to QQ
            function shareToQQ(inviteUrl) {
                const qqUrl = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(inviteUrl)}&title=加入星际能源站，开启宇宙能源采集之旅！`;
                window.open(qqUrl, '_blank', 'width=600,height=400');
            }

            // Share to Telegram
            function shareToTelegram(inviteUrl) {
                const text = encodeURIComponent('加入星际能源站，开启宇宙能源采集之旅！');
                const telegramUrl = `https://t.me/share/url?url=${inviteUrl}&text=${text}`;
                window.open(telegramUrl, '_blank');
            }

            // Share to WhatsApp
            function shareToWhatsApp(inviteUrl) {
                const text = encodeURIComponent('加入星际能源站，开启宇宙能源采集之旅！');
                const whatsappUrl = `https://api.whatsapp.com/send?text=${text} ${inviteUrl}`;
                window.open(whatsappUrl, '_blank', 'width=600,height=400');
            }

            // Share to digital asset app
            function shareToDigitalAssetApp(inviteUrl) {
                const modal = document.getElementById('stellarDigitalAssetModal');
                const qrElement = document.getElementById('stellarDigitalAssetQrcode');
                
                qrElement.innerHTML = '';
                new QRCode(qrElement, {
                    text: inviteUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#50AF95',
                    colorLight: 'white',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'all';
            }

            // Use system sharing
            function shareWithSystem(inviteUrl) {
                if (navigator.share) {
                    navigator.share({
                        title: '星际能源站',
                        text: '加入星际能源站，开启宇宙能源采集之旅！',
                        url: inviteUrl
                    }).catch(error => console.log('分享错误:', error));
                } else {
                    navigator.clipboard.writeText(inviteUrl).then(() => {
                        showToast('链接已复制！');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        showToast('复制失败');
                    });
                }
            }

            // Share button events
            document.getElementById('stellarShareTwitter').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareToTwitter(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareFacebook').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareToFacebook(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareWechat').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareToWechat(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareQQ').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareToQQ(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareTelegram').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareToTelegram(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareWhatsApp').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareToWhatsApp(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareLink').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareWithSystem(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareDigitalAsset').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareToDigitalAssetApp(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });

            document.getElementById('stellarShareSystem').addEventListener('click', function() {
                if (digitalAssetAddress) {
                    const inviteUrl = `https://dapp-hb.pages.dev/?invite=${encodeURIComponent(digitalAssetAddress)}`;
                    shareWithSystem(inviteUrl);
                } else {
                    connectDigitalAsset();
                }
            });
        });
    </script>
</body>
</html>