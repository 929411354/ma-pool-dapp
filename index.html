<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mining DApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.8/dist/web3modal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.4.0/dist/ethers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Mining DApp</h1>

        <!-- 钱包连接按钮 -->
        <button id="connectButton" onclick="connectWallet()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg">
            连接钱包
        </button>

        <!-- 钱包地址显示 -->
        <p id="walletAddress" class="mt-4 text-gray-400">未连接</p>
    </div>

    <script>
        const web3Modal = new Web3Modal({
            cacheProvider: true,
            providerOptions: {} // 可配置更多钱包选项
        });

        function detectWallet() {
            if (window.ethereum) {
                console.log("钱包已注入");
                return true;
            } else if (window.web3) {
                console.log("旧版钱包已注入");
                return true;
            } else {
                console.warn("未检测到钱包，请使用 dApp 浏览器打开此页面。");
                return false;
            }
        }

        async function connectWallet() {
            if (!detectWallet()) {
                alert("请使用支持以太坊的钱包打开此页面！");
                return;
            }

            try {
                const provider = await web3Modal.connect();
                const signer = new ethers.providers.Web3Provider(provider).getSigner();
                const address = await signer.getAddress();
                document.getElementById('walletAddress').textContent = address;
                enableDAppFeatures();
            } catch (error) {
                console.error("钱包连接失败:", error);
                alert("钱包连接失败，请检查钱包是否已安装或网络是否正常。");
            }
        }

        function enableDAppFeatures() {
            document.querySelectorAll('[disabled]').forEach(el => el.removeAttribute('disabled'));
        }

        function disableDAppFeatures() {
            document.querySelectorAll('.dapp-feature').forEach(el => el.setAttribute('disabled', true));
        }

        // 页面加载时检测钱包并自动连接
        window.addEventListener('DOMContentLoaded', () => {
            const connectButton = document.getElementById('connectButton');
            const hasWallet = detectWallet();
            connectButton.disabled = !hasWallet;
            if (hasWallet && web3Modal.cachedProvider) {
                connectWallet();
            }

            // 监听钱包断开
            if (window.ethereum) {
                window.ethereum.on('disconnect', () => {
                    alert("钱包已断开，请重新连接。");
                    document.getElementById('walletAddress').textContent = "未连接";
                    disableDAppFeatures();
                });
            }
        });

        // 修复移动端点击延迟
        document.addEventListener('DOMContentLoaded', function () {
            FastClick.attach(document.body);
        }, false);
    </script>
</body>
</html>