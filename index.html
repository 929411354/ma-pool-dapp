<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>StarCatcher DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        :root{--deep:#0d0d2b;--purple:#6f42c1;--sky:#00d4ff;--pink:#ff2c93;--card:#1a1a40}
        html,body{margin:0;height:100%;font-size:16px;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",Arial;color:#fff;background:linear-gradient(135deg,var(--deep),#1a1a40)}
        .screen{display:none;flex:1;flex-direction:column;padding:16px}.screen.active{display:flex}
        header{position:sticky;top:0;z-index:9;background:#00000033;backdrop-filter:blur(8px);padding:12px 16px;display:flex;justify-content:space-between;font-size:16px}
        button{border:none;border-radius:12px;padding:14px 24px;background:linear-gradient(135deg,var(--purple),var(--sky));color:#fff;font-size:18px;font-weight:600;cursor:pointer;margin:8px 0}
        .bottom-bar{position:fixed;bottom:0;left:0;right:0;display:flex;background:#1a1a40;border-top:1px solid #ffffff22}
        .bottom-bar button{flex:1;border-radius:0;background:transparent;color:#fff;font-size:16px;padding:12px 0}
        .card{background:#1a1a40;border-radius:12px;padding:16px;margin-bottom:16px}
        #toast{position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);padding:12px 20px;border-radius:12px;color:#fff;font-weight:600;z-index:999;opacity:0;transition:.3s}
        #toast.success{background:#00c851} #toast.error{background:#ff2c93}
        input{width:100%;padding:12px;border-radius:12px;border:1px solid #666;background:transparent;color:#fff;margin-bottom:12px}
    </style>
</head>
<body>

<!-- 连接页 -->
<div id="screen-connect" class="screen active">
    <div style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center">
        <h1 data-en="Collect Stars, Earn Rewards" data-zh="收集星光，收获奖励">收集星光，收获奖励</h1>
        <p data-en="Connect TP Wallet" data-zh="连接 TP 钱包">连接 TP 钱包开始探索区块链宇宙</p>
        <button onclick="connectWallet()"><span data-en="Connect TP Wallet" data-zh="连接 TP 钱包">连接 TP 钱包</span></button>
        <small style="margin-top:12px;opacity:.7" data-en="Make sure BSC network" data-zh="请确保已切换至 BSC 网络">请确保已切换至 BSC 网络</small>
    </div>
</div>

<!-- 仪表盘 -->
<div id="screen-dashboard" class="screen">
    <div class="card"><h3 data-en="Assets" data-zh="资产概览">资产概览</h3>
        <p><span data-en="Reward Token" data-zh="奖励代币">奖励代币</span>：<span id="val-rewardToken">-</span></p>
        <p><span data-en="Total Earned" data-zh="累计收益">累计收益</span>：<span id="val-earned">-</span></p>
        <button onclick="claimRewards()"><span data-en="Claim" data-zh="领取收益">领取收益</span></button>
    </div>
    <div class="card"><h3 data-en="Devices" data-zh="我的设备">我的设备</h3>
        <p><span data-en="Moon Converter" data-zh="月光转换器">月光转换器</span>：<span id="normalCount">-</span> 台</p>
        <p><span data-en="Stardust L1" data-zh="星尘收集器L1">星尘收集器L1</span>：<span id="p0">-</span> 台</p>
        <p><span data-en="Quantum L2" data-zh="量子蒲公英L2">量子蒲公英L2</span>：<span id="p1">-</span> 台</p>
        <p><span data-en="Aurora L3" data-zh="极光编织机L3">极光编织机L3</span>：<span id="p2">-</span> 台</p>
        <p><span data-en="Galaxy L4" data-zh="银河过滤器L4">银河过滤器L4</span>：<span id="p3">-</span> 台</p>
        <p><span data-en="Total Power" data-zh="总算力">总算力</span>：<span id="val-totalPower">-</span></p>
    </div>
    <div class="card"><h3 data-en="Profit" data-zh="收益详情">收益详情</h3>
        <p><span data-en="Daily Est." data-zh="今日预计">今日预计</span>：<span id="val-daily">-</span></p>
        <p><span data-en="Unclaimed" data-zh="未领取">未领取</span>：<span id="val-unclaimed">-</span></p>
    </div>
</div>

<!-- 商店 -->
<div id="screen-shop" class="screen">
    <div class="card"><h3 data-en="Initial Device" data-zh="初始设备">初始设备</h3><button onclick="buyInitial()"><span data-en="Buy Moon Converter 1 (0.01 BNB)" data-zh="购买月光转换器 1 台（0.01 BNB）">购买月光转换器 1 台（0.01 BNB）</span></button></div>
    <div class="card"><h3 data-en="Advanced Device" data-zh="进阶设备">进阶设备</h3>
        <button onclick="buyPower(0)"><span data-en="Stardust L1 1 (100 token)" data-zh="星尘收集器L1 1 台（100 代币）">星尘收集器L1 1 台（100 代币）</span></button>
        <button onclick="buyPower(1)"><span data-en="Quantum L2 1 (200 token)" data-zh="量子蒲公英L2 1 台（200 代币）">量子蒲公英L2 1 台（200 代币）</span></button>
        <button onclick="buyPower(2)"><span data-en="Aurora L3 1 (300 token)" data-zh="极光编织机L3 1 台（300 代币）">极光编织机L3 1 台（300 代币）</span></button>
        <button onclick="buyPower(3)"><span data-en="Galaxy L4 1 (500 token)" data-zh="银河过滤器L4 1 台（500 代币）">银河过滤器L4 1 台（500 代币）</span></button>
    </div>
    <div class="card"><h3 data-en="Test Device" data-zh="测试设备">测试设备</h3><button id="btn-test" onclick="buyTest()"><span data-en="Buy Phantom Debugger 1 (0.0001 BNB)" data-zh="幻影调试器 1 台（0.0001 BNB）">幻影调试器 1 台（0.0001 BNB）</span></button></div>
</div>

<!-- 推荐 -->
<div id="screen-referral" class="screen">
    <div class="card">
        <h3 data-en="Referral" data-zh="推荐体系">推荐体系</h3>
        <input id="referrerInput" placeholder="Referrer address / 推荐人地址">
        <button onclick="setReferrer()"><span data-en="Set Referrer" data-zh="设置推荐人">设置推荐人</span></button>
        <p><span data-en="Total Ref Reward" data-zh="累计推荐奖励">累计推荐奖励</span>：<span id="val-totalRef">-</span></p>
        <ul id="ref-list" style="padding-left:16px"></ul>
    </div>
</div>

<!-- 全网数据 -->
<div id="screen-global" class="screen">
    <div class="card">
        <h3 data-en="Global Stats" data-zh="全网数据">全网数据</h3>
        <p><span data-en="Total Devices" data-zh="总设备数">总设备数</span>：<span id="val-globalMachines">-</span></p>
        <p><span data-en="Network Power" data-zh="全网算力">全网算力</span>：<span id="val-globalPower">-</span></p>
        <p><span data-en="Pool Balance" data-zh="奖励池余额">奖励池余额</span>：<span id="val-pool">-</span></p>
        <p><span data-en="Daily Output" data-zh="今日全网产出">今日全网产出</span>：<span id="val-globalDaily">-</span></p>
        <p><span data-en="Current Block" data-zh="当前区块">当前区块</span>：<span id="val-block">-</span></p>
    </div>
</div>

<!-- 管理员面板 -->
<div id="screen-admin" class="screen">
    <div class="card">
        <h3 data-en="Admin Panel" data-zh="管理员面板">管理员面板</h3>
        <input id="adminAddr" placeholder="Address / 地址">
        <button onclick="addAdmin()"><span data-en="Add Admin" data-zh="添加管理员">添加管理员</span></button>
        <button onclick="removeAdmin()"><span data-en="Remove Admin" data-zh="移除管理员">移除管理员</span></button>
        <button onclick="addBlock()"><span data-en="Add to Blocklist" data-zh="加入黑名单">加入黑名单</span></button>
        <button onclick="removeBlock()"><span data-en="Remove from Blocklist" data-zh="移除黑名单">移除黑名单</span></button>
        <button onclick="pauseContract()"><span data-en="Pause Contract" data-zh="暂停合约">暂停合约</span></button>
        <button onclick="unpauseContract()"><span data-en="Unpause Contract" data-zh="恢复合约">恢复合约</span></button>
        <input id="withdrawAmount" placeholder="Amount / 提取代币数量">
        <button onclick="withdrawTokens()"><span data-en="Withdraw Tokens" data-zh="提取代币">提取代币</span></button>
        <button onclick="withdrawBNB()"><span data-en="Withdraw BNB" data-zh="提取BNB">提取BNB</span></button>
    </div>
</div>

<!-- 底部导航 -->
<div class="bottom-bar">
    <button onclick="toScreen('dashboard')" data-en="Dashboard" data-zh="仪表盘">仪表盘</button>
    <button onclick="toScreen('shop')" data-en="Shop" data-zh="商店">商店</button>
    <button onclick="toScreen('referral')" data-en="Referral" data-zh="推荐">推荐</button>
    <button onclick="toScreen('global')" data-en="Global" data-zh="全网">全网</button>
    <button onclick="toScreen('admin')" id="admin-tab-btn" style="display:none" data-en="Admin" data-zh="管理">管理</button>
</div>

<div id="toast"></div>

<script>
    /* =====  合约地址  ===== */
    const contractAddress="0x9dcced4ef738856d2c289d4116cd219c698b22ba";
    const tokenAddress="0x877f23dcFBa91cadd7d35565Da452c9673C27A33";
    let web3,accounts=[],contract,tokenContract;

    /* =====  精简 ABI  ===== */
    const contractABI=[{"inputs":[],"name":"INITIAL_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TEST_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"addAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"admin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tierId","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"name":"buyPowerMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyTestMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserDashboard","outputs":[{"internalType":"uint256","name":"normal","type":"uint256"},{"internalType":"uint256","name":"test","type":"uint256"},{"internalType":"uint256[4]","name":"power","type":"uint256[4]"},{"internalType":"uint256","name":"dailyReward","type":"uint256"},{"internalType":"uint256","name":"unclaimed","type":"uint256"},{"internalType":"uint256","name":"totalRefReward","type":"uint256"},{"internalType":"uint256","name":"totalPower","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGlobalDashboard","outputs":[{"internalType":"uint256","name":"baseReward","type":"uint256"},{"internalType":"uint256","name":"totalMines","type":"uint256"},{"internalType":"uint256","name":"currentBlock","type":"uint256"},{"internalType":"uint256","name":"poolBalance","type":"uint256"},{"internalType":"uint256","name":"networkPower","type":"uint256"},{"internalType":"uint256","name":"dailyProduction","type":"uint256"},{"internalType":"uint256","name":"totalRefRewards","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"machineTiers","outputs":[{"internalType":"uint256","name":"priceToken","type":"uint256"},{"internalType":"uint256","name":"powerMultiplier","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"removeAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"removeFromBlocklist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"setReferrer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawTokens","outputs":[],"stateMutability":"nonpayable","type":"function"}];
    const tokenABI=[{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

    /* =====  语言切换 ===== */
    let lang = "zh";
    function t(key){
        const map = {
            en:{
                connect:"Connect TP Wallet",
                shop:"Shop",
                dashboard:"Dashboard",
                referral:"Referral",
                global:"Global",
                admin:"Admin",
                title:"Collect Stars, Earn Rewards",
                subtitle:"Connect TP Wallet to explore the blockchain universe",
                connectBtn:"Connect TP Wallet",
                hint:"Make sure BSC network",
                rewardToken:"Reward Token",
                earned:"Total Earned",
                claim:"Claim",
                devices:"Devices",
                moon:"Moon Converter",
                l1:"Stardust L1",
                l2:"Quantum L2",
                l3:"Aurora L3",
                l4:"Galaxy L4",
                power:"Total Power",
                daily:"Daily Est.",
                unclaimed:"Unclaimed",
                buyMoon:"Buy Moon Converter 1 (0.01 BNB)",
                buyL1:"Buy Stardust L1 1 (100 token)",
                buyL2:"Buy Quantum L2 1 (200 token)",
                buyL3:"Buy Aurora L3 1 (300 token)",
                buyL4:"Buy Galaxy L4 1 (500 token)",
                buyTest:"Buy Phantom Debugger 1 (0.0001 BNB)",
                referralTitle:"Referral System",
                setRef:"Set Referrer",
                totalRef:"Total Referral Reward",
                globalTitle:"Global Stats",
                totalDevices:"Total Devices",
                networkPower:"Network Power",
                poolBalance:"Pool Balance",
                dailyOutput:"Daily Output",
                currentBlock:"Current Block",
                adminTitle:"Admin Panel",
                addr:"Address",
                addAdmin:"Add Admin",
                removeAdmin:"Remove Admin",
                addBlock:"Add to Blocklist",
                removeBlock:"Remove from Blocklist",
                pause:"Pause Contract",
                unpause:"Unpause Contract",
                withdrawToken:"Withdraw Tokens",
                withdrawBNB:"Withdraw BNB"
            },
            zh:{
                connect:"连接 TP 钱包",
                shop:"商店",
                dashboard:"仪表盘",
                referral:"推荐",
                global:"全网",
                admin:"管理",
                title:"收集星光，收获奖励",
                subtitle:"连接 TP 钱包开始探索区块链宇宙",
                connectBtn:"连接 TP 钱包",
                hint:"请确保已切换至 BSC 网络",
                rewardToken:"奖励代币",
                earned:"累计收益",
                claim:"领取收益",
                devices:"我的设备",
                moon:"月光转换器",
                l1:"星尘收集器L1",
                l2:"量子蒲公英L2",
                l3:"极光编织机L3",
                l4:"银河过滤器L4",
                power:"总算力",
                daily:"今日预计",
                unclaimed:"未领取",
                buyMoon:"购买月光转换器 1 台（0.01 BNB）",
                buyL1:"星尘收集器L1 1 台（100 代币）",
                buyL2:"量子蒲公英L2 1 台（200 代币）",
                buyL3:"极光编织机L3 1 台（300 代币）",
                buyL4:"银河过滤器L4 1 台（500 代币）",
                buyTest:"幻影调试器 1 台（0.0001 BNB）",
                referralTitle:"推荐体系",
                setRef:"设置推荐人",
                totalRef:"累计推荐奖励",
                globalTitle:"全网数据",
                totalDevices:"总设备数",
                networkPower:"全网算力",
                poolBalance:"奖励池余额",
                dailyOutput:"今日全网产出",
                currentBlock:"当前区块",
                adminTitle:"管理员面板",
                addr:"地址",
                addAdmin:"添加管理员",
                removeAdmin:"移除管理员",
                addBlock:"加入黑名单",
                removeBlock:"移除黑名单",
                pause:"暂停合约",
                unpause:"恢复合约",
                withdrawToken:"提取代币",
                withdrawBNB:"提取BNB"
            }
        };
        return map[lang][key] || key;
    }
    function toggleLang(){
        lang = lang==='en'?'zh':'en';
        document.querySelectorAll('[data-en][data-zh]').forEach(el=>{
            el.innerText = t(el.dataset[lang]);
        });
    }

    /* =====  连接钱包（TP 专用）  ===== */
    async function connectWallet(){
        if(!window.ethereum){
            toast(t("hint"),true);
            return;
        }
        web3=new Web3(window.ethereum);
        try{
            accounts=await window.ethereum.request({method:'eth_requestAccounts'});
            contract=new web3.eth.Contract(contractABI,contractAddress);
            tokenContract=new web3.eth.Contract(tokenABI,tokenAddress);
            await tokenContract.methods.approve(contractAddress,"0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff").send({from:accounts[0]});
            document.getElementById('shortAddr').innerText=accounts[0].slice(0,6)+'...'+accounts[0].slice(-4);
            toScreen('dashboard');
        }catch(e){
            toast(e.message.includes('User denied')? "用户已取消" : "连接失败："+e.message,true);
        }
    }

    /* =====  页面切换  ===== */
    function toScreen(name){
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.getElementById('screen-'+name).classList.add('active');
        loadAll();
    }

    /* =====  数据刷新  ===== */
    async function loadAll(){
        if(!contract)return;
        const [user,global,bal,decimals]=await Promise.all([
            contract.methods.getUserDashboard(accounts[0]).call(),
            contract.methods.getGlobalDashboard().call(),
            tokenContract.methods.balanceOf(accounts[0]).call(),
            tokenContract.methods.decimals().call()
        ]);
        const factor=10**decimals;

        /* 仪表盘 */
        document.getElementById('val-rewardToken').innerText=(bal/factor).toFixed(2);
        document.getElementById('val-earned').innerText=(user.totalRefReward/factor).toFixed(2);
        document.getElementById('val-daily').innerText=(user.dailyReward/factor).toFixed(2);
        document.getElementById('val-unclaimed').innerText=(user.unclaimed/factor).toFixed(2);
        document.getElementById('normalCount').innerText=user.normal+' 台';
        document.getElementById('testCount').innerText=user.test+' 台';
        for(let i=0;i<4;i++)document.getElementById('p'+i).innerText=user.power[i]+' 台';
        document.getElementById('val-totalPower').innerText=(user.totalPower/1e18).toFixed(2);

        /* 全网 */
        document.getElementById('val-globalMachines').innerText=global.totalMines;
        document.getElementById('val-globalPower').innerText=(global.networkPower/1e18).toFixed(2);
        document.getElementById('val-pool').innerText=(global.poolBalance/factor).toFixed(2);
        document.getElementById('val-globalDaily').innerText=(global.dailyProduction/factor).toFixed(2);
        document.getElementById('val-block').innerText=global.currentBlock;

        /* 推荐中心 */
        document.getElementById('val-claimable').innerText=(user.unclaimed/factor).toFixed(2);
        document.getElementById('val-totalRef').innerText=(user.totalRefReward/factor).toFixed(2);

        /* 管理员可见 */
        const isAdmin=await contract.methods.admin(accounts[0]).call();
        const isOwner=accounts[0].toLowerCase()===(await contract.methods.owner().call()).toLowerCase();
        ['btn-test','admin-tab-btn'].forEach(id=>document.getElementById(id).style.display=isAdmin||isOwner?'':'none');
    }

    /* =====  功能调用  ===== */
    async function buyInitial(){
        const price=await contract.methods.INITIAL_MACHINE_PRICE_BNB().call();
        contract.methods.buyInitialMachine().send({from:accounts[0],value:price}).then(()=>{toast("购买成功");loadAll()}).catch(e=>toast("购买失败："+e.message,true));
    }
    async function buyPower(tier){
        const {priceToken}=await contract.methods.machineTiers(tier).call();
        contract.methods.buyPowerMachine(tier,1).send({from:accounts[0]}).then(()=>{toast("购买成功");loadAll()}).catch(e=>toast("购买失败："+e.message,true));
    }
    async function buyTest(){
        const price=await contract.methods.TEST_MACHINE_PRICE_BNB().call();
        contract.methods.buyTestMachine().send({from:accounts[0],value:price}).then(()=>{toast("购买成功");loadAll()}).catch(e=>toast("购买失败："+e.message,true));
    }
    async function claimRewards(){
        contract.methods.claimRewards().send({from:accounts[0]}).then(()=>{toast("领取成功");loadAll()}).catch(e=>toast("领取失败："+e.message,true));
    }
    async function setReferrer(){
        const addr=document.getElementById('referrerInput').value;
        if(!web3.utils.isAddress(addr))return toast("地址无效",true);
        contract.methods.setReferrer(addr).send({from:accounts[0]}).then(()=>{toast("设置成功");loadAll()}).catch(e=>toast("设置失败："+e.message,true));
    }

    /* =====  管理员功能  ===== */
    async function addAdmin(){
        const addr=document.getElementById('adminAddr').value;
        if(!web3.utils.isAddress(addr))return toast("地址无效",true);
        contract.methods.addAdmin(addr).send({from:accounts[0]}).then(()=>{toast("已添加");loadAll()}).catch(e=>toast("添加失败："+e.message,true));
    }
    async function removeAdmin(){
        const addr=document.getElementById('adminAddr').value;
        if(!web3.utils.isAddress(addr))return toast("地址无效",true);
        contract.methods.removeAdmin(addr).send({from:accounts[0]}).then(()=>{toast("已移除");loadAll()}).catch(e=>toast("移除失败："+e.message,true));
    }
    async function addBlock(){
        const addr=document.getElementById('adminAddr').value;
        if(!web3.utils.isAddress(addr))return toast("地址无效",true);
        contract.methods.addToBlocklist(addr).send({from:accounts[0]}).then(()=>{toast("已加入黑名单");loadAll()}).catch(e=>toast("操作失败："+e.message,true));
    }
    async function removeBlock(){
        const addr=document.getElementById('adminAddr').value;
        if(!web3.utils.isAddress(addr))return toast("地址无效",true);
        contract.methods.removeFromBlocklist(addr).send({from:accounts[0]}).then(()=>{toast("已移除黑名单");loadAll()}).catch(e=>toast("操作失败："+e.message,true));
    }
    async function pauseContract(){
        contract.methods.pause().send({from:accounts[0]}).then(()=>{toast("已暂停");loadAll()}).catch(e=>toast("暂停失败："+e.message,true));
    }
    async function unpauseContract(){
        contract.methods.unpause().send({from:accounts[0]}).then(()=>{toast("已恢复");loadAll()}).catch(e=>toast("恢复失败："+e.message,true));
    }
    async function withdrawTokens(){
        const amt=document.getElementById('withdrawAmount').value;
        if(!amt)return toast("请输入数量",true);
        const val=web3.utils.toWei(amt,18);
        contract.methods.withdrawTokens(val).send({from:accounts[0]}).then(()=>{toast("提取成功");loadAll()}).catch(e=>toast("提取失败："+e.message,true));
    }
    async function withdrawBNB(){
        contract.methods.withdrawBNB().send({from:accounts[0]}).then(()=>{toast("提取BNB成功");loadAll()}).catch(e=>toast("提取BNB失败："+e.message,true));
    }

    /* =====  工具  ===== */
    function toast(msg,isErr=false){
        const el=document.getElementById('toast');
        el.innerText=msg;
        el.className=isErr?'error':'success';
        el.style.opacity=1;
        setTimeout(()=>el.style.opacity=0,2000);
    }

    /* =====  加载后自动渲染中文 ===== */
    window.onload = () => {
        lang = "zh";  // 默认中文
        document.querySelectorAll('[data-en][data-zh]').forEach(el=>{
            el.innerText = t(el.dataset[lang]);
        });
    };
</script>
</body>
</html>