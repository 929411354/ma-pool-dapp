<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>矿机商店 DApp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card-bg: rgba(30, 41, 59, 0.5);
      --accent: #3b82f6;
      --text: #e2e8f0;
      --radius: 16px;
      --shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .container{max-width:900px;width:100%;display:grid;gap:24px}
    .header{display:flex;align-items:center;justify-content:space-between;position:relative}
    .header h1{font-size:2.5rem;background:linear-gradient(90deg,#60a5fa,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:24px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(8px);box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}
    .stat{display:flex;align-items:center;gap:12px;font-size:1.1rem}
    .stat i{color:var(--accent)}
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius);font-weight:600;cursor:pointer;transition:.3s;background:var(--accent);color:#fff;z-index:100}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(59,130,246,0.5)}
    .input-group{display:flex;flex-direction:column;gap:8px}
    .input-group input{padding:12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.3);color:#fff}
    #langBtn{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:6px 12px;border-radius:var(--radius);cursor:pointer;margin-left:12px}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header: Title + Connect + Lang -->
    <div class="header">
      <h1><i class="fas fa-hammer"></i> <span id="titleTxt">矿机商店</span></h1>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="connectBtn" class="btn" onclick="connectWallet()"><i class="fas fa-wallet"></i> <span id="connectTxt">连接钱包</span></button>
        <button id="langBtn" onclick="toggleLang()">EN</button>
      </div>
    </div>

    <!-- Data -->
    <div class="card grid">
      <div class="stat"><i class="fas fa-user"></i> <span id="walletAddr">--</span></div>
      <div class="stat"><i class="fas fa-cog"></i> <span id="normalTxt">普通矿机</span>: <span id="statNormal">0</span></div>
      <div class="stat"><i class="fas fa-flask"></i> <span id="testTxt">测试矿机</span>: <span id="statTest">0</span></div>
      <div class="stat"><i class="fas fa-rocket"></i> <span id="powerTxt">增强矿机</span>: <span id="statPower">0</span></div>
      <div class="stat"><i class="fas fa-calendar"></i> <span id="dailyTxt">日产量</span>: <span id="statDaily">0</span> α</div>
      <div class="stat"><i class="fas fa-gift"></i> <span id="unclaimedTxt">未领取</span>: <span id="statUnclaimed">0</span> α</div>
    </div>

    <!-- Buy -->
    <div class="card grid">
      <button class="btn" onclick="buyInitialMachine()"><i class="fas fa-plus"></i> <span id="buyInitialTxt">初始矿机 (0.01 BNB)</span></button>
      <button class="btn" onclick="buyTestMachine()"><i class="fas fa-plus"></i> <span id="buyTestTxt">测试矿机 (0.001 BNB)</span></button>
      <div class="input-group">
        <label><span id="tierTxt">增强等级</span> (0-3)</label><input id="tierId" placeholder="0"/>
        <label><span id="countTxt">数量</span></label><input id="count" placeholder="1"/>
        <button class="btn" onclick="buyPowerMachine()"><i class="fas fa-plus"></i> <span id="buyPowerTxt">购买增强矿机</span></button>
      </div>
    </div>

    <!-- Refer & Claim -->
    <div class="card grid">
      <div class="input-group">
        <label><span id="referTxt">推荐人地址</span></label><input id="referrerInput" placeholder="0x..."/>
        <button class="btn" onclick="setReferrer()"><i class="fas fa-check"></i> <span id="setReferTxt">设置推荐人</span></button>
      </div>
      <button class="btn" onclick="claimRewards()"><i class="fas fa-gift"></i> <span id="claimTxt">领取收益</span></button>
    </div>

    <!-- Admin -->
    <div class="card" id="adminPanel" style="display:none;">
      <h2><i class="fas fa-cogs"></i> <span id="adminTitle">管理员面板</span></h2>
      <div class="input-group">
        <label><span id="withdrawTxt">提取代币数量</span></label><input id="withdrawAmount" placeholder="100"/>
        <button class="btn" onclick="withdrawBNB()"><i class="fas fa-coins"></i> <span id="withdrawBNBTxt">提取BNB</span></button>
        <button class="btn" onclick="withdrawTokens()"><i class="fas fa-coins"></i> <span id="withdrawTokensTxt">提取代币</span></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0x9dCcEd4Ef738856D2c289D4116cD219c698B22ba";
    const TOKEN_ADDRESS = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";
    const CONTRACT_ABI = [
      "function buyInitialMachine() payable",
      "function buyTestMachine() payable",
      "function buyPowerMachine(uint256,uint256)",
      "function setReferrer(address)",
      "function claimRewards()",
      "function withdrawBNB()",
      "function withdrawTokens(uint256)",
      "function admin(address) view returns(bool)",
      "function getUserDashboard(address) view returns(uint256,uint256,uint256[4],uint256,uint256,uint256,uint256)"
    ];

    const i18n = {
      zh: {
        title: "矿机商店", connect: "连接钱包", normal: "普通矿机", test: "测试矿机", power: "增强矿机", daily: "日产量", unclaimed: "未领取", walletAddr: "钱包地址", buyInitial: "初始矿机 (0.01 BNB)", buyTest: "测试矿机 (0.001 BNB)", buyPower: "购买增强矿机", tier: "增强等级", count: "数量", refer: "推荐人地址", setRefer: "设置推荐人", claim: "领取收益", adminTitle: "管理员面板", withdraw: "提取代币数量", withdrawBNB: "提取BNB", withdrawTokens: "提取代币"
      },
      en: {
        title: "Mining Shop", connect: "Connect Wallet", normal: "Normal Miner", test: "Test Miner", power: "Power Miner", daily: "Daily Yield", unclaimed: "Unclaimed", walletAddr: "Wallet Address", buyInitial: "Initial Miner (0.01 BNB)", buyTest: "Test Miner (0.001 BNB)", buyPower: "Buy Power Miner", tier: "Tier", count: "Count", refer: "Referrer Address", setRefer: "Set Referrer", claim: "Claim Rewards", adminTitle: "Admin Panel", withdraw: "Withdraw Amount", withdrawBNB: "Withdraw BNB", withdrawTokens: "Withdraw Tokens"
      }
    };

    let lang = "zh";
    let provider, signer, contract, userAddress;

    function t(key) {
      return i18n[lang][key] || key;
    }

    function applyLang() {
      Object.keys(i18n.zh).forEach(key => {
        const el = document.getElementById(key + "Txt");
        if (el) el.textContent = t(key);
      });
      document.getElementById("langBtn").textContent = lang === "zh" ? "EN" : "中";
    }

    function toggleLang() {
      lang = lang === "zh" ? "en" : "zh";
      applyLang();
    }

    async function connectWallet() {
      const prov = window.ethereum || window.tp || window.okexchain || window.bitkeep?.ethereum;
      if (!prov) return alert(t("connect"));

      try {
        await prov.request({ method: "eth_requestAccounts" });
        const chain = await prov.request({ method: "eth_chainId" });
        if (chain !== "0x38") return alert(lang === "zh" ? "请切换到 BSC 主网" : "Please switch to BSC Mainnet");

        provider = new ethers.providers.Web3Provider(prov);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        document.getElementById("walletAddr").textContent = userAddress.substring(0, 6) + "..." + userAddress.substring(38);
        document.getElementById("connectBtn").textContent = userAddress.substring(0, 6) + "...";

        const isAdmin = await contract.admin(userAddress);
        if (isAdmin) document.getElementById("adminPanel").style.display = "block";

        await loadUserData();
      } catch (err) {
        alert(t("connect") + ": " + err.message);
      }
    }

    async function loadUserData() {
      if (!contract) return;
      const data = await contract.getUserDashboard(userAddress);
      ["statNormal", "statTest", "statPower", "statDaily", "statUnclaimed", "statPowerTotal"].forEach((id, i) => {
        const val = id === "statPower" ? data.power.reduce((a, b) => a + Number(b), 0) : data[i];
        document.getElementById(id).textContent = id === "statDaily" || id === "statUnclaimed" ? ethers.utils.formatUnits(val) : val.toString();
      });
    }

    async function buyInitialMachine() {
      if (!signer) return alert(t("connect"));
      try {
        const balance = await provider.getBalance(userAddress);
        if (balance.lt(ethers.utils.parseEther("0.01"))) return alert(t("buyInitial") + " - " + (lang === "zh" ? "余额不足" : "Insufficient balance"));
        await contract.buyInitialMachine({ value: ethers.utils.parseEther("0.01") });
        alert(t("buyInitial") + " ✅");
        await loadUserData();
      } catch (err) {
        alert(t("buyInitial") + " ❌: " + err.message);
      }
    }

    async function buyTestMachine() {
      if (!signer) return alert(t("connect"));
      try {
        const balance = await provider.getBalance(userAddress);
        if (balance.lt(ethers.utils.parseEther("0.001"))) return alert(t("buyTest") + " - " + (lang === "zh" ? "余额不足" : "Insufficient balance"));
        await contract.buyTestMachine({ value: ethers.utils.parseEther("0.001") });
        alert(t("buyTest") + " ✅");
        await loadUserData();
      } catch (err) {
        alert(t("buyTest") + " ❌: " + err.message);
      }
    }

    async function buyPowerMachine() {
      if (!signer) return alert(t("connect"));
      const tierId = document.getElementById("tierId").value;
      const count = document.getElementById("count").value;
      if (!tierId || !count) return alert(t("tier") + " & " + t("count") + " " + (lang === "zh" ? "必填" : "required"));
      try {
        await contract.buyPowerMachine(tierId, count);
        alert(t("buyPower") + " ✅");
        await loadUserData();
      } catch (err) {
        alert(t("buyPower") + " ❌: " + err.message);
      }
    }

    async function setReferrer() {
      const ref = document.getElementById("referrerInput").value;
      if (!signer) return alert(t("connect"));
      if (!ethers.utils.isAddress(ref)) return alert(t("refer") + " " + (lang === "zh" ? "格式错误" : "invalid"));
      try {
        await contract.setReferrer(ref);
        alert(t("setRefer") + " ✅");
      } catch (err) {
        alert(t("setRefer") + " ❌: " + err.message);
      }
    }

    async function claimRewards() {
      if (!signer) return alert(t("connect"));
      try {
        await contract.claimRewards();
        alert(t("claim") + " ✅");
        await loadUserData();
      } catch (err) {
        alert(t("claim") + " ❌: " + err.message);
      }
    }

    async function withdrawBNB() {
      if (!signer) return alert(t("connect"));
      try {
        await contract.withdrawBNB();
        alert(t("withdrawBNB") + " ✅");
      } catch (err) {
        alert(t("withdrawBNB") + " ❌: " + err.message);
      }
    }

    async function withdrawTokens() {
      if (!signer) return alert(t("connect"));
      const amount = document.getElementById("withdrawAmount").value;
      if (!amount) return alert(t("withdraw") + " " + (lang === "zh" ? "必填" : "required"));
      try {
        await contract.withdrawTokens(ethers.utils.parseUnits(amount));
        alert(t("withdrawTokens") + " ✅");
      } catch (err) {
        alert(t("withdrawTokens") + " ❌: " + err.message);
      }
    }

    applyLang();
  </script>
</body>
</html>