<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Mining DApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.8/dist/web3modal.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white">
    <div id="app" class="container mx-auto p-4">
        <!-- Navigation -->
        <nav class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">Mining DApp</h1>
            <div class="flex gap-4">
                <button onclick="switchTab('dashboard')" class="tab-button">Dashboard</button>
                <button onclick="switchTab('buy')" class="tab-button">Buy Machines</button>
                <button onclick="switchTab('rewards')" class="tab-button">Rewards</button>
                <button onclick="switchTab('referrals')" class="tab-button">Referrals</button>
                <button onclick="switchTab('admin')" class="tab-button admin-tab" id="adminTab">Admin</button>
            </div>
        </nav>

        <!-- Wallet Status -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <p class="text-sm text-gray-400">Connected as:</p>
                <p id="walletAddress" class="text-green-400 font-mono truncate max-w-xs"></p>
            </div>
            <button onclick="connectWallet()" class="bg-gradient-to-r from-green-500 to-blue-600 px-4 py-2 rounded-lg hover:shadow-lg transition-all">
                Connect Wallet
            </button>
        </div>

        <!-- Content Tabs -->
        <div id="contentArea" class="space-y-8">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">Total Machines</h3>
                        <p id="totalMachines" class="text-2xl font-bold mt-2">0</p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">Network Power</h3>
                        <p id="networkPower" class="text-2xl font-bold mt-2">0</p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">Pool Balance</h3>
                        <p id="poolBalance" class="text-2xl font-bold mt-2">0 BNB</p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">Daily Production</h3>
                        <p id="dailyProduction" class="text-2xl font-bold mt-2">0 BNB</p>
                    </div>
                </div>
            </div>

            <!-- Buy Machines Tab -->
            <div id="buy" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-4 rounded-lg">
                        <h2 class="text-xl font-bold mb-4">Initial Machine</h2>
                        <p id="initialPrice" class="mb-4">Loading price...</p>
                        <button onclick="buyInitialMachine()" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg transition-all">
                            Buy Initial Machine
                        </button>
                    </div>
                    
                    <div class="glass-card p-4 rounded-lg">
                        <h2 class="text-xl font-bold mb-4">Test Machine</h2>
                        <p id="testPrice" class="mb-4">Loading price...</p>
                        <button onclick="buyTestMachine()" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg transition-all">
                            Buy Test Machine
                        </button>
                    </div>

                    <div class="glass-card p-4 rounded-lg col-span-full">
                        <h2 class="text-xl font-bold mb-4">Power Machines</h2>
                        <div class="mb-4">
                            <label class="block text-sm mb-2">Tier:</label>
                            <select id="tierId" class="w-full p-2 bg-gray-800 rounded-lg">
                                <option value="0">Tier 1</option>
                                <option value="1">Tier 2</option>
                                <option value="2">Tier 3</option>
                                <option value="3">Tier 4</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm mb-2">Quantity:</label>
                            <input type="number" id="count" min="1" max="10" value="1" class="w-full p-2 bg-gray-800 rounded-lg">
                        </div>
                        <button onclick="buyPowerMachine()" class="w-full bg-purple-600 hover:bg-purple-700 py-2 rounded-lg transition-all">
                            Buy Power Machine
                        </button>
                    </div>
                </div>
            </div>

            <!-- Rewards Tab -->
            <div id="rewards" class="tab-content hidden">
                <div class="glass-card p-6 rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Your Rewards</h2>
                    <div class="mb-6">
                        <p class="text-gray-400">Unclaimed Rewards:</p>
                        <p id="unclaimedRewards" class="text-3xl font-bold mt-2">0 BNB</p>
                    </div>
                    <button onclick="claimRewards()" class="bg-yellow-500 hover:bg-yellow-600 py-2 px-4 rounded-lg">
                        Claim Rewards
                    </button>
                </div>
            </div>

            <!-- Referrals Tab -->
            <div id="referrals" class="tab-content hidden">
                <div class="glass-card p-6 rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Referral System</h2>
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Set Referrer:</label>
                        <input type="text" id="referrerAddress" placeholder="Enter referrer address" class="w-full p-2 bg-gray-800 rounded-lg">
                    </div>
                    <button onclick="setReferrer()" class="bg-indigo-600 hover:bg-indigo-700 py-2 px-4 rounded-lg">
                        Set Referrer
                    </button>
                    <div id="referralStats" class="mt-6 text-gray-400"></div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="admin" class="tab-content hidden">
                <div class="glass-card p-6 rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Admin Functions</h2>
                    <div class="space-y-3">
                        <button onclick="addAdmin()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg">Add Admin</button>
                        <button onclick="removeAdmin()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg">Remove Admin</button>
                        <button onclick="addToBlocklist()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg">Add to Blocklist</button>
                        <button onclick="removeFromBlocklist()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg">Remove from Blocklist</button>
                        <button onclick="withdrawTokens()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg">Withdraw Tokens</button>
                        <button onclick="withdrawBNB()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg">Withdraw BNB</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        let web3Modal;
        let provider;
        let signer;
        let contract;
        let tokenContract;
        let userAddress;

        const contractAddress = "0x9dCcEd4Ef738856D2c289D4116cD219c698B22ba";
        const tokenAddress = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";

        const abi = [/* 全部ABI内容 */];

        // Initialize Web3Modal
        web3Modal = new Web3Modal.default({
            cacheProvider: false,
            providerOptions: {} // Add provider options if needed
        });

        async function connectWallet() {
            try {
                const instance = await web3Modal.connect();
                provider = new ethers.providers.Web3Provider(instance);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                contract = new ethers.Contract(contractAddress, abi, signer);
                tokenContract = new ethers.Contract(tokenAddress, [
                    "function approve(address spender, uint256 amount) public returns (bool)",
                    "function balanceOf(address account) public view returns (uint256)",
                    "function allowance(address owner, address spender) public view returns (uint256)"
                ], signer);

                document.getElementById("walletAddress").textContent = userAddress;
                loadDashboard();
                checkAdminStatus();
                alert("Connected successfully!");
            } catch (e) {
                console.error(e);
                alert("Failed to connect wallet. Please make sure MetaMask is installed and you're on the correct network.");
            }
        }

        async function loadDashboard() {
            try {
                const data = await contract.getGlobalDashboard();
                document.getElementById("totalMachines").textContent = data.totalMines;
                document.getElementById("networkPower").textContent = data.networkPower;
                document.getElementById("poolBalance").textContent = ethers.utils.formatEther(data.poolBalance) + " BNB";
                document.getElementById("dailyProduction").textContent = ethers.utils.formatEther(data.dailyProduction) + " BNB";
                
                const user = await contract.getUserDashboard(userAddress);
                document.getElementById("unclaimedRewards").textContent = ethers.utils.formatEther(user.unclaimed) + " BNB";
                
                const initialPrice = await contract.INITIAL_MACHINE_PRICE_BNB();
                document.getElementById("initialPrice").textContent = "Price: " + ethers.utils.formatEther(initialPrice) + " BNB";
                
                const testPrice = await contract.TEST_MACHINE_PRICE_BNB();
                document.getElementById("testPrice").textContent = "Price: " + ethers.utils.formatEther(testPrice) + " BNB";
            } catch (e) {
                console.error("Error loading dashboard:", e);
            }
        }

        async function buyInitialMachine() {
            try {
                const price = await contract.INITIAL_MACHINE_PRICE_BNB();
                const tx = await contract.buyInitialMachine({ value: price });
                await tx.wait();
                alert("Initial machine purchased!");
                loadDashboard();
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function buyTestMachine() {
            try {
                const price = await contract.TEST_MACHINE_PRICE_BNB();
                const tx = await contract.buyTestMachine({ value: price });
                await tx.wait();
                alert("Test machine purchased!");
                loadDashboard();
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function buyPowerMachine() {
            const tierId = document.getElementById("tierId").value;
            const count = parseInt(document.getElementById("count").value);
            
            try {
                const tierInfo = await contract.machineTiers(tierId);
                const totalPrice = tierInfo.priceToken.mul(count);
                
                const allowance = await tokenContract.allowance(userAddress, contractAddress);
                if (allowance.lt(totalPrice)) {
                    const approveTx = await tokenContract.approve(contractAddress, ethers.constants.MaxUint256);
                    await approveTx.wait();
                }
                
                const tx = await contract.buyPowerMachine(tierId, count);
                await tx.wait();
                alert(`Purchased <LaTex>${count} Tier $</LaTex>{parseInt(tierId)+1} machines!`);
                loadDashboard();
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function claimRewards() {
            try {
                const tx = await contract.claimRewards();
                await tx.wait();
                alert("Rewards claimed!");
                loadDashboard();
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function setReferrer() {
            const referrer = document.getElementById("referrerAddress").value;
            try {
                const tx = await contract.setReferrer(referrer);
                await tx.wait();
                alert("Referrer set successfully!");
                loadDashboard();
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function checkAdminStatus() {
            if (!contract || !userAddress) return;
            try {
                const isAdmin = await contract.admin(userAddress);
                document.getElementById("adminTab").classList.toggle("hidden", !isAdmin);
            } catch (e) {
                console.error(e);
            }
        }

        async function addAdmin() {
            const address = prompt("Enter admin address:");
            if (!address) return;
            try {
                const tx = await contract.addAdmin(address);
                await tx.wait();
                alert("Admin added!");
                checkAdminStatus();
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function removeAdmin() {
            const address = prompt("Enter admin address to remove:");
            if (!address) return;
            try {
                const tx = await contract.removeAdmin(address);
                await tx.wait();
                alert("Admin removed!");
                checkAdminStatus();
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function addToBlocklist() {
            const address = prompt("Enter address to block:");
            if (!address) return;
            try {
                const tx = await contract.addToBlocklist(address);
                await tx.wait();
                alert("Address added to blocklist!");
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function removeFromBlocklist() {
            const address = prompt("Enter address to unblock:");
            if (!address) return;
            try {
                const tx = await contract.removeFromBlocklist(address);
                await tx.wait();
                alert("Address removed from blocklist!");
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function withdrawTokens() {
            const amount = prompt("Enter amount to withdraw:");
            if (!amount) return;
            try {
                const tx = await contract.withdrawTokens(ethers.utils.parseEther(amount));
                await tx.wait();
                alert("Tokens withdrawn!");
            } catch (e) {
                handleTransactionError(e);
            }
        }

        async function withdrawBNB() {
            const amount = prompt("Enter BNB amount to withdraw:");
            if (!amount) return;
            try {
                const tx = await contract.withdrawBNB({ value: ethers.utils.parseEther(amount) });
                await tx.wait();
                alert("BNB withdrawn!");
            } catch (e) {
                handleTransactionError(e);
            }
        }

        function handleTransactionError(error) {
            console.error("Transaction error:", error);
            let message = "Transaction failed. ";
            
            if (error.code === 4001) {
                message += "User rejected transaction.";
            } else if (error.code === -32000) {
                message += "Invalid input parameters.";
            } else if (error.code === -32603) {
                message += "Contract execution error.";
            } else if (error.data && error.data.message) {
                message += error.data.message.replace("execution reverted: ", "");
            } else {
                message += "Please check the console for details.";
            }
            
            alert(message);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-blue-600');
                btn.classList.add('bg-gray-800', 'hover:bg-gray-700');
            });
            document.querySelector(`[onclick="switchTab('<LaTex>${tabName}')"]`).classList.remove('bg-gray-800', 'hover:bg-gray-700');[ty-n]            document.querySelector(`[onclick="switchTab('$</LaTex>{tabName}')"]`).classList.add('bg-gradient-to-r', 'from-green-500', 'to-blue-600');
        }

        // Auto-connect if possible
        (async () => {
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', async (accounts) => {
                    if (accounts.length > 0) {
                        await connectWallet();
                    } else {
                        location.reload();
                    }
                });
            }
        })();
    </script>
</body>
</html>