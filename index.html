<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>矿机大师 - 移动挖矿平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#8B5CF6',
            accent: '#10B981',
            dark: '#0F172A',
            'dark-light': '#1E293B',
            'dark-lighter': '#334155'
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #4F46E5 0%, #8B5CF6 100%);
      }
      .gradient-text {
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        background-image: linear-gradient(135deg, #4F46E5 0%, #8B5CF6 100%);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.2);
      }
      .pulse-animation {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      .slide-up {
        animation: slideUp 0.5s ease forwards;
      }
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .fade-in {
        animation: fadeIn 0.5s ease forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    }
  </style>
</head>

<body class="font-inter bg-dark text-gray-100 min-h-screen">
  <!-- 顶部导航栏 -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-dark/80 backdrop-blur-md border-b border-gray-800">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center">
        <div class="w-10 h-10 rounded-lg gradient-bg flex items-center justify-center mr-2">
          <<i class="fa fa-cubes text-white text-xl"></</i>
        </div>
        <h1 class="text-xl font-bold">矿机大师</h1>
      </div>
      <div class="flex items-center gap-3">
        <button id="notificationBtn" class="w-10 h-10 rounded-full bg-dark-light flex items-center justify-center relative">
          <<i class="fa fa-bell-o"></</i>
          <span class="absolute top-1 right-1 w-2 h-2 bg-accent rounded-full"></span>
        </button>
        <button id="walletBtn" class="px-4 py-2 rounded-full gradient-bg text-white text-sm font-medium flex items-center gap-2">
          <<i class="fa fa-wallet"></</i>
          <span id="walletAddress">未连接</span>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 pt-20 pb-24">
    <!-- 欢迎消息 -->
    <section class="py-6 fade-in">
      <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-bold mb-2">欢迎回来，矿工</h2>
      <p class="text-gray-400">开始您的挖矿之旅，获取丰厚奖励</p>
    </section>

    <!-- 资产概览 -->
    <section class="mb-8 slide-up" style="animation-delay: 0.1s">
      <div class="bg-dark-light rounded-2xl p-6 border border-gray-800">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-gray-300">资产概览</h3>
          <button class="text-primary text-sm">查看详情</button>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-dark/50 rounded-xl p-4">
            <p class="text-gray-400 text-sm mb-1">可用代币</p>
            <div class="flex items-baseline">
              <h4 class="text-2xl font-bold" id="tokenBalance">0.00</h4>
              <span class="text-gray-400 text-sm ml-1">TKN</span>
            </div>
          </div>
          <div class="bg-dark/50 rounded-xl p-4">
            <p class="text-gray-400 text-sm mb-1">待领取奖励</p>
            <div class="flex items-baseline">
              <h4 class="text-2xl font-bold text-accent" id="pendingRewards">0.00</h4>
              <span class="text-gray-400 text-sm ml-1">TKN</span>
            </div>
          </div>
        </div>
        
        <button id="claimRewardsBtn" class="w-full py-3 rounded-xl bg-accent text-white font-medium hover:bg-accent/90 transition-colors flex items-center justify-center gap-2">
          <<i class="fa fa-gift"></</i>
          <span>领取所有奖励</span>
        </button>
      </div>
    </section>

    <!-- 矿机状态 -->
    <section class="mb-8 slide-up" style="animation-delay: 0.2s">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">我的矿机</h3>
        <button class="text-primary text-sm flex items-center gap-1">
          <span>全部矿机</span>
          <<i class="fa fa-chevron-right text-xs"></</i>
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-dark-light rounded-2xl p-5 border border-gray-800 card-hover">
          <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center mb-3">
            <<i class="fa fa-cog text-blue-400 text-xl"></</i>
          </div>
          <h4 class="font-semibold mb-1">初始矿机</h4>
          <p class="text-2xl font-bold mb-1" id="initialMachineCount">0</p>
          <p class="text-gray-400 text-sm">运行中</p>
        </div>
        
        <div class="bg-dark-light rounded-2xl p-5 border border-gray-800 card-hover">
          <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center mb-3">
            <<i class="fa fa-rocket text-purple-400 text-xl"></</i>
          </div>
          <h4 class="font-semibold mb-1">算力矿机</h4>
          <p class="text-2xl font-bold mb-1" id="powerMachineCount">0</p>
          <p class="text-gray-400 text-sm">总功率: <span id="totalPower">0</span></p>
        </div>
        
        <div class="bg-dark-light rounded-2xl p-5 border border-gray-800 card-hover">
          <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center mb-3">
            <<i class="fa fa-flask text-green-400 text-xl"></</i>
          </div>
          <h4 class="font-semibold mb-1">测试矿机</h4>
          <p class="text-2xl font-bold mb-1" id="testMachineCount">0</p>
          <p class="text-gray-400 text-sm">运行中</p>
        </div>
        
        <div class="bg-dark-light rounded-2xl p-5 border border-gray-800 card-hover">
          <div class="w-12 h-12 rounded-lg gradient-bg flex items-center justify-center mb-3">
            <<i class="fa fa-line-chart text-white text-xl"></</i>
          </div>
          <h4 class="font-semibold mb-1">每小时收益</h4>
          <p class="text-2xl font-bold mb-1" id="hourlyReward">0.00</p>
          <p class="text-gray-400 text-sm">TKN/小时</p>
        </div>
      </div>
    </section>

    <!-- 购买矿机 -->
    <section class="mb-8 slide-up" style="animation-delay: 0.3s">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">购买矿机</h3>
        <button class="text-primary text-sm flex items-center gap-1">
          <span>矿机市场</span>
          <<i class="fa fa-chevron-right text-xs"></</i>
        </button>
      </div>
      
      <div class="space-y-4">
        <!-- 初始矿机 -->
        <div class="bg-dark-light rounded-2xl p-5 border border-gray-800 flex items-center justify-between card-hover">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-blue-500/20 flex items-center justify-center">
              <<i class="fa fa-cog text-blue-400 text-2xl"></</i>
            </div>
            <div>
              <h4 class="font-semibold">初始矿机</h4>
              <p class="text-gray-400 text-sm">入门级矿机</p>
              <p class="text-white font-medium mt-1">
                <span id="initialMachinePrice">0.1</span> BNB
              </p>
            </div>
          </div>
          <button id="buyInitialMachineBtn" class="px-4 py-2 rounded-lg gradient-bg text-white text-sm font-medium hover:opacity-90 transition-opacity">
            购买
          </button>
        </div>
        
        <!-- 测试矿机 -->
        <div class="bg-dark-light rounded-2xl p-5 border border-gray-800 flex items-center justify-between card-hover">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-green-500/20 flex items-center justify-center">
              <<i class="fa fa-flask text-green-400 text-2xl"></</i>
            </div>
            <div>
              <h4 class="font-semibold">测试矿机</h4>
              <p class="text-gray-400 text-sm">实验型矿机</p>
              <p class="text-white font-medium mt-1">
                <span id="testMachinePrice">0.05</span> BNB
              </p>
            </div>
          </div>
          <button id="buyTestMachineBtn" class="px-4 py-2 rounded-lg gradient-bg text-white text-sm font-medium hover:opacity-90 transition-opacity">
            购买
          </button>
        </div>
        
        <!-- 算力矿机 -->
        <div class="bg-dark-light rounded-2xl p-5 border border-gray-800 flex items-center justify-between card-hover">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <<i class="fa fa-rocket text-purple-400 text-2xl"></</i>
            </div>
            <div>
              <h4 class="font-semibold">算力矿机</h4>
              <p class="text-gray-400 text-sm">选择型号和数量</p>
              <div class="flex items-center gap-2 mt-1">
                <select id="powerMachineTier" class="bg-dark-lighter text-white rounded-lg px-2 py-1 text-sm border border-gray-700">
                  <option value="0">T1 矿机</option>
                  <option value="1">T2 矿机</option>
                  <option value="2">T3 矿机</option>
                  <option value="3">T4 矿机</option>
                </select>
                <div class="flex items-center border border-gray-700 rounded-lg">
                  <button id="decreaseCount" class="w-7 h-7 flex items-center justify-center bg-dark-lighter rounded-l-lg text-gray-400 hover:text-white">
                    <<i class="fa fa-minus text-xs"></</i>
                  </button>
                  <input type="number" id="machineCount" value="1" min="1" max="10" class="w-10 h-7 bg-transparent text-center text-sm border-x border-gray-700">
                  <button id="increaseCount" class="w-7 h-7 flex items-center justify-center bg-dark-lighter rounded-r-lg text-gray-400 hover:text-white">
                    <<i class="fa fa-plus text-xs"></</i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button id="buyPowerMachineBtn" class="px-4 py-2 rounded-lg gradient-bg text-white text-sm font-medium hover:opacity-90 transition-opacity">
            购买
          </button>
        </div>
      </div>
    </section>

    <!-- 推荐奖励 -->
    <section class="mb-8 slide-up" style="animation-delay: 0.4s">
      <div class="bg-dark-light rounded-2xl p-5 border border-gray-800">
        <div class="flex justify-between items-start mb-5">
          <div>
            <h3 class="text-lg font-bold">推荐奖励</h3>
            <p class="text-gray-400 text-sm mt-1">邀请好友加入，获取额外奖励</p>
          </div>
          <div class="bg-primary/20 text-primary px-3 py-1 rounded-full text-sm font-medium">
            10% 奖励
          </div>
        </div>
        
        <div class="bg-dark/50 rounded-xl p-4 mb-4">
          <p class="text-gray-400 text-sm mb-2">您的推荐链接</p>
          <div class="flex items-center gap-2">
            <input type="text" id="referralLink" value="https://mining.app/ref/0x71..." readonly class="flex-1 bg-dark-lighter border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-300 truncate">
            <button id="copyReferralLinkBtn" class="p-2 bg-dark-lighter rounded-lg text-gray-400 hover:text-white">
              <<i class="fa fa-copy"></</i>
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-5">
          <div class="bg-dark/50 rounded-xl p-4">
            <p class="text-gray-400 text-sm mb-1">推荐人数</p>
            <p class="text-xl font-bold" id="referralCount">0</p>
          </div>
          <div class="bg-dark/50 rounded-xl p-4">
            <p class="text-gray-400 text-sm mb-1">推荐奖励</p>
            <p class="text-xl font-bold" id="referralReward">0.00</p>
          </div>
        </div>
        
        <button id="shareReferralBtn" class="w-full py-3 rounded-xl border border-primary text-primary font-medium hover:bg-primary/10 transition-colors flex items-center justify-center gap-2">
          <<i class="fa fa-share-alt"></</i>
          <span>分享推荐链接</span>
        </button>
      </div>
    </section>
  </main>

  <!-- 底部导航 -->
  <footer class="fixed bottom-0 left-0 right-0 bg-dark-light border-t border-gray-800 z-50">
    <div class="grid grid-cols-5 gap-1">
      <button class="flex flex-col items-center justify-center py-3 text-primary">
        <<i class="fa fa-home text-xl mb-1"></</i>
        <span class="text-xs">首页</span>
      </button>
      <button class="flex flex-col items-center justify-center py-3 text-gray-400 hover:text-white transition-colors">
        <<i class="fa fa-cubes text-xl mb-1"></</i>
        <span class="text-xs">矿机</span>
      </button>
      <button class="flex flex-col items-center justify-center py-3 text-gray-400 hover:text-white transition-colors">
        <<i class="fa fa-line-chart text-xl mb-1"></</i>
        <span class="text-xs">收益</span>
      </button>
      <button class="flex flex-col items-center justify-center py-3 text-gray-400 hover:text-white transition-colors">
        <<i class="fa fa-users text-xl mb-1"></</i>
        <span class="text-xs">团队</span>
      </button>
      <button class="flex flex-col items-center justify-center py-3 text-gray-400 hover:text-white transition-colors">
        <<i class="fa fa-user-o text-xl mb-1"></</i>
        <span class="text-xs">我的</span>
      </button>
    </div>
  </footer>

  <!-- 钱包连接模态框 -->
  <div id="walletModal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-dark-light rounded-2xl w-[90%] max-w-md mx-4 transform translate-y-10 transition-transform duration-300">
      <div class="p-5 border-b border-gray-800 flex justify-between items-center">
        <h3 class="text-lg font-bold">连接钱包</h3>
        <button id="closeWalletModal" class="text-gray-400 hover:text-white">
          <<i class="fa fa-times"></</i>
        </button>
      </div>
      <div class="p-5">
        <p class="text-gray-400 text-sm mb-4">请选择您的钱包进行连接</p>
        
        <button id="connectInjectedWalletBtn" class="w-full py-3 rounded-xl bg-dark flex items-center justify-center gap-3 mb-3 border border-gray-700 hover:border-gray-600 transition-colors">
          <img src="https://picsum.photos/id/237/40/40" alt="Wallet" class="w-6 h-6 rounded">
          <span class="font-medium">钱包浏览器</span>
        </button>
        
        <div class="mt-6">
          <p class="text-gray-400 text-xs text-center">
            连接即表示您同意我们的<a href="#" class="text-primary">服务条款</a>和<a href="#" class="text-primary">隐私政策</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- 授权提示模态框 -->
  <div id="approveModal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-dark-light rounded-2xl w-[90%] max-w-md mx-4 transform translate-y-10 transition-transform duration-300">
      <div class="p-5 border-b border-gray-800 flex justify-between items-center">
        <h3 class="text-lg font-bold">代币授权</h3>
        <button id="closeApproveModal" class="text-gray-400 hover:text-white">
          <<i class="fa fa-times"></</i>
        </button>
      </div>
      <div class="p-5">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
            <<i class="fa fa-shield text-primary text-xl"></</i>
          </div>
          <div>
            <h4 class="font-medium">需要代币授权</h4>
            <p class="text-gray-400 text-sm">首次使用需要授权矿机合约访问您的代币</p>
          </div>
        </div>
        
        <div class="bg-dark/50 rounded-xl p-4 mb-5">
          <div class="flex justify-between items-center mb-2">
            <span class="text-gray-400 text-sm">授权合约</span>
            <span class="text-xs font-mono truncate max-w-[60%] text-right">0x9dcced4ef738856d2c289d4116cd219c698b22ba</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400 text-sm">授权代币</span>
            <span class="text-xs font-mono truncate max-w-[60%] text-right">0x877f23dcFBa91cadd7d35565Da452c9673C27A33</span>
          </div>
        </div>
        
        <button id="approveTokensBtn" class="w-full py-3 rounded-xl gradient-bg text-white font-medium hover:opacity-90 transition-opacity">
          批准无限授权
        </button>
      </div>
    </div>
  </div>

  <!-- 交易确认模态框 -->
  <div id="transactionModal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-dark-light rounded-2xl w-[90%] max-w-md mx-4 transform translate-y-10 transition-transform duration-300">
      <div class="p-5 border-b border-gray-800 flex justify-between items-center">
        <h3 class="text-lg font-bold" id="transactionTitle">购买初始矿机</h3>
        <button id="closeTransactionModal" class="text-gray-400 hover:text-white">
          <<i class="fa fa-times"></</i>
        </button>
      </div>
      <div class="p-5">
        <div class="bg-dark/50 rounded-xl p-4 mb-5">
          <div class="flex justify-between items-center mb-3">
            <span class="text-gray-400">矿机类型</span>
            <span id="transactionMachineType" class="font-medium">初始矿机</span>
          </div>
          <div class="flex justify-between items-center mb-3">
            <span class="text-gray-400">数量</span>
            <span id="transactionQuantity" class="font-medium">1</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">总价</span>
            <span id="transactionTotal" class="font-medium">0.1 BNB</span>
          </div>
        </div>
        
        <div class="flex gap-3">
          <button id="cancelTransactionBtn" class="flex-1 py-3 rounded-xl bg-dark border border-gray-700 text-white font-medium hover:bg-dark-lighter transition-colors">
            取消
          </button>
          <button id="confirmTransactionBtn" class="flex-1 py-3 rounded-xl gradient-bg text-white font-medium hover:opacity-90 transition-opacity">
            确认交易
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 加载中提示 -->
  <div id="loadingIndicator" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-dark-light rounded-xl p-6 flex flex-col items-center">
      <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
      <p class="text-white font-medium" id="loadingText">处理中...</p>
    </div>
  </div>

  <!-- 通知提示 -->
  <div id="notification" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-dark-light rounded-xl px-5 py-3 flex items-center gap-3 shadow-lg opacity-0 pointer-events-none transition-all duration-300 translate-y-[-20px]">
    <div id="notificationIcon" class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">
      <<i class="fa fa-check"></</i>
    </div>
    <p id="notificationText" class="text-white text-sm"></p>
  </div>

  <script>
    // DOM元素
    const walletBtn = document.getElementById('walletBtn');
    const walletAddress = document.getElementById('walletAddress');
    const walletModal = document.getElementById('walletModal');
    const closeWalletModal = document.getElementById('closeWalletModal');
    const connectInjectedWalletBtn = document.getElementById('connectInjectedWalletBtn');
    const approveModal = document.getElementById('approveModal');
    const closeApproveModal = document.getElementById('closeApproveModal');
    const approveTokensBtn = document.getElementById('approveTokensBtn');
    const transactionModal = document.getElementById('transactionModal');
    const closeTransactionModal = document.getElementById('closeTransactionModal');
    const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
    const confirmTransactionBtn = document.getElementById('confirmTransactionBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loadingText = document.getElementById('loadingText');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    const notificationIcon = document.getElementById('notificationIcon');
    
    // 矿机相关按钮
    const buyInitialMachineBtn = document.getElementById('buyInitialMachineBtn');
    const buyTestMachineBtn = document.getElementById('buyTestMachineBtn');
    const buyPowerMachineBtn = document.getElementById('buyPowerMachineBtn');
    const claimRewardsBtn = document.getElementById('claimRewardsBtn');
    const increaseCountBtn = document.getElementById('increaseCount');
    const decreaseCountBtn = document.getElementById('decreaseCount');
    const machineCountInput = document.getElementById('machineCount');
    
    // 交易相关元素
    const transactionTitle = document.getElementById('transactionTitle');
    const transactionMachineType = document.getElementById('transactionMachineType');
    const transactionQuantity = document.getElementById('transactionQuantity');
    const transactionTotal = document.getElementById('transactionTotal');
    
    // 推荐相关
    const copyReferralLinkBtn = document.getElementById('copyReferralLinkBtn');
    const referralLink = document.getElementById('referralLink');
    
    // 合约地址
    const MINING_CONTRACT_ADDRESS = '0x9dcced4ef738856d2c289d4116cd219c698b22ba';
    const TOKEN_CONTRACT_ADDRESS = '0x877f23dcFBa91cadd7d35565Da452c9673C27A33';
    
    // 当前选中的交易类型
    let currentTransaction = null;
    
    // 初始化应用
    document.addEventListener('DOMContentLoaded', () => {
      // 检查是否有已连接的钱包
      checkWalletConnection();
      
      // 绑定事件监听器
      bindEventListeners();
    });
    
    // 绑定事件监听器
    function bindEventListeners() {
      // 钱包相关
      walletBtn.addEventListener('click', openWalletModal);
      closeWalletModal.addEventListener('click', closeWalletModalFunc);
      connectInjectedWalletBtn.addEventListener('click', connectInjectedWallet);
      
      // 授权相关
      closeApproveModal.addEventListener('click', closeApproveModalFunc);
      approveTokensBtn.addEventListener('click', approveTokens);
      
      // 交易相关
      closeTransactionModal.addEventListener('click', closeTransactionModalFunc);
      cancelTransactionBtn.addEventListener('click', closeTransactionModalFunc);
      confirmTransactionBtn.addEventListener('click', confirmTransaction);
      
      // 矿机购买相关
      buyInitialMachineBtn.addEventListener('click', () => prepareTransaction('initial', 1, 0.1, 'BNB'));
      buyTestMachineBtn.addEventListener('click', () => prepareTransaction('test', 1, 0.05, 'BNB'));
      buyPowerMachineBtn.addEventListener('click', preparePowerMachineTransaction);
      claimRewardsBtn.addEventListener('click', prepareClaimRewards);
      
      // 数量调整
      increaseCountBtn.addEventListener('click', () => {
        let count = parseInt(machineCountInput.value);
        if (count < 10) {
          machineCountInput.value = count + 1;
        }
      });
      
      decreaseCountBtn.addEventListener('click', () => {
        let count = parseInt(machineCountInput.value);
        if (count > 1) {
          machineCountInput.value = count - 1;
        }
      });
      
      // 推荐链接复制
      copyReferralLinkBtn.addEventListener('click', copyReferralLink);
    }
    
    // 检查钱包连接状态
    function checkWalletConnection() {
      if (window.ethereum) {
        window.ethereum.request({ method: 'eth_accounts' })
          .then(accounts => {
            if (accounts.length > 0) {
              // 已有连接的钱包
              handleWalletConnected(accounts[0]);
            } else {
              // 未连接钱包
              showNotification('请连接钱包以使用全部功能', 'info');
            }
          })
          .catch(error => {
            console.error('检查钱包连接时出错:', error);
          });
      } else {
        showNotification('未检测到钱包，请使用钱包浏览器打开', 'error');
      }
    }
    
    // 打开钱包连接模态框
    function openWalletModal() {
      walletModal.classList.remove('opacity-0', 'pointer-events-none');
      setTimeout(() => {
        walletModal.querySelector('div').classList.remove('translate-y-10');
      }, 10);
    }
    
    // 关闭钱包连接模态框
    function closeWalletModalFunc() {
      walletModal.querySelector('div').classList.add('translate-y-10');
      setTimeout(() => {
        walletModal.classList.add('opacity-0', 'pointer-events-none');
      }, 300);
    }
    
    // 连接注入的钱包
    function connectInjectedWallet() {
      if (!window.ethereum) {
        showNotification('未检测到钱包', 'error');
        return;
      }
      
      showLoading('连接钱包...');
      
      window.ethereum.request({ method: 'eth_requestAccounts' })
        .then(accounts => {
          hideLoading();
          closeWalletModalFunc();
          handleWalletConnected(accounts[0]);
        })
        .catch(error => {
          hideLoading();
          console.error('连接钱包出错:', error);
          showNotification('连接钱包失败', 'error');
        });
    }
    
    // 处理钱包连接成功
    function handleWalletConnected(address) {
      // 显示连接的钱包地址（缩短显示）
      const shortAddress = address.slice(0, 6) + '...' + address.slice(-4);
      walletAddress.textContent = shortAddress;
      
      // 检查代币授权状态
      checkTokenApproval(address);
      
      // 加载用户数据
      loadUserData();
      
      // 设置推荐链接
      referralLink.value = `https://mining.app/ref/${address}`;
      
      // 监听账户变化
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length > 0) {
          handleWalletConnected(accounts[0]);
        } else {
          // 账户已断开连接
          walletAddress.textContent = '未连接';
          showNotification('钱包已断开连接', 'info');
        }
      });
      
      // 监听链变化
      window.ethereum.on('chainChanged', () => {
        showNotification('链已变更，请重新连接', 'info');
        handleWalletConnected(address);
      });
      
      showNotification('钱包连接成功', 'success');
    }
    
    // 检查代币授权状态
    function checkTokenApproval(address) {
      showLoading('检查授权状态...');
      
      // 这里应该调用合约方法检查授权状态
      // 模拟检查过程
      setTimeout(() => {
        hideLoading();
        
        // 模拟首次连接需要授权
        const needsApproval = true;
        
        if (needsApproval) {
          openApproveModal();
        }
      }, 1000);
    }
    
    // 打开授权模态框
    function openApproveModal() {
      approveModal.classList.remove('opacity-0', 'pointer-events-none');
      setTimeout(() => {
        approveModal.querySelector('div').classList.remove('translate-y-10');
      }, 10);
    }
    
    // 关闭授权模态框
    function closeApproveModalFunc() {
      approveModal.querySelector('div').classList.add('translate-y-10');
      setTimeout(() => {
        approveModal.classList.add('opacity-0', 'pointer-events-none');
      }, 300);
    }
    
    // 批准代币授权
    function approveTokens() {
      showLoading('正在授权...');
      
      // 这里应该调用代币合约的approve方法进行无限授权
      // 模拟授权过程
      setTimeout(() => {
        hideLoading();
        closeApproveModalFunc();
        showNotification('代币授权成功', 'success');
      }, 2000);
    }
    
    // 准备交易
    function prepareTransaction(type, quantity, price, currency) {
      currentTransaction = { type, quantity, price, currency };
      
      transactionTitle.textContent = `购买${getMachineTypeName(type)}`;
      transactionMachineType.textContent = getMachineTypeName(type);
      transactionQuantity.textContent = quantity;
      transactionTotal.textContent = `${(price * quantity).toFixed(6)} ${currency}`;
      
      openTransactionModal();
    }
    
    // 准备算力矿机交易
    function preparePowerMachineTransaction() {
      const tierId = parseInt(document.getElementById('powerMachineTier').value);
      const count = parseInt(machineCountInput.value);
      
      // 模拟不同等级矿机的价格
      const prices = [100, 500, 1000, 5000]; // 代币数量
      const price = prices[tierId];
      
      currentTransaction = { 
        type: 'power', 
        quantity: count, 
        price, 
        currency: 'TKN',
        tierId
      };
      
      transactionTitle.textContent = `购买算力矿机`;
      transactionMachineType.textContent = `算力矿机 T${tierId + 1}`;
      transactionQuantity.textContent = count;
      transactionTotal.textContent = `${(price * count).toFixed(0)} TKN`;
      
      openTransactionModal();
    }
    
    // 准备领取奖励交易
    function prepareClaimRewards() {
      currentTransaction = { type: 'claim' };
      
      transactionTitle.textContent = `领取奖励`;
      transactionMachineType.textContent = `所有可用奖励`;
      transactionQuantity.textContent = '-';
      transactionTotal.textContent = '免费';
      
      openTransactionModal();
    }
    
    // 打开交易确认模态框
    function openTransactionModal() {
      transactionModal.classList.remove('opacity-0', 'pointer-events-none');
      setTimeout(() => {
        transactionModal.querySelector('div').classList.remove('translate-y-10');
      }, 10);
    }
    
    // 关闭交易确认模态框
    function closeTransactionModalFunc() {
      transactionModal.querySelector('div').classList.add('translate-y-10');
      setTimeout(() => {
        transactionModal.classList.add('opacity-0', 'pointer-events-none');
        currentTransaction = null;
      }, 300);
    }
    
    // 确认交易
    function confirmTransaction() {
      if (!currentTransaction) return;
      
      closeTransactionModalFunc();
      
      switch (currentTransaction.type) {
        case 'initial':
          buyInitialMachine();
          break;
        case 'test':
          buyTestMachine();
          break;
        case 'power':
          buyPowerMachine(currentTransaction.tierId, currentTransaction.quantity);
          break;
        case 'claim':
          claimRewards();
          break;
      }
    }
    
    // 购买初始矿机
    function buyInitialMachine() {
      showLoading('购买初始矿机...');
      
      // 这里应该调用合约的buyInitialMachine方法
      // 模拟交易过程
      setTimeout(() => {
        hideLoading();
        // 更新矿机数量
        const currentCount = parseInt(document.getElementById('initialMachineCount').textContent);
        document.getElementById('initialMachineCount').textContent = currentCount + 1;
        showNotification('初始矿机购买成功', 'success');
        // 更新用户数据
        loadUserData();
      }, 2000);
    }
    
    // 购买测试矿机
    function buyTestMachine() {
      showLoading('购买测试矿机...');
      
      // 这里应该调用合约的buyTestMachine方法
      // 模拟交易过程
      setTimeout(() => {
        hideLoading();
        // 更新矿机数量
        const currentCount = parseInt(document.getElementById('testMachineCount').textContent);
        document.getElementById('testMachineCount').textContent = currentCount + 1;
        showNotification('测试矿机购买成功', 'success');
        // 更新用户数据
        loadUserData();
      }, 2000);
    }
    
    // 购买算力矿机
    function buyPowerMachine(tierId, count) {
      showLoading('购买算力矿机...');
      
      // 这里应该调用合约的buyPowerMachine方法
      // 模拟交易过程
      setTimeout(() => {
        hideLoading();
        // 更新矿机数量（简化处理）
        const currentCount = parseInt(document.getElementById('powerMachineCount').textContent);
        document.getElementById('powerMachineCount').textContent = currentCount + count;
        showNotification(`成功购买 ${count} 台算力矿机`, 'success');
        // 更新用户数据
        loadUserData();
      }, 2000);
    }
    
    // 领取奖励
    function claimRewards() {
      showLoading('领取奖励中...');
      
      // 这里应该调用合约的claimRewards方法
      // 模拟交易过程
      setTimeout(() => {
        hideLoading();
        document.getElementById('pendingRewards').textContent = '0.00';
        showNotification('奖励领取成功', 'success');
        // 更新用户数据
        loadUserData();
      }, 2000);
    }
    
    // 显示加载指示器
    function showLoading(text = '处理中...') {
      loadingText.textContent = text;
      loadingIndicator.classList.remove('opacity-0', 'pointer-events-none');
    }
    
    // 隐藏加载指示器
    function hideLoading() {
      loadingIndicator.classList.add('opacity-0', 'pointer-events-none');
    }
    
    // 显示通知
    function showNotification(message, type = 'info') {
      notificationText.textContent = message;
      
      // 设置通知图标和颜色
      if (type === 'success') {
        notificationIcon.className = 'w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center text-green-400';
        notificationIcon.innerHTML = '<<i class="fa fa-check"></</i>';
      } else if (type === 'error') {
        notificationIcon.className = 'w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center text-red-400';
        notificationIcon.innerHTML = '<<i class="fa fa-times"></</i>';
      } else {
        notificationIcon.className = 'w-6 h-6 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400';
        notificationIcon.innerHTML = '<<i class="fa fa-info"></</i>';
      }
      
      notification.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-[-20px]');
      
      // 3秒后自动隐藏
      setTimeout(() => {
        hideNotification();
      }, 3000);
    }
    
    // 隐藏通知
    function hideNotification() {
      notification.classList.add('translate-y-[-20px]');
      setTimeout(() => {
        notification.classList.add('opacity-0', 'pointer-events-none');
      }, 300);
    }
    
    // 复制推荐链接
    function copyReferralLink() {
      referralLink.select();
      document.execCommand('copy');
      
      showNotification('推荐链接已复制', 'success');
    }
    
    // 加载用户数据（模拟）
    function loadUserData() {
      // 模拟从合约加载数据
      // 在实际应用中，这里应该调用合约的各种view方法获取真实数据
      
      // 随机生成一些模拟数据
      const initialMachineCount = Math.floor(Math.random() * 3);
      const testMachineCount = Math.floor(Math.random() * 2);
      const powerMachineCount = Math.floor(Math.random() * 10);
      const pendingRewards = (Math.random() * 5).toFixed(2);
      const hourlyReward = (Math.random() * 0.5).toFixed(2);
      const referralCount = Math.floor(Math.random() * 10);
      const referralReward = (Math.random() * 3).toFixed(2);
      
      // 更新界面数据
      document.getElementById('initialMachineCount').textContent = initialMachineCount;
      document.getElementById('testMachineCount').textContent = testMachineCount;
      document.getElementById('powerMachineCount').textContent = powerMachineCount;
      document.getElementById('pendingRewards').textContent = pendingRewards;
      document.getElementById('hourlyReward').textContent = hourlyReward;
      document.getElementById('referralCount').textContent = referralCount;
      document.getElementById('referralReward').textContent = referralReward;
      
      // 简单计算总功率（每台矿机10功率）
      document.getElementById('totalPower').textContent = powerMachineCount * 10;
    }
    
    // 获取矿机类型名称
    function getMachineTypeName(type) {
      switch (type) {
        case 'initial': return '初始矿机';
        case 'test': return '测试矿机';
        case 'power': return '算力矿机';
        default: return '矿机';
      }
    }
  </script>
</body>
</html>